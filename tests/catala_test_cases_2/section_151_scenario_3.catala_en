> Module Section_151_scenario_3
> Using Sections as IRC

```catala
#[test]
declaration scope Section_151_scenario_3:
  output computation content IRC.IRCSimplified

scope Section_151_scenario_3:
  # Scenario: 2017 MFS; spouse has no gross income; no joint return; spouse is not a dependent of another; one dependent child
  # Tested law refs: §151(a), §151(b), §151(c), §151(d)(1)
  # Assumptions per scenario comments:
  # - Child is a dependent under §152 (modeled via TaxReturnEvent.dependents)
  # - Phaseout under §151(d)(3) not applicable (AGI well below §68(b) threshold)
  definition computation equals
    # Individuals
    let i_t3 equals IRC.Individual { -- id: 1 -- is_counterfactual: false } in
    let i_s3 equals IRC.Individual { -- id: 2 -- is_counterfactual: false } in
    let i_c31 equals IRC.Individual { -- id: 3 -- is_counterfactual: false } in

    # Organization (dummy, for FUTA return required by IRCSimplified)
    let org1 equals IRC.Organization {
      -- id: 1
      -- organization_type: IRC.OrganizationType.Business
      -- is_counterfactual: false
    } in

    # Marriage event
    let marriage1 equals IRC.MarriageEvent {
      -- id: 1
      -- spouse1: i_t3
      -- spouse2: i_s3
      -- marriage_date: Date.of_year_month_day of 2010, 6, 15
      -- is_counterfactual: false
    } in

    # Parenthood (taxpayer is parent of child)
    let parent1 equals IRC.ParenthoodEvent {
      -- id: 1
      -- parent: i_t3
      -- child: i_c31
      -- start_date: Date.of_year_month_day of 2012, 8, 1
      -- parent_type: IRC.ParentType.Biological
      -- is_counterfactual: false
    } in

    # Income events for 2017 (spouse has no gross income; taxpayer has $45,000)
    let inc_spouse equals IRC.IncomeEvent {
      -- id: 1
      -- individual: i_s3
      -- tax_year: 2017
      -- has_income: false
      -- earned_income: $0
      -- is_counterfactual: false
    } in
    let inc_taxpayer equals IRC.IncomeEvent {
      -- id: 2
      -- individual: i_t3
      -- tax_year: 2017
      -- has_income: true
      -- earned_income: $45000
      -- is_counterfactual: false
    } in

    # Tax return filing event for taxpayer (not a joint return); declares child as dependent and qualifying child
    let tre_t3 equals IRC.TaxReturnEvent {
      -- id: 1
      -- individual: i_t3
      -- tax_year: 2017
      -- filed_joint_return: false
      -- is_only_for_refund_claim: false
      -- qualifying_children: [ i_c31 ]
      -- dependents: [ i_c31 ]
      -- is_counterfactual: false
    } in

    # Individual income tax return: Married Filing Separate (MFS)
    let mfs_details equals IRC.MarriedFilingSeparateVariant {
      -- taxpayer: i_t3
      -- spouse: i_s3
      -- itemization_election: false
      -- spouse_itemization_election: false
      -- is_estate_or_trust: false
      -- is_common_trust_fund: false
      -- is_partnership: false
    } in
    let ind_return equals IRC.IndividualTaxReturn {
      -- id: 1
      -- tax_year: 2017
      -- details: IRC.FilingStatusVariant.MarriedFilingSeparate content mfs_details
    } in

    # Employer unemployment excise tax return (dummy for IRCSimplified inputs)
    let futa_details equals IRC.EmployerGeneralVariant { -- employer: org1 } in
    let futa_return equals IRC.EmployerUnemploymentExciseTaxReturn {
      -- id: 1
      -- tax_year: 2017
      -- details: IRC.EmployerVariant.GeneralEmployer content futa_details
    } in

    # Call IRCSimplified to compute §151 outputs (and related)
    output of IRC.IRCSimplified with {
      -- individual_tax_return: ind_return
      -- individuals: [ i_t3 ] ++ [ i_s3 ] ++ [ i_c31 ]
      -- organizations: [ org1 ]
      -- birth_events: []
      -- blindness_status_events: []
      -- death_events: []
      -- nonresident_alien_status_period_events: []
      -- marriage_events: [ marriage1 ]
      -- divorce_or_legal_separation_events: []
      -- residence_period_events: []
      -- household_maintenance_events: []
      -- parenthood_events: [ parent1 ]
      -- family_relationship_events: []
      -- tax_return_events: [ tre_t3 ]
      -- income_events: [ inc_spouse ] ++ [ inc_taxpayer ]
      -- employment_relationship_events: []
      -- wage_payment_events: []
      -- student_enrollment_events: []
      -- hospital_patient_events: []
      -- immigration_admission_events: []
      -- employment_termination_events: []
      -- employer_unemployment_excise_tax_return: futa_return
      -- itemized_deductions: $0
      -- adjusted_gross_income: $45000
    }

  # Assertions correlating to §151

  # §151(d)(1): exemption amount is $2,000 for 2017 (pre-2018)
  assertion (computation.taxpayer_exemption_result.exemption_amount_base = $2000)
  # No disallowance under §151(d)(2) and no phaseout under §151(d)(3)
  assertion (computation.taxpayer_exemption_result.exemption_amount_after_disallowance = $2000)
  assertion (computation.taxpayer_exemption_result.exemption_amount_after_phaseout = $2000)

  # §151(b) first clause (taxpayer exemption) and §151(a): taxpayer included among individuals entitled to §151 exemptions
  assertion (
    let t equals IRC.get_taxpayer of computation.taxable_income_result.individual_tax_return in
    computation.taxpayer_exemptions_list_result.individuals_entitled_to_exemptions_under_151 contains t
  )

  # §151(b): spouse exemption allowed (no joint return, spouse has no gross income, and spouse is not dependent of another taxpayer)
  assertion (computation.taxpayer_exemptions_list_result.spouse_exemption_allowed_151_b = true)

  # §151(c): dependent exemption count (exactly 1 dependent)
  assertion (
    let t equals IRC.get_taxpayer of computation.taxable_income_result.individual_tax_return in
    let sp_opt equals IRC.get_spouse of computation.taxable_income_result.individual_tax_return in
    match sp_opt with pattern
    -- Present content s :
      number of (
        list of ind among computation.taxpayer_exemptions_list_result.individuals_entitled_to_exemptions_under_151
          such that ind != t and ind != s
      ) = 1
    -- Absent :
      false
  )

  # Per-exemption deduction amounts equal $2,000 in 2017 (no phaseout/disallowance)
  # Assert via the computed exemption amount after phaseout
  assertion (computation.taxpayer_exemption_result.exemption_amount_after_phaseout = $2000)

  # §151(a): total personal exemptions deduction equals 3 * $2,000 = $6,000 (taxpayer + spouse + 1 dependent)
  assertion (computation.taxpayer_exemption_result.personal_exemptions_deduction_151_a = $6000)
```