> Module Section_2_scenario_3
> Using Sections as IRC

```catala
#[test]
declaration scope Section_2_scenario_3:
  output result content IRC.IndividualTaxReturnSection2aSurvivingSpouseOutput

scope Section_2_scenario_3:
  # Scenario: Surviving spouse fails because a joint return could not have been made in the death year
  # Tested law refs: §2(a)(1) and §2(a)(2)(B)
  # Assumption: c3 is a dependent for whom the taxpayer is entitled to a deduction under §151 (and is a dependent under §152)

  definition result equals
    let t3 equals IRC.Individual { -- id: 1 -- is_counterfactual: false } in
    let s3 equals IRC.Individual { -- id: 2 -- is_counterfactual: false } in
    let c3 equals IRC.Individual { -- id: 3 -- is_counterfactual: false } in

    let h3 equals IRC.Household { -- id: 1 -- is_counterfactual: false } in

    let marriage1 equals IRC.MarriageEvent {
      -- id: 1
      -- spouse1: t3
      -- spouse2: s3
      -- marriage_date: Date.of_year_month_day of 2017, 3, 15
      -- is_counterfactual: false
    } in

    let death_s3 equals IRC.DeathEvent {
      -- id: 1
      -- decedent: s3
      -- death_date: Date.of_year_month_day of 2024, 9, 20
      -- is_counterfactual: false
    } in

    # Residence and household maintenance during the 2025 tax year
    let res_c3_2025 equals IRC.ResidencePeriodEvent {
      -- id: 1
      -- individual: c3
      -- household: h3
      -- start_date: Date.of_year_month_day of 2025, 1, 1
      -- end_date: Date.of_year_month_day of 2025, 12, 31
      -- is_member_of_household: true
      -- is_principal_place_of_abode: true
      -- is_counterfactual: false
    } in

    let maint_t3_2025 equals IRC.HouseholdMaintenanceEvent {
      -- id: 1
      -- individual: t3
      -- household: h3
      -- start_date: Date.of_year_month_day of 2025, 1, 1
      -- end_date: Date.of_year_month_day of 2025, 12, 31
      -- cost_furnished_percentage: 0.7
      -- is_counterfactual: false
    } in

    let parent_t3_c3 equals IRC.ParenthoodEvent {
      -- id: 1
      -- parent: t3
      -- child: c3
      -- start_date: Date.of_year_month_day of 2011, 5, 1
      -- parent_type: IRC.ParentType.Biological
      -- is_counterfactual: false
    } in

    # Nonresident alien status periods for the death year (2024)
    let nra_s3_q1_2024 equals IRC.NonresidentAlienStatusPeriodEvent {
      -- id: 1
      -- individual: s3
      -- start_date: Date.of_year_month_day of 2024, 1, 1
      -- end_date: Date.of_year_month_day of 2024, 3, 31
      -- residency_status: IRC.ResidencyStatus.NonresidentAlien
      -- is_counterfactual: false
    } in
    let res_s3_q2_to_death_2024 equals IRC.NonresidentAlienStatusPeriodEvent {
      -- id: 2
      -- individual: s3
      -- start_date: Date.of_year_month_day of 2024, 4, 1
      -- end_date: Date.of_year_month_day of 2024, 9, 20
      -- residency_status: IRC.ResidencyStatus.Resident
      -- is_counterfactual: false
    } in
    let res_t3_y2024 equals IRC.NonresidentAlienStatusPeriodEvent {
      -- id: 3
      -- individual: t3
      -- start_date: Date.of_year_month_day of 2024, 1, 1
      -- end_date: Date.of_year_month_day of 2024, 12, 31
      -- residency_status: IRC.ResidencyStatus.Resident
      -- is_counterfactual: false
    } in

    # Individual income tax return for 2025 - Surviving Spouse (claimed)
    let return_details equals IRC.SurvivingSpouseVariant {
      -- taxpayer: t3
      -- deceased_spouse: s3
      -- qualifying_dependent: c3
      -- itemization_election: false
      -- is_estate_or_trust: false
      -- is_common_trust_fund: false
      -- is_partnership: false
    } in
    let individual_tax_return equals IRC.IndividualTaxReturn {
      -- id: 1
      -- tax_year: 2025
      -- details: IRC.FilingStatusVariant.SurvivingSpouse content return_details
    } in

    # Assumed §151/§152 dependency status: c3 is entitled to deduction under §151
    let taxpayer_exemptions_list_result equals
      IRC.TaxpayerExemptionsList151Output {
        -- taxpayer_result:
        IRC.IndividualSection151ExemptionsListOutput {
          -- individual: t3
          -- spouse_exemption_allowed_151_b: false
          -- individuals_entitled_to_exemptions_under_151: [ c3 ]
        }
        -- spouse_result: Absent
        -- individuals_entitled_to_exemptions_under_151: [ c3 ]
        -- spouse_exemption_allowed_151_b: false
      }
    in

    # Compute §2(a) surviving spouse status; provide context booleans per the legal analysis
    (output of IRC.IndividualTaxReturnSection2aSurvivingSpouse with {
      -- individual_tax_return: individual_tax_return
      -- death_events: [ death_s3 ]
      -- nonresident_alien_status_period_events: [ nra_s3_q1_2024; res_s3_q2_to_death_2024; res_t3_y2024 ]
      -- parenthood_events: [ parent_t3_c3 ]
      -- household_maintenance_events: [ maint_t3_2025 ]
      -- residence_period_events: [ res_c3_2025 ]
      -- marriage_events: [ marriage1 ]
      -- taxpayer_exemptions_list_result: taxpayer_exemptions_list_result

      # Context overrides mapped to law:
      # §2(a)(1)(A): spouse died within two years before 2025 (death in 2024)
      -- spouse_died_within_two_years_2_a_1_A: true
      # §2(a)(1)(B): maintains household and dependent's principal abode for §151 dependent
      -- maintains_household_qualifying_dependent_principal_abode_section151_2_a_1_B: true
      # §2(a)(2)(A): no remarriage during 2025
      -- has_remarried_2_a_2_A: false
      # §2(a)(2)(B): joint return could not have been made in the death year (spouse was NRA in 2024)
      -- joint_return_could_have_been_made_2_a_2_B: false
      # Final §2(a) status: not a surviving spouse because of limitation §2(a)(2)(B)
      -- is_surviving_spouse_2_a: false
    }).main_output

  # Assertions - ONLY reference the computed output of §2(a) scope
  # Tests §2(a)(2)(B): joint return could not have been made in death year due to nonresident alien status
  assertion (result.joint_return_could_have_been_made_2_a_2_B = false)

  # Tests §2(a): taxpayer is not a surviving spouse after applying the limitation in §2(a)(2)(B)
  assertion (result.is_surviving_spouse_2_a = false)
```