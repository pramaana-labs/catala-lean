> Module Sections
<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: Individual
action: add
law_ref: section_63
structure_type: Entity
```
```catala-metadata
declaration structure Individual:
  data id content integer
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: BirthEvent
action: add
law_ref: section_63
structure_type: Event
```
```catala-metadata
declaration structure BirthEvent:
  data id content integer
  data individual content Individual
  data birth_date content date
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: BlindnessStatusEvent
action: add
law_ref: section_63
structure_type: Event
```
```catala-metadata
declaration structure BlindnessStatusEvent:
  data id content integer
  data individual content Individual
  data status_date content date
  data is_blind content boolean
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: DeathEvent
action: add
law_ref: section_63
structure_type: Event
```
```catala-metadata
declaration structure DeathEvent:
  data id content integer
  data decedent content Individual
  data death_date content date
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: enumeration
name: FilingStatus
action: add
law_ref: section_63
```
```catala-metadata
declaration enumeration FilingStatus:
  -- JointReturn
  -- SurvivingSpouse
  -- HeadOfHousehold
  -- Single
  -- MarriedFilingSeparately
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: enumeration
name: ResidencyStatus
action: add
law_ref: section_63
```
```catala-metadata
declaration enumeration ResidencyStatus:
  -- Resident
  -- NonresidentAlien
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: NonresidentAlienStatusPeriodEvent
action: add
law_ref: section_63
structure_type: Event
```
```catala-metadata
declaration structure NonresidentAlienStatusPeriodEvent:
  data id content integer
  data individual content Individual
  data start_date content date
  data end_date content date
  data residency_status content ResidencyStatus
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: enumeration
name: FilingStatusVariant
action: add
law_ref: section_63
```
```catala-metadata
declaration enumeration FilingStatusVariant:
  -- JointReturn content JointReturnVariant
  -- SurvivingSpouse content SurvivingSpouseVariant
  -- HeadOfHousehold content HeadOfHouseholdVariant
  -- Single content SingleVariant
  -- MarriedFilingSeparate content MarriedFilingSeparateVariant
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: JointReturnVariant
action: add
law_ref: section_63
structure_type: TaxLawHelperStructure
```
```catala-metadata
declaration structure JointReturnVariant:
  data taxpayer content Individual
  data spouse content Individual
  data itemization_election content boolean
  data is_estate_or_trust content boolean
  data is_common_trust_fund content boolean
  data is_partnership content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: SurvivingSpouseVariant
action: add
law_ref: section_63
structure_type: TaxLawHelperStructure
```
```catala-metadata
declaration structure SurvivingSpouseVariant:
  data taxpayer content Individual
  data deceased_spouse content Individual
  data qualifying_dependent content Individual
  data itemization_election content boolean
  data is_estate_or_trust content boolean
  data is_common_trust_fund content boolean
  data is_partnership content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: HeadOfHouseholdVariant
action: add
law_ref: section_63
structure_type: TaxLawHelperStructure
```
```catala-metadata
declaration structure HeadOfHouseholdVariant:
  data taxpayer content Individual
  data qualifying_person content Individual
  data itemization_election content boolean
  data is_estate_or_trust content boolean
  data is_common_trust_fund content boolean
  data is_partnership content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: SingleVariant
action: add
law_ref: section_63
structure_type: TaxLawHelperStructure
```
```catala-metadata
declaration structure SingleVariant:
  data taxpayer content Individual
  data itemization_election content boolean
  data is_estate_or_trust content boolean
  data is_common_trust_fund content boolean
  data is_partnership content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: MarriedFilingSeparateVariant
action: add
law_ref: section_63
structure_type: TaxLawHelperStructure
```
```catala-metadata
declaration structure MarriedFilingSeparateVariant:
  data taxpayer content Individual
  data spouse content Individual
  data itemization_election content boolean
  data spouse_itemization_election content boolean
  data is_estate_or_trust content boolean
  data is_common_trust_fund content boolean
  data is_partnership content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: IndividualTaxReturn
action: add
law_ref: section_63
structure_type: TaxReturn
```
```catala-metadata
declaration structure IndividualTaxReturn:
  data id content integer
  data tax_year content integer
  data details content FilingStatusVariant
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: Household
action: add
law_ref: section_2
structure_type: Entity
```
```catala-metadata
declaration structure Household:
  data id content integer
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: enumeration
name: DecreeType
action: add
law_ref: section_2
```
```catala-metadata
declaration enumeration DecreeType:
  -- Divorce
  -- SeparateMaintenance
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: enumeration
name: ParentType
action: add
law_ref: section_2
```
```catala-metadata
declaration enumeration ParentType:
  -- Biological
  -- Step
  -- Adoptive
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: MarriageEvent
action: add
law_ref: section_2
structure_type: Event
```
```catala-metadata
declaration structure MarriageEvent:
  data id content integer
  data spouse1 content Individual
  data spouse2 content Individual
  data marriage_date content date
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: RemarriageEvent
action: add
law_ref: section_2
structure_type: Event
```
```catala-metadata
declaration structure RemarriageEvent:
  data id content integer
  data individual content Individual
  data remarriage_date content date
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: DivorceOrLegalSeparationEvent
action: add
law_ref: section_2
structure_type: Event
```
```catala-metadata
declaration structure DivorceOrLegalSeparationEvent:
  data id content integer
  data person1 content Individual
  data person2 content Individual
  data decree_date content date
  data decree_type content DecreeType
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: ResidencePeriodEvent
action: add
law_ref: section_2
structure_type: Event
```
```catala-metadata
declaration structure ResidencePeriodEvent:
  data id content integer
  data individual content Individual
  data household content Household
  data start_date content date
  data end_date content date
  data is_member_of_household content boolean
  data is_principal_place_of_abode content boolean
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: HouseholdMaintenanceEvent
action: add
law_ref: section_2
structure_type: Event
```
```catala-metadata
declaration structure HouseholdMaintenanceEvent:
  data id content integer
  data individual content Individual
  data household content Household
  data start_date content date
  data end_date content date
  data cost_furnished_percentage content decimal
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: ParenthoodEvent
action: add
law_ref: section_2
structure_type: Event
```
```catala-metadata
declaration structure ParenthoodEvent:
  data id content integer
  data parent content Individual
  data child content Individual
  data start_date content date
  data parent_type content ParentType
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: enumeration
name: FamilyRelationshipType
action: add
law_ref: section_152
```
```catala-metadata
declaration enumeration FamilyRelationshipType:
  -- Child
  -- DescendantOfChild
  -- Brother
  -- Sister
  -- Stepbrother
  -- Stepsister
  -- DescendantOfSibling
  -- Father
  -- Mother
  -- AncestorOfFatherOrMother
  -- Stepfather
  -- Stepmother
  -- NieceOrNephew
  -- UncleOrAunt
  -- SonInLaw
  -- DaughterInLaw
  -- FatherInLaw
  -- MotherInLaw
  -- BrotherInLaw
  -- SisterInLaw
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: FamilyRelationshipEvent
action: add
law_ref: section_152
structure_type: Event
```
```catala-metadata
declaration structure FamilyRelationshipEvent:
  data id content integer
  data person content Individual
  data relative content Individual
  data start_date content date
  data relationship_type content FamilyRelationshipType
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: IncomeEvent
action: add
law_ref: section_152
structure_type: Event
```
```catala-metadata
declaration structure IncomeEvent:
  data id content integer
  data individual content Individual
  data tax_year content integer
  data has_income content boolean
  data earned_income content money
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: TaxReturnEvent
action: add
law_ref: section_152
structure_type: Event
```
```catala-metadata
declaration structure TaxReturnEvent:
  data id content integer
  data individual content Individual
  data tax_year content integer
  data filed_joint_return content boolean
  data is_only_for_refund_claim content boolean
  data qualifying_children content list of Individual
  data dependents content list of Individual
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: IndividualSection151ExemptionsListOutput
action: add
law_ref: section_151
structure_type: MainOutput
```
```catala-metadata
declaration structure IndividualSection151ExemptionsListOutput:
  data individual content Individual
  data spouse_personal_exemption_allowed content boolean
  data individuals_entitled_to_exemptions_under_151 content list of Individual
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: TaxpayerExemptionsListOutput
action: add
law_ref: section_151
structure_type: MainOutput
```
```catala-metadata
declaration structure TaxpayerExemptionsListOutput:
  data taxpayer_result content IndividualSection151ExemptionsListOutput
  data spouse_result content optional of IndividualSection151ExemptionsListOutput
  data individuals_entitled_to_exemptions_under_151 content list of Individual
  data spouse_personal_exemption_allowed content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: scope
name: IndividualSection151ExemptionsList
action: add
law_ref: section_151
scope_owner_type: Entity
scope_owner_name: Individual
```
```catala-metadata
declaration scope IndividualSection151ExemptionsList:
  input individual content Individual
  input spouse content optional of Individual
  input tax_year content integer
  input tax_return_events content list of TaxReturnEvent
  input income_events content list of IncomeEvent
  input dependents content list of Individual
  input is_joint_or_surviving_spouse content boolean

  context spouse_personal_exemption_allowed content boolean
  context individuals_entitled_to_exemptions_under_151 content list of Individual

  output main_output content IndividualSection151ExemptionsListOutput
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: scope
name: TaxpayerExemptionsList
action: add
law_ref: section_151
scope_owner_type: Entity
scope_owner_name: Taxpayer
```
```catala-metadata
declaration scope TaxpayerExemptionsList:
  input individual_tax_return content IndividualTaxReturn
  input tax_return_events content list of TaxReturnEvent
  input income_events content list of IncomeEvent
  input dependents content list of Individual

  taxpayer_exemptions scope IndividualSection151ExemptionsList

  context spouse_result content optional of IndividualSection151ExemptionsListOutput
  context individuals_entitled_to_exemptions_under_151 content list of Individual
  context spouse_personal_exemption_allowed content boolean

  output main_output content TaxpayerExemptionsListOutput
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: IndividualSection151ExemptionOutput
action: add
law_ref: section_151
structure_type: MainOutput
```
```catala-metadata
declaration structure IndividualSection151ExemptionOutput:
  data individual content Individual
  data exemption_amount_base content money
  data exemption_amount_after_disallowance content money
  data exemption_amount_after_phaseout content money
  data number_of_personal_exemptions content integer
  data personal_exemptions_deduction content money
  data applicable_percentage content decimal
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: scope
name: IndividualSection151Exemption
action: add
law_ref: section_151
scope_owner_type: Entity
scope_owner_name: Individual
```
```catala-metadata
declaration scope IndividualSection151Exemption:
  input individual content Individual
  input individual_tax_return content IndividualTaxReturn
  input tax_year content integer
  input tax_return_events content list of TaxReturnEvent
  input adjusted_gross_income content money
  input applicable_amount content money
  input individuals_entitled_to_exemptions_under_151 content list of Individual

  context exemption_amount content money
    state base
    state after_disallowance
    state after_phaseout
  context number_of_personal_exemptions content integer
  context personal_exemptions_deduction content money
  context applicable_percentage content decimal

  output main_output content IndividualSection151ExemptionOutput
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: IndividualSection152DependentsOutput
action: add
law_ref: section_152
structure_type: MainOutput
```
```catala-metadata
declaration structure IndividualSection152DependentsOutput:
  data taxpayer content Individual
  data dependents_initial content list of Individual
  data dependents_after_152b1 content list of Individual
  data dependents_after_152b2 content list of Individual
  data qualifying_children content list of IndividualSection152QualifyingChildOutput
  data qualifying_relatives content list of IndividualSection152QualifyingRelativeOutput
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: scope
name: IndividualSection152Dependents
action: add
law_ref: section_152
scope_owner_type: Entity
scope_owner_name: Individual
```
```catala-metadata
declaration scope IndividualSection152Dependents:
  input taxpayer content Individual
  input tax_year content integer
  input individuals content list of Individual
  input family_relationship_events content list of FamilyRelationshipEvent
  input birth_events content list of BirthEvent
  input residence_period_events content list of ResidencePeriodEvent
  input tax_return_events content list of TaxReturnEvent
  input income_events content list of IncomeEvent
  input marriage_events content list of MarriageEvent

  context qualifying_children content list of IndividualSection152QualifyingChildOutput
  context qualifying_relatives content list of IndividualSection152QualifyingRelativeOutput
  context dependents content list of Individual
    state initial
    state after_152b1
    state after_152b2

  output main_output content IndividualSection152DependentsOutput
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: IndividualSection152QualifyingChildOutput
action: add
law_ref: section_152
structure_type: MainOutput
```
```catala-metadata
declaration structure IndividualSection152QualifyingChildOutput:
  data individual content Individual
  data taxpayer content Individual
  data is_qualifying_child content boolean
  data relationship_requirement_met content boolean
  data principal_place_of_abode_requirement_met content boolean
  data age_requirement_met content boolean
  data joint_return_exception_applies content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: scope
name: IndividualSection152QualifyingChild
action: add
law_ref: section_152
scope_owner_type: Entity
scope_owner_name: Individual
```
```catala-metadata
declaration scope IndividualSection152QualifyingChild:
  input individual content Individual
  input taxpayer content Individual
  input tax_year content integer
  input family_relationship_events content list of FamilyRelationshipEvent
  input birth_events content list of BirthEvent
  input residence_period_events content list of ResidencePeriodEvent
  input tax_return_events content list of TaxReturnEvent

  context relationship_requirement_met content boolean
  context principal_place_of_abode_requirement_met content boolean
  context age_requirement_met content boolean
  context joint_return_exception_applies content boolean
  context is_qualifying_child content boolean

  output main_output content IndividualSection152QualifyingChildOutput
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: IndividualSection152QualifyingRelativeOutput
action: add
law_ref: section_152
structure_type: MainOutput
```
```catala-metadata
declaration structure IndividualSection152QualifyingRelativeOutput:
  data individual content Individual
  data taxpayer content Individual
  data is_qualifying_relative content boolean
  data relationship_requirement_met_H content boolean
  data relationship_requirement_met content boolean
  data no_income_requirement_met content boolean
  data not_qualifying_child_requirement_met content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: scope
name: IndividualSection152QualifyingRelative
action: add
law_ref: section_152
scope_owner_type: Entity
scope_owner_name: Individual
```
```catala-metadata
declaration scope IndividualSection152QualifyingRelative:
  input individual content Individual
  input taxpayer content Individual
  input tax_year content integer
  input family_relationship_events content list of FamilyRelationshipEvent
  input residence_period_events content list of ResidencePeriodEvent
  input qualifying_child_results content list of IndividualSection152QualifyingChildOutput
  input tax_return_events content list of TaxReturnEvent
  input income_events content list of IncomeEvent
  input marriage_events content list of MarriageEvent

  context relationship_requirement_met_H content boolean
  context relationship_requirement_met content boolean
  context no_income_requirement_met content boolean
  context not_qualifying_child_requirement_met content boolean
  context is_qualifying_relative content boolean

  output main_output content IndividualSection152QualifyingRelativeOutput
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: IndividualSection7703MaritalStatusOutput
action: add
law_ref: section_7703
structure_type: MainOutput
```
```catala-metadata
declaration structure IndividualSection7703MaritalStatusOutput:
  data individual content Individual
  data tax_year content integer
  data determination_date content date
  data is_married_at_determination_date content boolean
  data is_legally_separated content boolean
  data households_with_qualifying_child content list of Household
  data households_maintained_by_individual content list of Household
  data spouse_not_member_of_household_last_6_months content boolean
  data subsection_b_exception_applies content boolean
  data is_married_for_tax_purposes content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: scope
name: IndividualSection7703MaritalStatus
action: add
law_ref: section_7703
scope_owner_type: Entity
scope_owner_name: Individual
```
```catala-metadata
declaration scope IndividualSection7703MaritalStatus:
  input individual content Individual
  input tax_year content integer
  input marriage_events content list of MarriageEvent
  input divorce_or_legal_separation_events content list of DivorceOrLegalSeparationEvent
  input death_events content list of DeathEvent
  input individual_tax_return content IndividualTaxReturn
  input residence_period_events content list of ResidencePeriodEvent
  input household_maintenance_events content list of HouseholdMaintenanceEvent
  input qualifying_children content list of IndividualSection152QualifyingChildOutput
  input individuals_entitled_to_exemptions_under_151 content list of Individual

  # Helper functions (not directly in law text)
  internal section_7703_find_spouse_from_marriage_events
    content optional of Individual depends on individual_arg content Individual,
      marriage_events_arg content list of MarriageEvent,
      year_end_arg content date
  internal section_7703_get_spouse_death_date_during_year
    content optional of date depends on spouse_arg content optional of Individual,
      death_events_arg content list of DeathEvent,
      tax_year_arg content integer
  internal section_7703_spouse_died_before_date
    content boolean depends on spouse_arg content optional of Individual,
      death_events_arg content list of DeathEvent,
      before_date_arg content date
  internal section_7703_get_spouse_from_tax_return
    content optional of Individual depends on individual_arg content Individual,
      individual_tax_return_arg content IndividualTaxReturn
  internal section_7703_files_separate_return
    content boolean depends on individual_arg content Individual,
      individual_tax_return_arg content IndividualTaxReturn
  internal section_7703_is_spouse_member_of_household_last_6_months
    content boolean depends on spouse_arg content Individual,
      household_arg content Household,
      residence_period_events_arg content list of ResidencePeriodEvent,
      last_6_months_start_arg content date,
      last_6_months_end_arg content date

  context determination_date content date
  context is_married_at_determination_date content boolean
  context is_legally_separated content boolean
  context households_with_qualifying_child content list of Household
  context households_maintained_by_individual content list of Household
  context spouse_not_member_of_household_last_6_months content boolean
  context subsection_b_exception_applies content boolean
  context is_married_for_tax_purposes content boolean

  output main_output content IndividualSection7703MaritalStatusOutput
```



<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: function
name: is_tax_year_2018_through_2025
action: add
law_ref: section_63_helpers
```
```catala-metadata
declaration is_tax_year_2018_through_2025
  content boolean
  depends on tax_year_arg content integer
  equals
    tax_year_arg >= 2018
    and tax_year_arg <= 2025
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: function
name: section_2_spouse_death_events_in_window
action: add
law_ref: section_2_helpers
```
```catala-metadata
declaration section_2_spouse_death_events_in_window
  content list of DeathEvent
  depends on spouse_arg content optional of Individual,
    death_events_arg content list of DeathEvent,
    tax_year_arg content integer
  equals
    match spouse_arg with pattern
    -- Present content s :
      list of death_event among death_events_arg
        such that death_event.decedent = s
        and Date.get_year of death_event.death_date >= tax_year_arg - 2
        and Date.get_year of death_event.death_date < tax_year_arg
    -- Absent : list of death_event among death_events_arg such that false
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: function
name: section_2_spouse_death_year
action: add
law_ref: section_2_helpers
```
```catala-metadata
declaration section_2_spouse_death_year
  content optional of integer
  depends on spouse_death_events_in_window_arg content list of DeathEvent
  equals
    if number of spouse_death_events_in_window_arg > 0 then
      Present content (maximum of (map each death_event among spouse_death_events_in_window_arg to Date.get_year of death_event.death_date))
    else Absent
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: function
name: section_2_most_recent_spouse_death_date
action: add
law_ref: section_2_helpers
```
```catala-metadata
declaration section_2_most_recent_spouse_death_date
  content date
  depends on spouse_death_events_in_window_arg content list of DeathEvent,
    tax_year_arg content integer
  equals
    if number of spouse_death_events_in_window_arg > 0 then
      maximum of (map each death_event among spouse_death_events_in_window_arg to death_event.death_date)
    else Date.of_year_month_day of tax_year_arg, 1, 1
```


<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: function
name: individual_attained_age_65
action: add
law_ref: section_63_helpers
```
```catala-metadata
declaration individual_attained_age_65
  content boolean
  depends on individual_arg content Individual,
    birth_events_arg content list of BirthEvent,
    year_end_arg content date
  equals
    exists birth_event among birth_events_arg
      such that birth_event.individual = individual_arg
      and Date.is_old_enough_rounding_down of birth_event.birth_date, 65 year, year_end_arg
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: function
name: individual_is_blind_at_close
action: add
law_ref: section_63_helpers
```
```catala-metadata
declaration individual_is_blind_at_close
  content boolean
  depends on individual_arg content Individual,
    blindness_status_events_arg content list of BlindnessStatusEvent,
    death_events_arg content list of DeathEvent,
    year_end_arg content date
  equals
    exists blindness_event among blindness_status_events_arg
      such that blindness_event.individual = individual_arg
      and blindness_event.status_date <= year_end_arg
      and blindness_event.is_blind
      and not (
        exists death_event among death_events_arg
          such that death_event.decedent = individual_arg
          and death_event.death_date < blindness_event.status_date
          and death_event.death_date <= year_end_arg
      )
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: function
name: get_year_end
action: add
law_ref: section_63_helpers
```
```catala-metadata
declaration get_year_end
  content date
  depends on tax_year_arg content integer
  equals
    Date.of_year_month_day of tax_year_arg, 12, 31
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: function
name: get_taxpayer
action: add
law_ref: section_63_helpers
```
```catala-metadata
declaration get_taxpayer
  content Individual
  depends on individual_tax_return_arg content IndividualTaxReturn
  equals
    match individual_tax_return_arg.details with pattern
    -- FilingStatusVariant.JointReturn content variant : variant.taxpayer
    -- FilingStatusVariant.SurvivingSpouse content variant : variant.taxpayer
    -- FilingStatusVariant.HeadOfHousehold content variant : variant.taxpayer
    -- FilingStatusVariant.Single content variant : variant.taxpayer
    -- FilingStatusVariant.MarriedFilingSeparate content variant : variant.taxpayer
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: function
name: get_spouse
action: add
law_ref: section_63_helpers
```
```catala-metadata
declaration get_spouse
  content optional of Individual
  depends on individual_tax_return_arg content IndividualTaxReturn
  equals
    match individual_tax_return_arg.details with pattern
    -- FilingStatusVariant.JointReturn content variant : Present content variant.spouse
    -- FilingStatusVariant.SurvivingSpouse content variant : Present content variant.deceased_spouse
    -- FilingStatusVariant.HeadOfHousehold content variant : Absent
    -- FilingStatusVariant.Single content variant : Absent
    -- FilingStatusVariant.MarriedFilingSeparate content variant : Present content variant.spouse
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: function
name: extract_spouse_itemization_election
action: add
law_ref: section_63_helpers
```
```catala-metadata
declaration extract_spouse_itemization_election
  content boolean
  depends on individual_tax_return_arg content IndividualTaxReturn
  equals
    match individual_tax_return_arg.details with pattern
    -- FilingStatusVariant.JointReturn content variant : false
    -- FilingStatusVariant.SurvivingSpouse content variant : false
    -- FilingStatusVariant.HeadOfHousehold content variant : false
    -- FilingStatusVariant.Single content variant : false
    -- FilingStatusVariant.MarriedFilingSeparate content variant : variant.spouse_itemization_election
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: function
name: individual_is_nonresident_alien_during_year
action: add
law_ref: section_63_helpers
```
```catala-metadata
declaration individual_is_nonresident_alien_during_year
  content boolean
  depends on individual_arg content Individual,
    nonresident_alien_status_period_events_arg content list of NonresidentAlienStatusPeriodEvent,
    tax_year_arg content integer,
    year_end_arg content date
  equals
    exists residency_event among nonresident_alien_status_period_events_arg
      such that residency_event.individual = individual_arg
      and residency_event.start_date <= year_end_arg
      and residency_event.end_date >= Date.of_year_month_day of tax_year_arg, 1, 1
      and residency_event.residency_status = ResidencyStatus.NonresidentAlien
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: Organization
action: add
law_ref: section_3306
structure_type: Entity
```
```catala-metadata
declaration structure Organization:
  data id content integer
  data organization_type content OrganizationType
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: enumeration
name: OrganizationType
action: add
law_ref: section_3306
```
```catala-metadata
declaration enumeration OrganizationType:
  -- Business
  -- GovernmentFederal
  -- GovernmentState
  -- EducationalInstitution
  -- Hospital
  -- Club
  -- FraternityOrSorority
  -- ForeignGovernment
  -- InternationalOrganization
  -- PenalInstitution
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: enumeration
name: EmploymentCategory
action: add
law_ref: section_3306
```
```catala-metadata
declaration enumeration EmploymentCategory:
  -- General
  -- AgriculturalLabor
  -- DomesticService
  -- FederalGovernment
  -- StateGovernment
  -- SchoolCollegeUniversity
  -- Hospital
  -- ForeignGovernment
  -- InternationalOrganization
  -- PenalInstitution
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: enumeration
name: ServiceLocation
action: add
law_ref: section_3306
```
```catala-metadata
declaration enumeration ServiceLocation:
  -- WithinUnitedStates
  -- OutsideUnitedStates
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: enumeration
name: PaymentMedium
action: add
law_ref: section_3306
```
```catala-metadata
declaration enumeration PaymentMedium:
  -- Cash
  -- NonCash
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: enumeration
name: PaymentReason
action: add
law_ref: section_3306
```
```catala-metadata
declaration enumeration PaymentReason:
  -- RegularCompensation
  -- SicknessOrAccidentDisability
  -- Death
  -- TerminationAfterDeathOrDisabilityRetirement
  -- AgriculturalLaborNonCash
  -- DomesticServiceNonBusiness
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: enumeration
name: VisaCategory
action: add
law_ref: section_3306
```
```catala-metadata
declaration enumeration VisaCategory:
  -- H2A
  -- Other
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: enumeration
name: TerminationReason
action: add
law_ref: section_3306
```
```catala-metadata
declaration enumeration TerminationReason:
  -- Death
  -- DisabilityRetirement
  -- Other
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: EmploymentRelationshipEvent
action: add
law_ref: section_3306
structure_type: Event
```
```catala-metadata
declaration structure EmploymentRelationshipEvent:
  data id content integer
  data employer content Organization
  data employee content Individual
  data start_date content date
  data end_date content date
  data employment_category content EmploymentCategory
  data service_location content ServiceLocation
  data is_american_employer content boolean
  data employee_is_us_citizen content boolean
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: WagePaymentEvent
action: add
law_ref: section_3306
structure_type: Event
```
```catala-metadata
declaration structure WagePaymentEvent:
  data id content integer
  data employer content Organization
  data employee content Individual
  data payment_date content date
  data amount content money
  data payment_medium content PaymentMedium
  data payment_reason content PaymentReason
  data is_under_plan_or_system content boolean
  data is_for_employee_generally content boolean
  data is_for_class_of_employees content boolean
  data is_for_dependents content boolean
  data is_not_in_course_of_trade_or_business content boolean
  data would_have_been_paid_without_termination content boolean
  data is_paid_to_survivor_or_estate content boolean
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: StudentEnrollmentEvent
action: add
law_ref: section_3306
structure_type: Event
```
```catala-metadata
declaration structure StudentEnrollmentEvent:
  data id content integer
  data student content Individual
  data institution content Organization
  data start_date content date
  data end_date content date
  data is_regularly_attending content boolean
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: HospitalPatientEvent
action: add
law_ref: section_3306
structure_type: Event
```
```catala-metadata
declaration structure HospitalPatientEvent:
  data id content integer
  data patient content Individual
  data hospital content Organization
  data start_date content date
  data end_date content date
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: ImmigrationAdmissionEvent
action: add
law_ref: section_3306
structure_type: Event
```
```catala-metadata
declaration structure ImmigrationAdmissionEvent:
  data id content integer
  data individual content Individual
  data visa_category content VisaCategory
  data admission_date content date
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: EmploymentTerminationEvent
action: add
law_ref: section_3306
structure_type: Event
```
```catala-metadata
declaration structure EmploymentTerminationEvent:
  data id content integer
  data employer content Organization
  data employee content Individual
  data termination_date content date
  data reason content TerminationReason
  data is_counterfactual content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: enumeration
name: EmployerVariant
action: add
law_ref: section_3306
```
```catala-metadata
declaration enumeration EmployerVariant:
  -- GeneralEmployer content EmployerGeneralVariant
  -- AgriculturalEmployer content EmployerAgriculturalLaborVariant
  -- DomesticServiceEmployer content EmployerDomesticServiceVariant
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: EmployerGeneralVariant
action: add
law_ref: section_3306
structure_type: TaxLawHelperStructure
```
```catala-metadata
declaration structure EmployerGeneralVariant:
  data employer content Organization
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: EmployerAgriculturalLaborVariant
action: add
law_ref: section_3306
structure_type: TaxLawHelperStructure
```
```catala-metadata
declaration structure EmployerAgriculturalLaborVariant:
  data employer content Organization
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: EmployerDomesticServiceVariant
action: add
law_ref: section_3306
structure_type: TaxLawHelperStructure
```
```catala-metadata
declaration structure EmployerDomesticServiceVariant:
  data employer content Organization
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: EmployerUnemploymentExciseTaxReturn
action: add
law_ref: section_3306
structure_type: TaxReturn
```
```catala-metadata
declaration structure EmployerUnemploymentExciseTaxReturn:
  data id content integer
  data tax_year content integer
  data details content EmployerVariant
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: OrganizationSection3306EmployerStatusOutput
action: add
law_ref: section_3306_a
structure_type: MainOutput
```
```catala-metadata
declaration structure OrganizationSection3306EmployerStatusOutput:
  data organization content Organization
  data is_employer content boolean
  data is_general_employer content boolean
  data is_agricultural_employer content boolean
  data is_domestic_service_employer content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: scope
name: OrganizationSection3306EmployerStatus
action: add
law_ref: section_3306_a
scope_owner_type: Entity
scope_owner_name: Organization
```
```catala-metadata
declaration scope OrganizationSection3306EmployerStatus:
  input organization content Organization
  input calendar_year content integer
  input wage_payment_events content list of WagePaymentEvent
  input employment_relationship_events content list of EmploymentRelationshipEvent
  
  # Helper functions (not directly in law text)
  internal section_3306_employment_overlaps_date
    content boolean depends on emp_event_arg content EmploymentRelationshipEvent,
             check_date_arg content date
  internal section_3306_count_unique_employees
    content integer depends on employment_events_arg content list of EmploymentRelationshipEvent
  internal section_3306_get_day_of_year
    content integer depends on date_arg content date
  internal section_3306_get_calendar_week_us
    content (integer, integer) depends on date_arg content date
  internal section_3306_get_candidate_dates_in_year
    content list of date depends on employment_events_arg content list of EmploymentRelationshipEvent,
             target_year_arg content integer
  internal section_3306_get_days_with_employment
    content list of date depends on employment_events_arg content list of EmploymentRelationshipEvent,
             target_year_arg content integer,
             min_individuals_arg content integer
  internal section_3306_get_week_identifier
    content (integer, integer) depends on date_arg content date
  internal section_3306_count_unique_calendar_weeks
    content integer depends on dates_arg content list of date
  internal section_3306_has_ten_days_in_different_weeks
    content boolean depends on employment_events_arg content list of EmploymentRelationshipEvent,
             target_year_arg content integer,
             min_individuals_arg content integer
  
  context is_general_employer content boolean
  context is_agricultural_employer content boolean
  context is_domestic_service_employer content boolean
  context is_employer content boolean
  
  output main_output content OrganizationSection3306EmployerStatusOutput
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: WagePaymentEventSection3306WagesOutput
action: add
law_ref: section_3306_b
structure_type: MainOutput
```
```catala-metadata
declaration structure WagePaymentEventSection3306WagesOutput:
  data wage_payment_event content WagePaymentEvent
  data is_excluded_by_sickness_disability_death content boolean
  data is_excluded_by_nonbusiness_service content boolean
  data is_excluded_by_termination_payment content boolean
  data is_excluded_by_agricultural_noncash content boolean
  data is_excluded_by_survivor_payment content boolean
  data taxable_amount_before_7000_cap content money
  # This is the amount after applying all exclusions EXCEPT the $7,000 cap
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: scope
name: WagePaymentEventSection3306Wages
action: add
law_ref: section_3306_b
scope_owner_type: Event
scope_owner_name: WagePaymentEvent
```
```catala-metadata
declaration scope WagePaymentEventSection3306Wages:
  input wage_payment_event content WagePaymentEvent
  input employment_termination_events content list of EmploymentTerminationEvent
  input death_events content list of DeathEvent
  
  context is_excluded_by_sickness_disability_death content boolean
  context is_excluded_by_nonbusiness_service content boolean
  context is_excluded_by_termination_payment content boolean
  context is_excluded_by_agricultural_noncash content boolean
  context is_excluded_by_survivor_payment content boolean
  context taxable_amount_before_7000_cap content money
  # This is the amount after applying all exclusions EXCEPT the $7,000 cap
  
  output main_output content WagePaymentEventSection3306WagesOutput
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: TotalWages3306CalculationOutput
action: add
law_ref: section_3306_b_1
structure_type: MainOutput
```
```catala-metadata
declaration structure TotalWages3306CalculationOutput:
  data total_taxable_wages content money
  data wage_results_with_cap content list of WagePaymentEventSection3306WagesOutput
  # Each wage result includes the final taxable_amount_after_7000_cap
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: scope
name: TotalWages3306Calculation
action: add
law_ref: section_3306_b_1
scope_owner_type: TaxLawEntity
scope_owner_name: EmployerUnemploymentExciseTaxFiler
```
```catala-metadata
declaration scope TotalWages3306Calculation:
  input wage_results content list of WagePaymentEventSection3306WagesOutput
  # List of wage results from WagePaymentEventSection3306Wages (before $7,000 cap)
  # These should be sorted by wage_payment_event.id to ensure sequential processing
  
  context total_taxable_wages content money
  # Total taxable wages after applying $7,000 cap sequentially
  
  output main_output content TotalWages3306CalculationOutput
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: EmploymentRelationshipEventSection3306EmploymentOutput
action: add
law_ref: section_3306_c
structure_type: MainOutput
```
```catala-metadata
declaration structure EmploymentRelationshipEventSection3306EmploymentOutput:
  data employment_relationship_event content EmploymentRelationshipEvent
  data is_employment content boolean
  data is_excluded_agricultural_labor content boolean
  data is_excluded_domestic_service content boolean
  data is_excluded_family_employment content boolean
  data is_excluded_federal_government content boolean
  data is_excluded_state_government content boolean
  data is_excluded_student_service content boolean
  data is_excluded_hospital_patient_service content boolean
  data is_excluded_foreign_government content boolean
  data is_excluded_student_nurse content boolean
  data is_excluded_international_organization content boolean
  data is_excluded_penal_institution content boolean
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: scope
name: EmploymentRelationshipEventSection3306Employment
action: add
law_ref: section_3306_c
scope_owner_type: Event
scope_owner_name: EmploymentRelationshipEvent
```
```catala-metadata
declaration scope EmploymentRelationshipEventSection3306Employment:
  input employment_relationship_event content EmploymentRelationshipEvent
  input calendar_year content integer
  input wage_payment_events content list of WagePaymentEvent
  input employment_relationship_events content list of EmploymentRelationshipEvent
  input student_enrollment_events content list of StudentEnrollmentEvent
  input hospital_patient_events content list of HospitalPatientEvent
  input immigration_admission_events content list of ImmigrationAdmissionEvent
  input parenthood_events content list of ParenthoodEvent
  input birth_events content list of BirthEvent
  input marriage_events content list of MarriageEvent
  
  context is_excluded_agricultural_labor content boolean
  context is_excluded_domestic_service content boolean
  context is_excluded_family_employment content boolean
  context is_excluded_federal_government content boolean
  context is_excluded_state_government content boolean
  context is_excluded_student_service content boolean
  context is_excluded_hospital_patient_service content boolean
  context is_excluded_foreign_government content boolean
  context is_excluded_student_nurse content boolean
  context is_excluded_international_organization content boolean
  context is_excluded_penal_institution content boolean
  context is_employment content boolean
  
  output main_output content EmploymentRelationshipEventSection3306EmploymentOutput
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: structure
name: EmployerUnemploymentExciseTaxFilerSection3301TaxOutput
action: add
law_ref: section_3301
structure_type: MainOutput
```
```catala-metadata
declaration structure EmployerUnemploymentExciseTaxFilerSection3301TaxOutput:
  data employer_unemployment_excise_tax_return content EmployerUnemploymentExciseTaxReturn
  data total_taxable_wages content money
  data excise_tax content money
  data tax_rate content decimal
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: scope
name: EmployerUnemploymentExciseTaxFilerSection3301Tax
action: add
law_ref: section_3301
scope_owner_type: TaxLawEntity
scope_owner_name: EmployerUnemploymentExciseTaxFiler
```
```catala-metadata
declaration scope EmployerUnemploymentExciseTaxFilerSection3301Tax:
  input employer_unemployment_excise_tax_return content EmployerUnemploymentExciseTaxReturn
  input wage_payment_wages_results content list of WagePaymentEventSection3306WagesOutput
  input organization_employer_statuses content list of OrganizationSection3306EmployerStatusOutput
  input employment_relationship_employment_results content list of EmploymentRelationshipEventSection3306EmploymentOutput
  
  context output total_taxable_wages content money
  context output excise_tax content money
  context output tax_rate content decimal
  
  output main_output content EmployerUnemploymentExciseTaxFilerSection3301TaxOutput
```

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: declaration
object_type: scope
name: IRCSimplified
law_ref: section_63
scope_owner_type: TaxLawEntity
scope_owner_name: IndividualTaxpayer
```
```catala-metadata
declaration scope IRCSimplified:
  input individual_tax_return content IndividualTaxReturn
  input individuals content list of Individual
  input organizations content list of Organization
  input birth_events content list of BirthEvent
  input blindness_status_events content list of BlindnessStatusEvent
  input death_events content list of DeathEvent
  input nonresident_alien_status_period_events content list of NonresidentAlienStatusPeriodEvent
  input marriage_events content list of MarriageEvent
  input remarriage_events content list of RemarriageEvent
  input divorce_or_legal_separation_events content list of DivorceOrLegalSeparationEvent
  input residence_period_events content list of ResidencePeriodEvent
  input household_maintenance_events content list of HouseholdMaintenanceEvent
  input parenthood_events content list of ParenthoodEvent
  input family_relationship_events content list of FamilyRelationshipEvent
  input tax_return_events content list of TaxReturnEvent
  input income_events content list of IncomeEvent
  input employment_relationship_events content list of EmploymentRelationshipEvent
  input wage_payment_events content list of WagePaymentEvent
  input student_enrollment_events content list of StudentEnrollmentEvent
  input hospital_patient_events content list of HospitalPatientEvent
  input immigration_admission_events content list of ImmigrationAdmissionEvent
  input employment_termination_events content list of EmploymentTerminationEvent
  input employer_unemployment_excise_tax_return content EmployerUnemploymentExciseTaxReturn
  
  # section2 chunks
  context output section_2_a_1_A_spouse_died_in_preceding_two_years content boolean
  context output section_2_a_1_B_satisfied content boolean
  context output section_2_a_2_A_taxpayer_has_remarried content boolean
  context output section_2_a_2_B_joint_return_could_have_been_made content boolean
  context output section_2_b_2_is_married_at_close_of_year content boolean
  context output section_2_b_1_A_i_I_qualifying_child_is_married_at_close_of_year content boolean
  context output section_2_b_1_A_i_II_qualifying_person_not_dependent_by_152b2 content boolean
  context output section_2_b_1_A_i_satisfied content boolean
  context output section_2_b_1_A_ii_satisfied content boolean
  context output section_2_b_1_A_satisfied content boolean
  context output section_2_b_1_B_satisfied content boolean
 

  context output taxable_income content money
  context output standard_deduction content money
  context output standard_deduction_eligible content boolean
  context output basic_standard_deduction content money
  context output additional_standard_deduction content money
  context output itemized_deductions content money
  context output adjusted_gross_income content money
  context output additional_amount_taxpayer_aged content money
  context output additional_amount_spouse_aged content money
  context output additional_amount_taxpayer_blind content money
  context output additional_amount_spouse_blind content money

  context output applicable_amount content money
  context output section_68_three_percent_reduction content money
  context output section_68_eighty_percent_reduction content money
  context output section_68_reduction_amount content money
  context output itemized_deductions_after_68 content money

  context output taxpayer_exemptions_list_result content TaxpayerExemptionsListOutput
  taxpayer_exemptions_list scope TaxpayerExemptionsList
  
  context output taxpayer_exemption_result content IndividualSection151ExemptionOutput
  taxpayer_exemption scope IndividualSection151Exemption

  context output tax content money

  context output is_surviving_spouse content boolean
  context output is_head_of_household content boolean

  # Dependents computed via IndividualSection152Dependents scope
  context output taxpayer_dependents_result content IndividualSection152DependentsOutput
  taxpayer_dependents scope IndividualSection152Dependents
  
  
  context output individual_marital_statuses content list of IndividualSection7703MaritalStatusOutput
  taxpayer_marital_status scope IndividualSection7703MaritalStatus
  
  # section 3306 outputs
  context output organization_employer_statuses content list of OrganizationSection3306EmployerStatusOutput
  context output wage_payment_wages_results content list of WagePaymentEventSection3306WagesOutput
  context output employment_relationship_employment_results content list of EmploymentRelationshipEventSection3306EmploymentOutput
  
  # section 3301 outputs
  context output employer_unemployment_excise_tax_result content EmployerUnemploymentExciseTaxFilerSection3301TaxOutput
  employer_unemployment_excise_tax scope EmployerUnemploymentExciseTaxFilerSection3301Tax
```

# Section 63 - Taxable income defined
#============================= SECTION 63 =============================

63. Taxable income defined

- (f) Aged or blind additional amounts

  - (1) Additional amounts for the aged

    The taxpayer shall be entitled to an additional amount of $600-

    - (A) for himself if he has attained age 65 before the close of his taxable year, and

<!-- BLOCK_SPLIT: additional amount for taxpayer aged -->
<!-- LAW_REF: section_63_f_1_A -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_63_f_1_A
```
```catala
scope IRCSimplified:
  # LAW: 63(f)(1)(A) - Additional amount for taxpayer aged
  # The taxpayer shall be entitled to an additional amount of $600 for himself if he has attained age 65
  # before the close of his taxable year
  label section_63_f_1_A_base_case
  definition additional_amount_taxpayer_aged equals
    if individual_attained_age_65 of (get_taxpayer of individual_tax_return), birth_events, (get_year_end of individual_tax_return.tax_year) then $600 else $0
```

    - (B) for the spouse of the taxpayer if the spouse has attained age 65 before the close of the taxable year and an additional exemption is allowable to the taxpayer for such spouse under section 151(b).

<!-- BLOCK_SPLIT: additional amount for spouse aged -->
<!-- LAW_REF: section_63_f_1_B -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_63_f_1_B
```
```catala
scope IRCSimplified:
  # LAW: 63(f)(1)(B) - Additional amount for spouse aged
  # For the spouse of the taxpayer if the spouse has attained age 65 before the close of the taxable year
  # and an additional exemption is allowable to the taxpayer for such spouse under section 151(b)
  label section_63_f_1_B_base_case
  definition additional_amount_spouse_aged equals $0

  exception section_63_f_1_B_base_case
  definition additional_amount_spouse_aged under condition
    let spouse_local equals get_spouse of individual_tax_return in
    let year_end_local equals get_year_end of individual_tax_return.tax_year in
    let spouse_attained_age_65_local equals
      match spouse_local with pattern
      -- Present content s : individual_attained_age_65 of s, birth_events, year_end_local
      -- Absent : false
    in
    # Check both: spouse attained age 65 AND additional exemption is allowable under section 151(b)
    spouse_attained_age_65_local
    and taxpayer_exemptions_list_result.spouse_personal_exemption_allowed
    and match individual_tax_return.details with pattern
    -- FilingStatusVariant.JointReturn content variant : true
    -- FilingStatusVariant.SurvivingSpouse content variant : true
    -- FilingStatusVariant.MarriedFilingSeparate content variant : true
    -- FilingStatusVariant.HeadOfHousehold content variant : false
    -- FilingStatusVariant.Single content variant : false
  consequence equals $600
```

  - (2) Additional amount for blind

    The taxpayer shall be entitled to an additional amount of $600-

    - (A) for himself if he is blind at the close of the taxable year, and

<!-- BLOCK_SPLIT: additional amount for taxpayer blind -->
<!-- LAW_REF: section_63_f_2_A -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_63_f_2_A
```
```catala
scope IRCSimplified:
  # LAW: 63(f)(2)(A) - Additional amount for taxpayer blind
  # The taxpayer shall be entitled to an additional amount of $600 for himself if he is blind at the close of the taxable year
  label section_63_f_2_A_base_case
  definition additional_amount_taxpayer_blind equals
    if individual_is_blind_at_close of (get_taxpayer of individual_tax_return), blindness_status_events, death_events, (get_year_end of individual_tax_return.tax_year) then $600 else $0
```

    - (B) for the spouse of the taxpayer if the spouse is blind as of the close of the taxable year and an additional exemption is allowable to the taxpayer for such spouse under section 151(b).

      For purposes of subparagraph (B), if the spouse dies during the taxable year the determination of whether such spouse is blind shall be made as of the time of such death.

<!-- BLOCK_SPLIT: additional amount for spouse blind -->
<!-- LAW_REF: section_63_f_2_B -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_63_f_2_B
```
```catala
scope IRCSimplified:
  # LAW: 63(f)(2)(B) - Additional amount for spouse blind
  # For the spouse of the taxpayer if the spouse is blind as of the close of the taxable year
  # and an additional exemption is allowable to the taxpayer for such spouse under section 151(b)
  # For purposes of subparagraph (B), if the spouse dies during the taxable year the determination
  # of whether such spouse is blind shall be made as of the time of such death
  label section_63_f_2_B_base_case
  definition additional_amount_spouse_blind equals $0

  exception section_63_f_2_B_base_case
  definition additional_amount_spouse_blind under condition
    let spouse_local equals get_spouse of individual_tax_return in
    let year_end_local equals get_year_end of individual_tax_return.tax_year in
    let spouse_death_events_local equals
      match spouse_local with pattern
      -- Present content s :
        list of death_event among death_events
          such that death_event.decedent = s
          and Date.get_year of death_event.death_date = individual_tax_return.tax_year
      -- Absent : list of death_event among death_events such that false
    in
    let spouse_death_date_local equals
      if number of spouse_death_events_local > 0 then
        minimum of (map each death_event among spouse_death_events_local to death_event.death_date)
      else year_end_local
    in
    let spouse_is_blind_at_close_local equals
      match spouse_local with pattern
      -- Present content s : individual_is_blind_at_close of s, blindness_status_events, death_events, spouse_death_date_local
      -- Absent : false
    in
    # Check both: spouse is blind AND additional exemption is allowable under section 151(b)
    spouse_is_blind_at_close_local
    and taxpayer_exemptions_list_result.spouse_personal_exemption_allowed
    and match individual_tax_return.details with pattern
    -- FilingStatusVariant.JointReturn content variant : true
    -- FilingStatusVariant.SurvivingSpouse content variant : true
    -- FilingStatusVariant.MarriedFilingSeparate content variant : true
    -- FilingStatusVariant.HeadOfHousehold content variant : false
    -- FilingStatusVariant.Single content variant : false
  consequence equals $600
```

  - (3) Higher amount for certain unmarried individuals

    In the case of an individual who is not married and is not a surviving spouse, paragraphs (1) and (2) shall be applied by substituting "$750" for "$600".

<!-- BLOCK_SPLIT: higher amount for certain unmarried individuals -->
<!-- LAW_REF: section_63_f_3 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_63_f_3
```
```catala
scope IRCSimplified:
  # LAW: 63(f)(3) - Higher amount for certain unmarried individuals
  # In the case of an individual who is not married and is not a surviving spouse,
  # paragraphs (1) and (2) shall be applied by substituting "$750" for "$600"
  exception section_63_f_1_A_base_case
  definition additional_amount_taxpayer_aged under condition
    let taxpayer_local equals get_taxpayer of individual_tax_return in
    let year_end_local equals get_year_end of individual_tax_return.tax_year in
    individual_attained_age_65 of taxpayer_local, birth_events, year_end_local
    and not taxpayer_marital_status.main_output.is_married_for_tax_purposes
    and not is_surviving_spouse
  consequence equals $750

  exception section_63_f_2_A_base_case
  definition additional_amount_taxpayer_blind under condition
    let taxpayer_local equals get_taxpayer of individual_tax_return in
    let year_end_local equals get_year_end of individual_tax_return.tax_year in
    individual_is_blind_at_close of taxpayer_local, blindness_status_events, death_events, year_end_local
    and not taxpayer_marital_status.main_output.is_married_for_tax_purposes
    and not is_surviving_spouse
  consequence equals $750
```

- (c) Standard deduction

  For purposes of this subtitle-

  - (3) Additional standard deduction for aged and blind

    For purposes of paragraph (1), the additional standard deduction is the sum of each additional amount to which the taxpayer is entitled under subsection (f).

<!-- BLOCK_SPLIT: additional standard deduction -->
<!-- LAW_REF: section_63_c_3 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_63_c_3
```
```catala
scope IRCSimplified:
  # LAW: 63(c)(3) - Additional standard deduction for aged and blind
  # For purposes of paragraph (1), the additional standard deduction is the sum of each additional amount
  # to which the taxpayer is entitled under subsection (f)
  label section_63_c_3_additional_standard_deduction
  definition additional_standard_deduction equals
    additional_amount_taxpayer_aged + additional_amount_spouse_aged
    + additional_amount_taxpayer_blind
    + additional_amount_spouse_blind
```

  - (2) Basic standard deduction

    For purposes of paragraph (1), the basic standard deduction is-

    - (A) 200 percent of the dollar amount in effect under subparagraph (C) for the taxable year in the case of-

      - (i) a joint return, or

      - (ii) a surviving spouse (as defined in section 2(a)),

    - (B) $4,400 in the case of a head of household (as defined in section 2(b)), or

    - (C) $3,000 in any other case.

<!-- BLOCK_SPLIT: basic standard deduction -->
<!-- LAW_REF: section_63_c_2 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_63_c_2
```
```catala
scope IRCSimplified:
  # LAW: 63(c)(2) - Basic standard deduction
  # For purposes of paragraph (1), the basic standard deduction is-
  # (A) 200 percent of the dollar amount in effect under subparagraph (C) for the taxable year in the case of-
  #     (i) a joint return, or
  #     (ii) a surviving spouse (as defined in section 2(a)),
  # (B) $4,400 in the case of a head of household (as defined in section 2(b)), or
  # (C) $3,000 in any other case
  label section_63_c_2_base_case
  definition basic_standard_deduction equals $3,000

  label section_63_c_2_head_of_household
  exception section_63_c_2_base_case
  definition basic_standard_deduction under condition
    not (is_tax_year_2018_through_2025 of individual_tax_return.tax_year)
    and is_head_of_household
  consequence equals $4,400

  label section_63_c_2_joint_or_surviving_spouse  
  exception section_63_c_2_head_of_household
  definition basic_standard_deduction under condition
    (
      not (is_tax_year_2018_through_2025 of individual_tax_return.tax_year) 
      and
      ((taxpayer_marital_status.main_output.is_married_for_tax_purposes
      and (
        match individual_tax_return.details with pattern
        -- FilingStatusVariant.JointReturn content variant : true
        -- FilingStatusVariant.SurvivingSpouse content variant : false
        -- FilingStatusVariant.HeadOfHousehold content variant : false
        -- FilingStatusVariant.Single content variant : false
        -- FilingStatusVariant.MarriedFilingSeparate content variant : false
      ))
      or is_surviving_spouse)
    )
  consequence equals $6,000
```

  - (7) Special rules for taxable years 2018 through 2025

    In the case of a taxable year beginning after December 31, 2017, and before January 1, 2026-

    - (A) Paragraph (2) shall be applied-

      - (i) by substituting "$18,000" for "$4,400" in subparagraph (B), and

      - (ii) by substituting "$12,000" for "$3,000" in subparagraph (C).

<!-- BLOCK_SPLIT: special rules for taxable years 2018 through 2025 -->
<!-- LAW_REF: section_63_c_7 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_63_c_7
```
```catala
scope IRCSimplified:
  # LAW: 63(c)(7) - Special rules for taxable years 2018 through 2025
  # In the case of a taxable year beginning after December 31, 2017, and before January 1, 2026-
  # (A) Paragraph (2) shall be applied-
  #     (i) by substituting "$18,000" for "$4,400" in subparagraph (B), and
  #     (ii) by substituting "$12,000" for "$3,000" in subparagraph (C)
  label section_63_c_7_base_case
  exception section_63_c_2_base_case
  definition basic_standard_deduction under condition
    is_tax_year_2018_through_2025 of individual_tax_return.tax_year
  consequence equals $12,000

  label section_63_c_7_head_of_household
  exception section_63_c_7_base_case
  definition basic_standard_deduction under condition
    is_tax_year_2018_through_2025 of individual_tax_return.tax_year
    and is_head_of_household
  consequence equals $18,000

  label section_63_c_7_joint_or_surviving_spouse
  exception section_63_c_7_head_of_household
  definition basic_standard_deduction under condition
    is_tax_year_2018_through_2025 of individual_tax_return.tax_year
    and (
      (
        taxpayer_marital_status.main_output.is_married_for_tax_purposes
        and (
          match individual_tax_return.details with pattern
          -- FilingStatusVariant.JointReturn content variant : true
          -- FilingStatusVariant.SurvivingSpouse content variant : false
          -- FilingStatusVariant.HeadOfHousehold content variant : false
          -- FilingStatusVariant.Single content variant : false
          -- FilingStatusVariant.MarriedFilingSeparate content variant : false
        )
      )
      or is_surviving_spouse
    )
  consequence equals $24,000
```

  - (5) Limitation on basic standard deduction in the case of certain dependents

    In the case of an individual with respect to whom a deduction under section 151 is allowable to another taxpayer for a taxable year beginning in the calendar year in which the individual's taxable year begins, the basic standard deduction applicable to such individual for such individual's taxable year shall not exceed the greater of-

    - (A) $500, or

    - (B) the sum of $250 and such individual's earned income.

<!-- BLOCK_SPLIT: limitation on basic standard deduction for dependents -->
<!-- LAW_REF: section_63_c_5 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_63_c_5
```
```catala
scope IRCSimplified:
  # LAW: 63(c)(5) - Limitation on basic standard deduction in the case of certain dependents
  # In the case of an individual with respect to whom a deduction under section 151 is allowable to another taxpayer
  # for a taxable year beginning in the calendar year in which the individual's taxable year begins,
  # the basic standard deduction applicable to such individual for such individual's taxable year
  # shall not exceed the greater of-
  # (A) $500, or
  # (B) the sum of $250 and such individual's earned income
  exception section_63_c_2_base_case
  definition basic_standard_deduction under condition
    let taxpayer_local equals get_taxpayer of individual_tax_return in
    # Check if a deduction under section 151 is allowable to another taxpayer for this individual
    # This means: check if this individual appears in another taxpayer's dependents list
    let deduction_allowable_to_another_taxpayer equals
      exists event among tax_return_events
        such that event.individual != taxpayer_local
        and event.tax_year = individual_tax_return.tax_year
        and exists dependent among event.dependents such that dependent = taxpayer_local
    in
    deduction_allowable_to_another_taxpayer
  consequence equals
    # Get earned income from income events for the taxpayer
    let taxpayer_local equals get_taxpayer of individual_tax_return in
    let earned_income_local equals
      # Find income event for this taxpayer and tax year
      let income_event_local equals
        list of income_event among income_events
          such that income_event.individual = taxpayer_local
          and income_event.tax_year = individual_tax_return.tax_year
          and not income_event.is_counterfactual
      in
      if number of income_event_local > 0 then
        sum money of (map each event among income_event_local to event.earned_income)
      else
        $0
    in
    Money.min of $500, $250 + earned_income_local
```

  - (6) Certain individuals, etc., not eligible for standard deduction

    In the case of-

    - (A) a married individual filing a separate return where either spouse itemizes deductions,

    - (B) a nonresident alien individual, or

    - (D) an estate or trust, common trust fund, or partnership,

      the standard deduction shall be zero.

<!-- BLOCK_SPLIT: certain individuals not eligible for standard deduction -->
<!-- LAW_REF: section_63_c_6 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_63_c_6
```
```catala
scope IRCSimplified:
  # LAW: 63(c)(6) - Certain individuals, etc., not eligible for standard deduction
  # In the case of-
  # (A) a married individual filing a separate return where either spouse itemizes deductions,
  # (B) a nonresident alien individual, or
  # (D) an estate or trust, common trust fund, or partnership,
  # the standard deduction shall be zero
  label section_63_c_6_base_case
  definition standard_deduction_eligible equals true

  exception section_63_c_6_base_case
  definition standard_deduction_eligible under condition
    (
      match individual_tax_return.details with pattern
      -- FilingStatusVariant.JointReturn content variant : variant.is_estate_or_trust
      -- FilingStatusVariant.SurvivingSpouse content variant : variant.is_estate_or_trust
      -- FilingStatusVariant.HeadOfHousehold content variant : variant.is_estate_or_trust
      -- FilingStatusVariant.Single content variant : variant.is_estate_or_trust
      -- FilingStatusVariant.MarriedFilingSeparate content variant : variant.is_estate_or_trust
    )
    or (
      match individual_tax_return.details with pattern
      -- FilingStatusVariant.JointReturn content variant : variant.is_common_trust_fund
      -- FilingStatusVariant.SurvivingSpouse content variant : variant.is_common_trust_fund
      -- FilingStatusVariant.HeadOfHousehold content variant : variant.is_common_trust_fund
      -- FilingStatusVariant.Single content variant : variant.is_common_trust_fund
      -- FilingStatusVariant.MarriedFilingSeparate content variant : variant.is_common_trust_fund
    )
    or (
      match individual_tax_return.details with pattern
      -- FilingStatusVariant.JointReturn content variant : variant.is_partnership
      -- FilingStatusVariant.SurvivingSpouse content variant : variant.is_partnership
      -- FilingStatusVariant.HeadOfHousehold content variant : variant.is_partnership
      -- FilingStatusVariant.Single content variant : variant.is_partnership
      -- FilingStatusVariant.MarriedFilingSeparate content variant : variant.is_partnership
    )
  consequence equals false

  exception section_63_c_6_base_case
  definition standard_deduction_eligible under condition
    let taxpayer_local equals get_taxpayer of individual_tax_return in
    let year_end_local equals get_year_end of individual_tax_return.tax_year in
    individual_is_nonresident_alien_during_year of taxpayer_local, nonresident_alien_status_period_events, individual_tax_return.tax_year, year_end_local
  consequence equals false

  exception section_63_c_6_base_case
  definition standard_deduction_eligible under condition
    taxpayer_marital_status.main_output.is_married_for_tax_purposes
    and (
      match individual_tax_return.details with pattern
      -- FilingStatusVariant.MarriedFilingSeparate content variant : true
      -- FilingStatusVariant.JointReturn content variant : false
      -- FilingStatusVariant.SurvivingSpouse content variant : false
      -- FilingStatusVariant.HeadOfHousehold content variant : false
      -- FilingStatusVariant.Single content variant : false
    )
    and (
      (
        match individual_tax_return.details with pattern
        -- FilingStatusVariant.JointReturn content variant : variant.itemization_election
        -- FilingStatusVariant.SurvivingSpouse content variant : variant.itemization_election
        -- FilingStatusVariant.HeadOfHousehold content variant : variant.itemization_election
        -- FilingStatusVariant.Single content variant : variant.itemization_election
        -- FilingStatusVariant.MarriedFilingSeparate content variant : variant.itemization_election
      )
      or extract_spouse_itemization_election of individual_tax_return
    )
  consequence equals false
```

  - (1) In general

    Except as otherwise provided in this subsection, the term "standard deduction" means the sum of-

    - (A) the basic standard deduction, and 

    - (B) the additional standard deduction.

<!-- BLOCK_SPLIT: standard deduction in general -->
<!-- LAW_REF: section_63_c_1 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_63_c_1
```
```catala
scope IRCSimplified:
  # LAW: 63(c)(1) - In general
  # Except as otherwise provided in this subsection, the term "standard deduction" means the sum of-
  # (A) the basic standard deduction, and
  # (B) the additional standard deduction
  label section_63_c_1_base_case
  definition standard_deduction equals
    basic_standard_deduction + additional_standard_deduction

  exception section_63_c_1_base_case
  definition standard_deduction under condition
    not standard_deduction_eligible
  consequence equals $0
```

- (d) Itemized deductions

  For purposes of this subtitle, the term "itemized deductions" means the deductions allowable under this chapter other than-

  - (1) the deductions allowable in arriving at adjusted gross income, and

  - (2) the deduction for personal exemptions provided by section 151.

<!-- BLOCK_SPLIT: itemized deductions -->
<!-- LAW_REF: section_63_d -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_63_d
```
```catala
scope IRCSimplified:
  # LAW: 63(d) - Itemized deductions
  # For purposes of this subtitle, the term "itemized deductions" means the deductions allowable under this chapter
  # other than-
  # (1) the deductions allowable in arriving at adjusted gross income, and
  # (2) the deduction for personal exemptions provided by section 151
  # Note: This would be computed from other sections, placeholder for now
  label section_63_d_itemized_deductions
  definition itemized_deductions equals $0
```

- (a) In general

  Except as provided in subsection (b), for purposes of this subtitle, the term "taxable income" means gross income minus the deductions allowed by this chapter (other than the standard deduction).

- (b) Individuals who do not itemize their deductions

  In the case of an individual who does not elect to itemize his deductions for the taxable year, for purposes of this subtitle, the term "taxable income" means adjusted gross income, minus-

  - (1) the standard deduction, and

  - (2) the deduction for personal exemptions provided in section 151.

<!-- BLOCK_SPLIT: taxable income -->
<!-- LAW_REF: section_63_a_b -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_63_a_b
```
```catala
scope IRCSimplified:
  # LAW: 63(a) - In general
  # Except as provided in subsection (b), for purposes of this subtitle, the term "taxable income" means
  # gross income minus the deductions allowed by this chapter (other than the standard deduction)
  # LAW: 63(b) - Individuals who do not itemize their deductions
  # In the case of an individual who does not elect to itemize his deductions for the taxable year,
  # for purposes of this subtitle, the term "taxable income" means adjusted gross income, minus-
  # (1) the standard deduction, and
  # (2) the deduction for personal exemptions provided in section 151
  # Base case: Section 63(b) - Individuals who do not itemize
  # Taxable income = adjusted gross income - standard deduction - personal exemptions deduction
  label section_63_b_taxable_income
  definition taxable_income equals
    # Taxable income cannot be negative - floor at $0
    let computed_taxable_income equals
      adjusted_gross_income - standard_deduction - taxpayer_exemption_result.personal_exemptions_deduction
    in
    if computed_taxable_income < $0 then $0 else computed_taxable_income

  # Exception: Section 63(a) - Individuals who itemize
  # Taxable income = gross income - itemized deductions (excluding standard deduction)
  # Note: For itemizers, we use itemized_deductions which already excludes standard deduction
  # If gross_income is not available, we approximate using adjusted_gross_income + above-the-line deductions
  # For now, we use: taxable_income = adjusted_gross_income - itemized_deductions_after_68 - personal_exemptions_deduction
  # This assumes itemized_deductions_after_68 already accounts for all itemized deductions
  exception section_63_b_taxable_income
  definition taxable_income under condition
    let itemizes_deductions equals
      match individual_tax_return.details with pattern
      -- FilingStatusVariant.JointReturn content variant : variant.itemization_election
      -- FilingStatusVariant.SurvivingSpouse content variant : variant.itemization_election
      -- FilingStatusVariant.HeadOfHousehold content variant : variant.itemization_election
      -- FilingStatusVariant.Single content variant : variant.itemization_election
      -- FilingStatusVariant.MarriedFilingSeparate content variant : variant.itemization_election
    in
    itemizes_deductions
  consequence equals
    # Taxable income cannot be negative - floor at $0
    let computed_taxable_income equals
      adjusted_gross_income - itemized_deductions_after_68 - taxpayer_exemption_result.personal_exemptions_deduction
    in
    if computed_taxable_income < $0 then $0 else computed_taxable_income
```


# Section 68 - Overall limitation on itemized deductions
#============================= MAIN DEFINITIONS =============================

68. Overall limitation on itemized deductions

- (b) Applicable amount

  - (1) In general

    For purposes of this section, the term "applicable amount" means-

    - (A) $300,000 in the case of a joint return or a surviving spouse (as defined in section 2(a)),

<!-- BLOCK_SPLIT: applicable amount for joint return or surviving spouse -->
<!-- LAW_REF: section_68_b_1_A -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_68_b_1_A
```
```catala
scope IRCSimplified:
  # LAW: 68(b)(1)(A) - Applicable amount for joint return or surviving spouse
  # $300,000 in the case of a joint return or a surviving spouse (as defined in section 2(a))
  label section_68_b_1_A_applicable_amount
  definition applicable_amount equals
    if (
      taxpayer_marital_status.main_output.is_married_for_tax_purposes
      and (
        match individual_tax_return.details with pattern
        -- FilingStatusVariant.JointReturn content variant : true
        -- FilingStatusVariant.SurvivingSpouse content variant : false
        -- FilingStatusVariant.HeadOfHousehold content variant : false
        -- FilingStatusVariant.Single content variant : false
        -- FilingStatusVariant.MarriedFilingSeparate content variant : false
      )
    ) or is_surviving_spouse then
      $300,000
    else
      $0
```

    - (B) $275,000 in the case of a head of household (as defined in section 2(b)),

<!-- BLOCK_SPLIT: applicable amount for head of household -->
<!-- LAW_REF: section_68_b_1_B -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_68_b_1_B
```
```catala
scope IRCSimplified:
  # LAW: 68(b)(1)(B) - Applicable amount for head of household
  # $275,000 in the case of a head of household (as defined in section 2(b))
  label section_68_b_1_B_applicable_amount
  exception section_68_b_1_A_applicable_amount
  definition applicable_amount under condition
    is_head_of_household
  consequence equals $275,000
```

    - (C) $250,000 in the case of an individual who is not married and who is not a surviving spouse or head of household, and

<!-- BLOCK_SPLIT: applicable amount for single individual -->
<!-- LAW_REF: section_68_b_1_C -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_68_b_1_C
```
```catala
scope IRCSimplified:
  # LAW: 68(b)(1)(C) - Applicable amount for single individual
  # $250,000 in the case of an individual who is not married and who is not a surviving spouse or head of household
  label section_68_b_1_C_applicable_amount
  exception section_68_b_1_B_applicable_amount
  definition applicable_amount under condition
    not taxpayer_marital_status.main_output.is_married_for_tax_purposes
    and not is_surviving_spouse
    and not is_head_of_household
  consequence equals $250,000
```

    - (D) 1/2 the amount applicable under subparagraph (A) in the case of a married individual filing a separate return.

      For purposes of this paragraph, marital status shall be determined under section 7703.

<!-- BLOCK_SPLIT: applicable amount for married filing separate -->
<!-- LAW_REF: section_68_b_1_D -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_68_b_1_D
```
```catala
scope IRCSimplified:
  # LAW: 68(b)(1)(D) - Applicable amount for married filing separate
  # 1/2 the amount applicable under subparagraph (A) in the case of a married individual filing a separate return
  # For purposes of this paragraph, marital status shall be determined under section 7703
  # 1/2 of $300,000 = $150,000 
  label section_68_b_1_D_applicable_amount
  exception section_68_b_1_C_applicable_amount
  definition applicable_amount under condition
    taxpayer_marital_status.main_output.is_married_for_tax_purposes
    and (
      match individual_tax_return.details with pattern
      -- FilingStatusVariant.MarriedFilingSeparate content variant : true
      -- FilingStatusVariant.JointReturn content variant : false
      -- FilingStatusVariant.SurvivingSpouse content variant : false
      -- FilingStatusVariant.HeadOfHousehold content variant : false
      -- FilingStatusVariant.Single content variant : false
    )
  consequence equals $150,000
```

<!-- BLOCK_SPLIT: applicable amount final determination -->
<!-- LAW_REF: section_68_b_1 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_68_b_1
```
```catala
scope IRCSimplified:
  # LAW: 68(b)(1) - Applicable amount (final)
  # For purposes of this section, the term "applicable amount" means the amount determined
  # based on filing status (A, B, C, or D above)
  # The applicable_amount is already determined through the exception mechanism above
  # No additional definition needed - the context output is set through the exceptions
```

- (a) General rule

  In the case of an individual whose adjusted gross income exceeds the applicable amount, the amount of the itemized deductions otherwise allowable for the taxable year shall be reduced by the lesser of-

  - (1) 3 percent of the excess of adjusted gross income over the applicable amount, or

<!-- BLOCK_SPLIT: 3 percent reduction computation -->
<!-- LAW_REF: section_68_a_1 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_68_a_1
```
```catala
scope IRCSimplified:
  # LAW: 68(a)(1) - 3 percent reduction
  # 3 percent of the excess of adjusted gross income over the applicable amount
  label section_68_a_1_three_percent_reduction
  definition section_68_three_percent_reduction equals
    let excess_agi equals adjusted_gross_income - applicable_amount in
    if excess_agi > $0 then
      excess_agi * 3%
    else
      $0
```

  - (2) 80 percent of the amount of the itemized deductions otherwise allowable for such taxable year.

<!-- BLOCK_SPLIT: 80 percent reduction computation -->
<!-- LAW_REF: section_68_a_2 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_68_a_2
```
```catala
scope IRCSimplified:
  # LAW: 68(a)(2) - 80 percent reduction
  # 80 percent of the amount of the itemized deductions otherwise allowable for such taxable year
  label section_68_a_2_eighty_percent_reduction
  definition section_68_eighty_percent_reduction equals
    itemized_deductions * 80%
```

<!-- BLOCK_SPLIT: general rule - reduction amount computation -->
<!-- LAW_REF: section_68_a -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_68_a
```
```catala
scope IRCSimplified:
  # LAW: 68(a) - General rule
  # In the case of an individual whose adjusted gross income exceeds the applicable amount,
  # the amount of the itemized deductions otherwise allowable for the taxable year shall be reduced
  # by the lesser of:
  # (1) 3 percent of the excess of adjusted gross income over the applicable amount, or
  # (2) 80 percent of the amount of the itemized deductions otherwise allowable for such taxable year
  label section_68_a_reduction
  definition section_68_reduction_amount equals
    if adjusted_gross_income > applicable_amount then
      Money.min of section_68_three_percent_reduction, section_68_eighty_percent_reduction
    else
      $0

  # LAW: 68(a) - Itemized deductions after reduction
  # Itemized deductions after applying the section 68 limitation
  label section_68_a_itemized_deductions_after_68
  definition itemized_deductions_after_68 equals
    itemized_deductions - section_68_reduction_amount
```

- (f) Section not to apply

  This section shall not apply to any taxable year beginning after December 31, 2017, and before January 1, 2026.

<!-- BLOCK_SPLIT: section not to apply exception -->
<!-- LAW_REF: section_68_f -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_68_f
```
```catala
scope IRCSimplified:
  # LAW: 68(f) - Section not to apply
  # This section shall not apply to any taxable year beginning after December 31, 2017, and before January 1, 2026
  # Exception: If section 68(f) applies, no reduction
  label section_68_f_exception exception section_68_a_itemized_deductions_after_68
  definition itemized_deductions_after_68 under condition
    is_tax_year_2018_through_2025 of individual_tax_return.tax_year
  consequence equals itemized_deductions
```

  # Section 1 - Tax imposed
#============================= SECTION 1 =============================

1. Tax imposed

- (c) Unmarried individuals (other than surviving spouses and heads of households)

  There is hereby imposed on the taxable income of every individual (other than a surviving spouse as defined in section 2(a) or the head of a household as defined in section 2(b)) who is not a married individual (as defined in section 7703) a tax determined in accordance with the following:

  | If taxable income is:               | The tax is:                                    |
  |-------------------------------------|------------------------------------------------|
  | Not over \$22,100                   | 15% of taxable income.                         |
  | Over \$22,100 but not over \$53,500 | \$3,315, plus 28% of the excess over \$22,100. |

  | If taxable income is:                 | The tax is:                                        |
  |---------------------------------------|----------------------------------------------------|
  | Over \$53,500 but not over \$115,000  | \$12,107, plus 31% of the excess over \$53,500.    |
  | Over \$115,000 but not over \$250,000 | \$31,172, plus 36% of the excess over \$115,000.   |
  | Over \$250,000                        | \$79,772, plus 39.6% of the excess over \$250,000. |

<!-- BLOCK_SPLIT: tax computation for unmarried individuals -->
<!-- LAW_REF: section_1_c -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_1_c
```
```catala
scope IRCSimplified:
  # LAW: 1(c) - Unmarried individuals (other than surviving spouses and heads of households)
  # There is hereby imposed on the taxable income of every individual (other than a surviving spouse
  # as defined in section 2(a) or the head of a household as defined in section 2(b)) who is not a
  # married individual (as defined in section 7703) a tax determined in accordance with the tax table
  # Base case: Unmarried individual (not surviving spouse, not head of household, not married per section 7703)
  label section_1_c_base_case
  definition tax equals
    if taxable_income <= $22,100 then
      taxable_income * 15%
    else if taxable_income <= $53,500 then
      $3,315 + (taxable_income - $22,100) * 28%
    else if taxable_income <= $115,000 then
      $12,107 + (taxable_income - $53,500) * 31%
    else if taxable_income <= $250,000 then
      $31,172 + (taxable_income - $115,000) * 36%
    else
      $79,772 + (taxable_income - $250,000) * 39.6%
```

- (d) Married individuals filing separate returns

  There is hereby imposed on the taxable income of every married individual (as defined in section 7703) who does not make a single return jointly with his spouse, a tax determined in accordance with the following:

  | If taxable income is:                | The tax is:                                           |
  |--------------------------------------|-------------------------------------------------------|
  | Not over \$18,450                    | 15% of taxable income.                                |
  | Over \$18,450 but not over \$44,575  | \$2,767.50, plus 28% of the excess over \$18,450.     |
  | Over \$44,575 but not over \$70,000  | \$10,082.50, plus 31% of the excess over \$44,575.    |
  | Over \$70,000 but not over \$125,000 | \$17,964.25, plus 36% of the excess over \$70,000.    |
  | Over \$125,000                       | \$37,764.25, plus 39.6% of the excess over \$125,000. |

<!-- BLOCK_SPLIT: tax computation for married individuals filing separate returns -->
<!-- LAW_REF: section_1_d -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_1_d
```
```catala
scope IRCSimplified:
  # LAW: 1(d) - Married individuals filing separate returns
  # There is hereby imposed on the taxable income of every married individual (as defined in section 7703)
  # who does not make a single return jointly with his spouse, a tax determined in accordance with the tax table
  label section_1_d_exception exception section_1_c_base_case
  definition tax under condition
    taxpayer_marital_status.main_output.is_married_for_tax_purposes
    and (
      match individual_tax_return.details with pattern
      -- FilingStatusVariant.MarriedFilingSeparate content variant : true
      -- FilingStatusVariant.JointReturn content variant : false
      -- FilingStatusVariant.SurvivingSpouse content variant : false
      -- FilingStatusVariant.HeadOfHousehold content variant : false
      -- FilingStatusVariant.Single content variant : false
    )
  consequence equals
    if taxable_income <= $18,450 then
      taxable_income * 15%
    else if taxable_income <= $44,575 then
      $2,767.50 + (taxable_income - $18,450) * 28%
    else if taxable_income <= $70,000 then
      $10,082.50 + (taxable_income - $44,575) * 31%
    else if taxable_income <= $125,000 then
      $17,964.25 + (taxable_income - $70,000) * 36%
    else
      $37,764.25 + (taxable_income - $125,000) * 39.6%
```

- (a) Married individuals filing joint returns and surviving spouses

  There is hereby imposed on the taxable income of-

  - (1) every married individual (as defined in section 7703) who makes a single return jointly with his spouse, and

<!-- BLOCK_SPLIT: tax computation for married individuals filing joint returns -->
<!-- LAW_REF: section_1_a_1 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_1_a_1
```
```catala
scope IRCSimplified:
  # LAW: 1(a)(1) - Married individuals filing joint returns
  # There is hereby imposed on the taxable income of every married individual (as defined in section 7703)
  # who makes a single return jointly with his spouse, a tax determined in accordance with the tax table
  label section_1_a_1_exception exception section_1_d_exception
  definition tax under condition
    taxpayer_marital_status.main_output.is_married_for_tax_purposes
    and (
      match individual_tax_return.details with pattern
      -- FilingStatusVariant.JointReturn content variant : true
      -- FilingStatusVariant.SurvivingSpouse content variant : false
      -- FilingStatusVariant.HeadOfHousehold content variant : false
      -- FilingStatusVariant.Single content variant : false
      -- FilingStatusVariant.MarriedFilingSeparate content variant : false
    )
  consequence equals
    if taxable_income <= $36,900 then
      taxable_income * 15%
    else if taxable_income <= $89,150 then
      $5,535 + (taxable_income - $36,900) * 28%
    else if taxable_income <= $140,000 then
      $20,165 + (taxable_income - $89,150) * 31%
    else if taxable_income <= $250,000 then
      $35,928.50 + (taxable_income - $140,000) * 36%
    else
      $75,528.50 + (taxable_income - $250,000) * 39.6%
```

  - (2) every surviving spouse (as defined in section 2(a)),

    a tax determined in accordance with the following:

    | If taxable income is: | The tax is:            |
    |-----------------------|------------------------|
    | Not over \$36,900     | 15% of taxable income. |

    | If taxable income is:                 | The tax is:                                           |
    |---------------------------------------|-------------------------------------------------------|
    | Over \$36,900 but not over \$89,150   | \$5,535, plus 28% of the excess over \$36,900.        |
    | Over \$89,150 but not over \$140,000  | \$20,165, plus 31% of the excess over \$89,150.       |
    | Over \$140,000 but not over \$250,000 | \$35,928.50, plus 36% of the excess over \$140,000.   |
    | Over \$250,000                        | \$75,528.50, plus 39.6% of the excess over \$250,000. |

<!-- BLOCK_SPLIT: tax computation for surviving spouses -->
<!-- LAW_REF: section_1_a_2 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_1_a_2
```
```catala
scope IRCSimplified:
  # LAW: 1(a)(2) - Surviving spouses
  # There is hereby imposed on the taxable income of every surviving spouse (as defined in section 2(a)),
  # a tax determined in accordance with the tax table
  # Note: Surviving spouse uses the same tax table as joint returns
  label section_1_a_2_exception exception section_1_a_1_exception
  definition tax under condition
    is_surviving_spouse
  consequence equals
    if taxable_income <= $36,900 then
      taxable_income * 15%
    else if taxable_income <= $89,150 then
      $5,535 + (taxable_income - $36,900) * 28%
    else if taxable_income <= $140,000 then
      $20,165 + (taxable_income - $89,150) * 31%
    else if taxable_income <= $250,000 then
      $35,928.50 + (taxable_income - $140,000) * 36%
    else
      $75,528.50 + (taxable_income - $250,000) * 39.6%
```

<!-- BLOCK_SPLIT: subsection (a) - married individuals filing joint returns and surviving spouses -->
<!-- LAW_REF: section_1_a -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_1_a
```
```catala
scope IRCSimplified:
  # LAW: 1(a) - Married individuals filing joint returns and surviving spouses
  # There is hereby imposed on the taxable income of:
  # (1) every married individual (as defined in section 7703) who makes a single return jointly with his spouse, and
  # (2) every surviving spouse (as defined in section 2(a))
  # The tax is determined in accordance with the tax table
  # Note: Both (a)(1) and (a)(2) use the same tax table, implemented through exceptions above
  # The final tax value is already determined through the exception mechanism
```

- (b) Heads of households

  There is hereby imposed on the taxable income of every head of a household (as defined in section 2(b)) a tax determined in accordance with the following:

  | If taxable income is:                 | The tax is:                                        |
  |---------------------------------------|----------------------------------------------------|
  | Not over \$29,600                     | 15% of taxable income.                             |
  | Over \$29,600 but not over \$76,400   | \$4,440, plus 28% of the excess over \$29,600.     |
  | Over \$76,400 but not over \$127,500  | \$17,544, plus 31% of the excess over \$76,400.    |
  | Over \$127,500 but not over \$250,000 | \$33,385, plus 36% of the excess over \$127,500.   |
  | Over \$250,000                        | \$77,485, plus 39.6% of the excess over \$250,000. |

<!-- BLOCK_SPLIT: tax computation for heads of households -->
<!-- LAW_REF: section_1_b -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_1_b
```
```catala
scope IRCSimplified:
  # LAW: 1(b) - Heads of households
  # There is hereby imposed on the taxable income of every head of a household (as defined in section 2(b))
  # a tax determined in accordance with the tax table
  label section_1_b_exception exception section_1_a_2_exception
  definition tax under condition
    is_head_of_household
  consequence equals
    if taxable_income <= $29,600 then
      taxable_income * 15%
    else if taxable_income <= $76,400 then
      $4,440 + (taxable_income - $29,600) * 28%
    else if taxable_income <= $127,500 then
      $17,544 + (taxable_income - $76,400) * 31%
    else if taxable_income <= $250,000 then
      $33,385 + (taxable_income - $127,500) * 36%
    else
      $77,485 + (taxable_income - $250,000) * 39.6%
```


# Section 2 - Definitions and special rules
#============================= SECTION 2 =============================

2. Definitions and special rules


- (a) Definition of surviving spouse

  - (1) In general

    For purposes of section 1, the term "surviving spouse" means a taxpayer-

    - (A) whose spouse died during either of the two years immediately preceding the taxable year, and

<!-- BLOCK_SPLIT: spouse died in preceding two years -->
<!-- LAW_REF: section_2_a_1_A -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_a_1_A
```
```catala
scope IRCSimplified:
  # LAW: 2(a)(1)(A) - Spouse died during preceding two years
  # For purposes of section 1, the term "surviving spouse" means a taxpayer
  # whose spouse died during either of the two years immediately preceding the taxable year
  label section_2_a_1_A_spouse_died
  definition section_2_a_1_A_spouse_died_in_preceding_two_years equals
    let spouse_local equals get_spouse of individual_tax_return in
    match spouse_local with pattern
    -- Present content s :
      exists death_event among death_events
        such that death_event.decedent = s
        and Date.get_year of death_event.death_date >= individual_tax_return.tax_year - 2
        and Date.get_year of death_event.death_date < individual_tax_return.tax_year
    -- Absent : false
```

    - (B) who maintains as his home a household which constitutes for the taxable year the principal place of abode (as a member of such household) of a dependent (i) who (within the meaning of section 152) is a son, stepson, daughter, or stepdaughter of the taxpayer, and (ii) with respect to whom the taxpayer is entitled to a deduction for the taxable year under section 151.

      For purposes of this paragraph, an individual shall be considered as maintaining a household only if over half of the cost of maintaining the household during the taxable year is furnished by such individual.

<!-- BLOCK_SPLIT: section 2(a)(1)(B) - maintains household with dependent -->
<!-- LAW_REF: section_2_a_1_B -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_a_1_B
```
```catala
scope IRCSimplified:
  # LAW: 2(a)(1)(B) - Maintains household with dependent
  # Who maintains as his home a household which constitutes for the taxable year the principal place of abode
  # (as a member of such household) of a dependent (i) who (within the meaning of section 152) is a son, stepson,
  # daughter, or stepdaughter of the taxpayer, and (ii) with respect to whom the taxpayer is entitled to
  # a deduction for the taxable year under section 151
  # For purposes of this paragraph, an individual shall be considered as maintaining a household only if
  # over half of the cost of maintaining the household during the taxable year is furnished by such individual
  label section_2_a_1_B
  definition section_2_a_1_B_satisfied equals
    let taxpayer_local equals get_taxpayer of individual_tax_return in
    let year_end_local equals get_year_end of individual_tax_return.tax_year in
    match individual_tax_return.details with pattern
    -- FilingStatusVariant.SurvivingSpouse content variant :
      let dependent_is_son_stepson_daughter_stepdaughter_local equals
      exists parenthood_event among parenthood_events
        such that parenthood_event.parent = taxpayer_local
        and parenthood_event.child = variant.qualifying_dependent
        and parenthood_event.start_date <= year_end_local
        and (
          parenthood_event.parent_type = ParentType.Biological
          or parenthood_event.parent_type = ParentType.Step
        )
      in
      let dependent_has_principal_place_of_abode_in_taxpayer_household_local equals
      exists maintenance_event among household_maintenance_events
        such that maintenance_event.individual = taxpayer_local
        and maintenance_event.start_date <= year_end_local
        and maintenance_event.end_date >= Date.of_year_month_day of individual_tax_return.tax_year, 1, 1
        and maintenance_event.cost_furnished_percentage > 0.5
        and exists residence_event among residence_period_events
          such that residence_event.individual = variant.qualifying_dependent
          and residence_event.household = maintenance_event.household
          and residence_event.is_member_of_household
          and residence_event.is_principal_place_of_abode
          and residence_event.start_date <= year_end_local
          and residence_event.end_date >= Date.of_year_month_day of individual_tax_return.tax_year, 1, 1
      in
      let taxpayer_entitled_to_section151_deduction_for_dependent_local equals
        exists entitled_individual among taxpayer_exemptions_list_result.individuals_entitled_to_exemptions_under_151
          such that entitled_individual = variant.qualifying_dependent
      in
      dependent_is_son_stepson_daughter_stepdaughter_local
      and dependent_has_principal_place_of_abode_in_taxpayer_household_local
      and taxpayer_entitled_to_section151_deduction_for_dependent_local
    -- FilingStatusVariant.JointReturn content variant : false
    -- FilingStatusVariant.HeadOfHousehold content variant : false
    -- FilingStatusVariant.Single content variant : false
    -- FilingStatusVariant.MarriedFilingSeparate content variant : false
```

<!-- BLOCK_SPLIT: section 2(a)(1) - surviving spouse definition -->
<!-- LAW_REF: section_2_a_1 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_a_1
```
```catala
scope IRCSimplified:
  # LAW: 2(a)(1) - In general
  # For purposes of section 1, the term "surviving spouse" means a taxpayer-
  # (A) whose spouse died during either of the two years immediately preceding the taxable year, and
  # (B) who maintains as his home a household which constitutes for the taxable year the principal place of abode
  #     (as a member of such household) of a dependent (i) who (within the meaning of section 152) is a son, stepson,
  #     daughter, or stepdaughter of the taxpayer, and (ii) with respect to whom the taxpayer is entitled to
  #     a deduction for the taxable year under section 151
  label section_2_a_1_base_case
  definition is_surviving_spouse equals
    section_2_a_1_A_spouse_died_in_preceding_two_years
    and section_2_a_1_B_satisfied
```

  - (2) Limitations

    Notwithstanding paragraph (1), for purposes of section 1 a taxpayer shall not be considered to be a surviving spouse-

    - (A) if the taxpayer has remarried at any time before the close of the taxable year, or

<!-- BLOCK_SPLIT: taxpayer has remarried exception -->
<!-- LAW_REF: section_2_a_2_A -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_a_2_A
```
```catala
scope IRCSimplified:
  # LAW: 2(a)(2)(A) - Exception: Not surviving spouse if remarried
  # Notwithstanding paragraph (1), for purposes of section 1 a taxpayer shall not be considered to be a surviving spouse
  # if the taxpayer has remarried at any time before the close of the taxable year
  # A remarriage must occur after the spouse's death and before the close of the taxable year
  label section_2_a_2_A_remarried
  definition section_2_a_2_A_taxpayer_has_remarried equals
    let spouse_local equals get_spouse of individual_tax_return in
    let spouse_death_events_in_window_local equals
      section_2_spouse_death_events_in_window of spouse_local, death_events, individual_tax_return.tax_year
    in
    let most_recent_spouse_death_date_local equals
      section_2_most_recent_spouse_death_date of spouse_death_events_in_window_local, individual_tax_return.tax_year
    in
    exists remarriage_event among remarriage_events
      such that remarriage_event.individual = (get_taxpayer of individual_tax_return)
      and remarriage_event.remarriage_date > most_recent_spouse_death_date_local
      and remarriage_event.remarriage_date <= (get_year_end of individual_tax_return.tax_year)
```

    - (B) unless, for the taxpayer's taxable year during which his spouse died, a joint return could have been made. A husband and wife may make a single return jointly of income taxes, even though one of the spouses has neither gross income nor deductions, except that no joint return shall be made if either the husband or wife at any time during the taxable year is a nonresident alien.

<!-- BLOCK_SPLIT: joint return could have been made exception -->
<!-- LAW_REF: section_2_a_2_B -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_a_2_B
```
```catala
scope IRCSimplified:
  # LAW: 2(a)(2)(B) - Exception: Not surviving spouse unless joint return could have been made
  # Notwithstanding paragraph (1), for purposes of section 1 a taxpayer shall not be considered to be a surviving spouse
  # unless, for the taxpayer's taxable year during which his spouse died, a joint return could have been made
  # A husband and wife may make a single return jointly of income taxes, even though one of the spouses has neither
  # gross income nor deductions, except that no joint return shall be made if either the husband or wife at any time
  # during the taxable year is a nonresident alien
  # The legal text says "at any time during the taxable year" - meaning if either spouse was a nonresident alien at ANY point during that year
  # A residency event overlaps with the year if it starts before or on Dec 31 and ends on or after Jan 1
  label section_2_a_2_B_joint_return
  definition section_2_a_2_B_joint_return_could_have_been_made equals
    let spouse_local equals get_spouse of individual_tax_return in
    let taxpayer_local equals get_taxpayer of individual_tax_return in
    let spouse_death_events_in_window_local equals
      section_2_spouse_death_events_in_window of spouse_local, death_events, individual_tax_return.tax_year
    in
    let spouse_death_year_local equals
      section_2_spouse_death_year of spouse_death_events_in_window_local
    in
    match spouse_death_year_local with pattern
    -- Present content death_year :
      # Joint return can be made if neither spouse was a nonresident alien at any time during the death year
      not (
        exists residency_event_taxpayer among nonresident_alien_status_period_events
          such that residency_event_taxpayer.individual = taxpayer_local
          and residency_event_taxpayer.residency_status = ResidencyStatus.NonresidentAlien
          and residency_event_taxpayer.start_date <= Date.of_year_month_day of death_year, 12, 31
          and residency_event_taxpayer.end_date >= Date.of_year_month_day of death_year, 1, 1
      )
      and not (
        match spouse_local with pattern
        -- Present content s :
          exists residency_event_spouse among nonresident_alien_status_period_events
            such that residency_event_spouse.individual = s
            and residency_event_spouse.residency_status = ResidencyStatus.NonresidentAlien
            and residency_event_spouse.start_date <= Date.of_year_month_day of death_year, 12, 31
            and residency_event_spouse.end_date >= Date.of_year_month_day of death_year, 1, 1
        -- Absent : false
      )
    -- Absent : false
```

<!-- BLOCK_SPLIT: section 2(a)(2) - limitations -->
<!-- LAW_REF: section_2_a_2 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_a_2
```
```catala
scope IRCSimplified:
  # LAW: 2(a)(2) - Limitations
  # Notwithstanding paragraph (1), for purposes of section 1 a taxpayer shall not be considered to be a surviving spouse-
  # (A) if the taxpayer has remarried at any time before the close of the taxable year, or
  # (B) unless, for the taxpayer's taxable year during which his spouse died, a joint return could have been made
  # Exception: Not surviving spouse if remarried
  exception section_2_a_1_base_case
  definition is_surviving_spouse under condition
      section_2_a_2_A_taxpayer_has_remarried
  consequence equals false

  # Exception: Not surviving spouse unless joint return could have been made
  exception section_2_a_1_base_case
  definition is_surviving_spouse under condition
      not section_2_a_2_B_joint_return_could_have_been_made
  consequence equals false
```

<!-- BLOCK_SPLIT: section 2(a) - definition of surviving spouse -->
<!-- LAW_REF: section_2_a -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_a
```
```catala
scope IRCSimplified:
  # LAW: 2(a) - Definition of surviving spouse
  # The final value is already determined through the exception mechanism above
```


- (b) Definition of head of household

  - (1) In general

    An individual shall be considered a head of a household if, and only if, such individual is not married at the close of his taxable year, is not a surviving spouse (as defined in subsection (a)), and either-

    - (A) maintains as his home a household which constitutes for more than one-half of such taxable year the principal place of abode, as a member of such household, of-

      - (i) a qualifying child of the individual (as defined in section 152(c)), but not if such child-

        - (I) is married at the close of the taxpayer's taxable year, and

<!-- BLOCK_SPLIT: qualifying child is married at close of year -->
<!-- LAW_REF: section_2_b_1_A_i_I -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_b_1_A_i_I
```
```catala
scope IRCSimplified:
  # LAW: 2(b)(1)(A)(i)(I) - Child married at close of year
  # But not if such child is married at the close of the taxpayer's taxable year
  label section_2_b_1_A_i_I_married
  definition section_2_b_1_A_i_I_qualifying_child_is_married_at_close_of_year equals
    let year_end_local equals get_year_end of individual_tax_return.tax_year in
    match individual_tax_return.details with pattern
    -- FilingStatusVariant.HeadOfHousehold content variant :
        exists marriage_event among marriage_events
        such that (marriage_event.spouse1 = variant.qualifying_person or marriage_event.spouse2 = variant.qualifying_person)
          and marriage_event.marriage_date <= year_end_local
          and not (
            exists divorce_event among divorce_or_legal_separation_events
            such that (divorce_event.person1 = variant.qualifying_person or divorce_event.person2 = variant.qualifying_person)
              and divorce_event.decree_date > marriage_event.marriage_date
              and divorce_event.decree_date <= year_end_local
          )
    -- FilingStatusVariant.JointReturn content variant : false
    -- FilingStatusVariant.SurvivingSpouse content variant : false
    -- FilingStatusVariant.Single content variant : false
    -- FilingStatusVariant.MarriedFilingSeparate content variant : false
```

      - (II) is not a dependent of such individual by reason of section 152(b)(2) or

<!-- BLOCK_SPLIT: qualifying person not dependent by 152(b)(2) -->
<!-- LAW_REF: section_2_b_1_A_i_II -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_b_1_A_i_II
```
```catala
scope IRCSimplified:
  # LAW: 2(b)(1)(A)(i)(II) - Not dependent by reason of section 152(b)(2)
  # But not if such child is not a dependent of such individual by reason of section 152(b)(2)
  # Section 152(b)(2): An individual shall not be treated as a dependent if such individual
  # has made a joint return with the individual's spouse for the taxable year
  # Note: Check if they were in dependents after 152(b)(1) but excluded by 152(b)(2)
  # (i.e., they filed a joint return)
  label section_2_b_1_A_i_II_not_dependent
  definition section_2_b_1_A_i_II_qualifying_person_not_dependent_by_152b2 equals
    match individual_tax_return.details with pattern
    -- FilingStatusVariant.HeadOfHousehold content variant :
      # Check if they were in dependents after 152(b)(1) but not in final state (after 152(b)(2))
      # This means they were excluded specifically by section 152(b)(2) - filed joint return
      exists dependent_individual among taxpayer_dependents_result.dependents_after_152b1
        such that dependent_individual = variant.qualifying_person
        and not (
          exists dependent_individual_final among taxpayer_dependents_result.dependents_after_152b2
            such that dependent_individual_final = variant.qualifying_person
        )
    -- FilingStatusVariant.JointReturn content variant : false
    -- FilingStatusVariant.SurvivingSpouse content variant : false
    -- FilingStatusVariant.Single content variant : false
    -- FilingStatusVariant.MarriedFilingSeparate content variant : false
```

    - (i) a qualifying child of the individual (as defined in section 152(c)), but not if such child-

<!-- BLOCK_SPLIT: section 2(b)(1)(A)(i) - qualifying child -->
<!-- LAW_REF: section_2_b_1_A_i -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_b_1_A_i
```
```catala
scope IRCSimplified:
  # LAW: 2(b)(1)(A)(i) - Qualifying child
  # A qualifying child of the individual (as defined in section 152(c)), but not if such child-
  # (I) is married at the close of the taxpayer's taxable year, and
  # (II) is not a dependent of such individual by reason of section 152(b)(2)
  # LAW: 2(b)(1)(A)(i) - Qualifying child requirement satisfied
  # A qualifying child of the individual (as defined in section 152(c)), but not if such child-
  # (I) is married at the close of the taxpayer's taxable year, and
  # (II) is not a dependent of such individual by reason of section 152(b)(2)
  label section_2_b_1_A_i_satisfied
  definition section_2_b_1_A_i_satisfied equals
    match individual_tax_return.details with pattern
    -- FilingStatusVariant.HeadOfHousehold content variant :
      let qualifying_person_is_qualifying_child_local equals
        # Section 152(c) - Check if qualifying_person is a qualifying child of the taxpayer
        let result equals
          output of IndividualSection152QualifyingChild with {
            -- individual: variant.qualifying_person
            -- taxpayer: (get_taxpayer of individual_tax_return)
            -- tax_year: individual_tax_return.tax_year
            -- family_relationship_events: family_relationship_events
            -- birth_events: birth_events
            -- residence_period_events: residence_period_events
            -- tax_return_events: tax_return_events
          }
        in
        result.main_output.is_qualifying_child
      in
      qualifying_person_is_qualifying_child_local
      and not (
        section_2_b_1_A_i_I_qualifying_child_is_married_at_close_of_year
        and section_2_b_1_A_i_II_qualifying_person_not_dependent_by_152b2
      )
    -- FilingStatusVariant.JointReturn content variant : false
    -- FilingStatusVariant.SurvivingSpouse content variant : false
    -- FilingStatusVariant.Single content variant : false
    -- FilingStatusVariant.MarriedFilingSeparate content variant : false
```

      - (ii) any other person who is a dependent of the  taxpayer,if the taxpayer is entitled to a deduction for the taxable year for such person under section 151, or

<!-- BLOCK_SPLIT: qualifying person satisfies 2(b)(1)(A)(ii) -->
<!-- LAW_REF: section_2_b_1_A_ii -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_b_1_A_ii
```
```catala
scope IRCSimplified:
  # LAW: 2(b)(1)(A)(ii) - Other dependent
  # Any other person who is a dependent of the taxpayer, if the taxpayer is entitled to a deduction
  # for the taxable year for such person under section 151
  label section_2_b_1_A_ii_satisfied
  definition section_2_b_1_A_ii_satisfied equals
    match individual_tax_return.details with pattern
    -- FilingStatusVariant.HeadOfHousehold content variant :
      # Check if qualifying_person is a dependent (section 152)
      (
        exists dependent_individual among taxpayer_dependents_result.dependents_after_152b2
          such that dependent_individual = variant.qualifying_person
      )
      # Check if taxpayer is entitled to Section 151 deduction for qualifying_person
      # Section 2(b)(1)(A)(ii): "if the taxpayer is entitled to a deduction for the taxable year for such person under section 151"
      and (
        exists entitled_individual among taxpayer_exemptions_list_result.individuals_entitled_to_exemptions_under_151
          such that entitled_individual = variant.qualifying_person
      )
    -- FilingStatusVariant.JointReturn content variant : false
    -- FilingStatusVariant.SurvivingSpouse content variant : false
    -- FilingStatusVariant.Single content variant : false
    -- FilingStatusVariant.MarriedFilingSeparate content variant : false
```

<!-- BLOCK_SPLIT: section 2(b)(1)(A) - maintains household with qualifying person -->
<!-- LAW_REF: section_2_b_1_A -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_b_1_A
```
```catala
scope IRCSimplified:
  # LAW: 2(b)(1)(A) - Maintains household with qualifying person
  # Maintains as his home a household which constitutes for more than one-half of such taxable year
  # the principal place of abode, as a member of such household, of-
  # (i) a qualifying child of the individual (as defined in section 152(c)), but not if such child-
  #     (I) is married at the close of the taxpayer's taxable year, and
  #     (II) is not a dependent of such individual by reason of section 152(b)(2) or
  # (ii) any other person who is a dependent of the taxpayer, if the taxpayer is entitled to a deduction
  #      for the taxable year for such person under section 151
  # For purposes of this paragraph, an individual shall be considered as maintaining a household only if
  # over half of the cost of maintaining the household during the taxable year is furnished by such individual
  label section_2_b_1_A
  definition section_2_b_1_A_satisfied equals
    let taxpayer_local equals get_taxpayer of individual_tax_return in
    let year_end_local equals get_year_end of individual_tax_return.tax_year in
    let qualifying_person_has_principal_place_of_abode_more_than_half_year_local equals
    match individual_tax_return.details with pattern
    -- FilingStatusVariant.HeadOfHousehold content variant :
      exists maintenance_event among household_maintenance_events
        such that maintenance_event.individual = taxpayer_local
        and maintenance_event.start_date <= year_end_local
        and maintenance_event.end_date >= Date.of_year_month_day of individual_tax_return.tax_year, 1, 1
        and maintenance_event.cost_furnished_percentage > 0.5
        and exists residence_event among residence_period_events
          such that residence_event.individual = variant.qualifying_person
          and residence_event.household = maintenance_event.household
          and residence_event.is_member_of_household
          and residence_event.is_principal_place_of_abode
          and residence_event.start_date <= Date.of_year_month_day of individual_tax_return.tax_year, 6, 30
          and residence_event.end_date >= Date.of_year_month_day of individual_tax_return.tax_year, 7, 1
    -- FilingStatusVariant.JointReturn content variant : false
    -- FilingStatusVariant.SurvivingSpouse content variant : false
    -- FilingStatusVariant.Single content variant : false
    -- FilingStatusVariant.MarriedFilingSeparate content variant : false
    in
    qualifying_person_has_principal_place_of_abode_more_than_half_year_local
    and (
      section_2_b_1_A_i_satisfied
      or section_2_b_1_A_ii_satisfied
    )
```

    - (B) maintains a household which constitutes for such taxable year the principal place of abode of the father or mother of the taxpayer, if the taxpayer is entitled to a deduction for the taxable year for such father or mother under section 151.

      For purposes of this paragraph, an individual shall be considered as maintaining a household only if over half of the cost of maintaining the household during the taxable year is furnished by such individual.

<!-- BLOCK_SPLIT: section 2(b)(1)(B) - father or mother -->
<!-- LAW_REF: section_2_b_1_B -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_b_1_B
```
```catala
scope IRCSimplified:
  # LAW: 2(b)(1)(B) - Father or mother
  # Maintains a household which constitutes for such taxable year the principal place of abode of the father or mother
  # of the taxpayer, if the taxpayer is entitled to a deduction for the taxable year for such father or mother under section 151
  # For purposes of this paragraph, an individual shall be considered as maintaining a household only if
  # over half of the cost of maintaining the household during the taxable year is furnished by such individual
  label section_2_b_1_B
  definition section_2_b_1_B_satisfied equals
    let taxpayer_local equals get_taxpayer of individual_tax_return in
    let year_end_local equals get_year_end of individual_tax_return.tax_year in
    match individual_tax_return.details with pattern
    -- FilingStatusVariant.HeadOfHousehold content variant :
      let qualifying_person_is_father_or_mother_local equals
      exists parenthood_event among parenthood_events
        such that parenthood_event.parent = variant.qualifying_person
        and parenthood_event.child = taxpayer_local
        and parenthood_event.start_date <= year_end_local
        and (
          parenthood_event.parent_type = ParentType.Biological
          or parenthood_event.parent_type = ParentType.Adoptive
        )
      in
      let father_or_mother_has_principal_place_of_abode_local equals
      exists maintenance_event among household_maintenance_events
        such that maintenance_event.individual = taxpayer_local
        and maintenance_event.start_date <= year_end_local
        and maintenance_event.end_date >= Date.of_year_month_day of individual_tax_return.tax_year, 1, 1
        and maintenance_event.cost_furnished_percentage > 0.5
        and exists residence_event among residence_period_events
          such that residence_event.individual = variant.qualifying_person
          and residence_event.household = maintenance_event.household
          and residence_event.is_principal_place_of_abode
          and residence_event.start_date <= year_end_local
          and residence_event.end_date >= Date.of_year_month_day of individual_tax_return.tax_year, 1, 1
            and qualifying_person_is_father_or_mother_local
      in
      let taxpayer_entitled_to_section151_for_father_or_mother_local equals
        exists entitled_individual among taxpayer_exemptions_list_result.individuals_entitled_to_exemptions_under_151
          such that entitled_individual = variant.qualifying_person
      in
      father_or_mother_has_principal_place_of_abode_local
      and taxpayer_entitled_to_section151_for_father_or_mother_local
    -- FilingStatusVariant.JointReturn content variant : false
    -- FilingStatusVariant.SurvivingSpouse content variant : false
    -- FilingStatusVariant.Single content variant : false
    -- FilingStatusVariant.MarriedFilingSeparate content variant : false
```


  - (2) Determination of status

    Notwithstanding paragraph (1),

    - (A) an individual who is legally separated from his spouse under a decree of divorce or of separate maintenance shall not be considered as married;

    - (B) a taxpayer shall be considered as not married at the close of his taxable year if at any time during the taxable year his spouse is a nonresident alien; and

    - (C) a taxpayer shall be considered as married at the close of his taxable year if his spouse (other than a spouse described in subparagraph (B)) died during the taxable year.

<!-- BLOCK_SPLIT: taxpayer is married at close of year -->
<!-- LAW_REF: section_2_b_2 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_b_2
```
```catala
scope IRCSimplified:
  # LAW: 2(b)(2) - Determination of status
  # Notwithstanding paragraph (1),
  # (A) an individual who is legally separated from his spouse under a decree of divorce or of separate maintenance shall not be considered as married;
  # (B) a taxpayer shall be considered as not married at the close of his taxable year if at any time during the taxable year his spouse is a nonresident alien; and
  # (C) a taxpayer shall be considered as married at the close of his taxable year if his spouse (other than a spouse described in subparagraph (B)) died during the taxable year
  label section_2_b_2_marital_status
  definition section_2_b_2_is_married_at_close_of_year equals
    let spouse_local equals get_spouse of individual_tax_return in
    let taxpayer_local equals get_taxpayer of individual_tax_return in
    let year_end_local equals get_year_end of individual_tax_return.tax_year in
    match spouse_local with pattern
    -- Present content s :
      # Section 2(b)(2)(A): Legally separated not considered married
      if exists divorce_event among divorce_or_legal_separation_events
          such that (divorce_event.person1 = taxpayer_local or divorce_event.person2 = taxpayer_local)
          and (divorce_event.person1 = s or divorce_event.person2 = s)
          and divorce_event.decree_date <= year_end_local then
        false
      # Section 2(b)(2)(B): Not married if spouse is nonresident alien
      else if exists residency_event among nonresident_alien_status_period_events
          such that residency_event.individual = s
          and residency_event.start_date <= year_end_local
          and residency_event.end_date >= Date.of_year_month_day of individual_tax_return.tax_year, 1, 1
          and residency_event.residency_status = ResidencyStatus.NonresidentAlien then
        false
      # Section 2(b)(2)(C): Married if spouse died during taxable year (unless nonresident alien)
      else if exists death_event among death_events
          such that death_event.decedent = s
          and Date.get_year of death_event.death_date = individual_tax_return.tax_year
          and not (
            exists residency_event among nonresident_alien_status_period_events
              such that residency_event.individual = s
              and residency_event.start_date <= death_event.death_date
              and residency_event.end_date >= Date.of_year_month_day of individual_tax_return.tax_year, 1, 1
              and residency_event.residency_status = ResidencyStatus.NonresidentAlien
          ) then
        true
      # Default: Check if there's a marriage event
      else
      exists marriage_event among marriage_events
          such that (marriage_event.spouse1 = taxpayer_local or marriage_event.spouse2 = taxpayer_local)
          and (marriage_event.spouse1 = s or marriage_event.spouse2 = s)
        and marriage_event.marriage_date <= year_end_local
        and not (
          exists divorce_event among divorce_or_legal_separation_events
              such that (divorce_event.person1 = taxpayer_local or divorce_event.person2 = taxpayer_local)
              and (divorce_event.person1 = s or divorce_event.person2 = s)
            and divorce_event.decree_date > marriage_event.marriage_date
            and divorce_event.decree_date <= year_end_local
        )
    -- Absent : false
```

<!-- BLOCK_SPLIT: section 2(b)(1) - head of household definition -->
<!-- LAW_REF: section_2_b_1 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_b_1
```
```catala
scope IRCSimplified:
  # LAW: 2(b)(1) - In general
  # An individual shall be considered a head of a household if, and only if, such individual is not married at the close
  # of his taxable year, is not a surviving spouse (as defined in subsection (a)), and either (A) or (B) conditions are met
  label section_2_b_1_base_case
  definition is_head_of_household equals
    not section_2_b_2_is_married_at_close_of_year
    and not is_surviving_spouse
    and (
      section_2_b_1_A_satisfied
      or section_2_b_1_B_satisfied
    )
```

  - (3) Limitations

    Notwithstanding paragraph (1), for purposes of this subtitle a taxpayer shall not be considered to be a head of a household-

    - (A) if at any time during the taxable year he is a nonresident alien; or

<!-- BLOCK_SPLIT: section 2(b)(3)(A) - nonresident alien exception -->
<!-- LAW_REF: section_2_b_3_A -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_b_3_A
```
```catala
scope IRCSimplified:
  # LAW: 2(b)(3)(A) - Exception: Not head of household if nonresident alien
  # Notwithstanding paragraph (1), for purposes of this subtitle a taxpayer shall not be considered to be a head of a household
  # if at any time during the taxable year he is a nonresident alien
  # LAW: 2(b)(3)(A) - Exception: Not head of household if nonresident alien
  # Notwithstanding paragraph (1), for purposes of this subtitle a taxpayer shall not be considered to be a head of a household
  # if at any time during the taxable year he is a nonresident alien
  label section_2_b_3_A_nonresident_alien
  exception section_2_b_1_base_case
  definition is_head_of_household under condition
    let taxpayer_local equals get_taxpayer of individual_tax_return in
    let year_end_local equals get_year_end of individual_tax_return.tax_year in
    exists residency_event among nonresident_alien_status_period_events
      such that residency_event.individual = taxpayer_local
      and residency_event.start_date <= year_end_local
      and residency_event.end_date >= Date.of_year_month_day of individual_tax_return.tax_year, 1, 1
      and residency_event.residency_status = ResidencyStatus.NonresidentAlien
  consequence equals false
```

    - (B) by reason of an individual who would not be a dependent for the taxable year but for subparagraph (H) of section 152(d)(2).

<!-- BLOCK_SPLIT: section 2(b)(3)(B) - exception for 152(d)(2)(H) -->
<!-- LAW_REF: section_2_b_3_B -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_b_3_B
```
```catala
scope IRCSimplified:
  # LAW: 2(b)(3)(B) - Exception: Not head of household by reason of individual who would not be dependent but for section 152(d)(2)(H)
  # Notwithstanding paragraph (1), for purposes of this subtitle a taxpayer shall not be considered to be a head of a household
  # by reason of an individual who would not be a dependent for the taxable year but for subparagraph (H) of section 152(d)(2)
  # This means: if the qualifying person is used to satisfy option (A)(ii) and they only qualify
  # as a dependent because of relationship requirement (H) (not because of relationships A-G),
  # then the taxpayer cannot be head of household
  exception section_2_b_1_base_case
  definition is_head_of_household under condition
    match individual_tax_return.details with pattern
    -- FilingStatusVariant.HeadOfHousehold content variant :
      # Check if the qualifying person would NOT be a dependent but for section 152(d)(2)(H)
      # This means: they are a qualifying relative, but they only meet the relationship requirement through (H)
      # (not through relationships A-G)
      exists result among taxpayer_dependents_result.qualifying_relatives
        such that result.individual = variant.qualifying_person
        and result.taxpayer = (get_taxpayer of individual_tax_return)
        and result.is_qualifying_relative
        # They would NOT meet the relationship requirement but for (H)
        # This means: relationship_requirement_met is false (they don't meet A-G)
        # but relationship_requirement_met_H is true (they only meet H)
        and not result.relationship_requirement_met
        and result.relationship_requirement_met_H
    -- FilingStatusVariant.JointReturn content variant : false
    -- FilingStatusVariant.SurvivingSpouse content variant : false
    -- FilingStatusVariant.Single content variant : false
    -- FilingStatusVariant.MarriedFilingSeparate content variant : false
  consequence equals false
```


<!-- BLOCK_SPLIT: section 2(b) - definition of head of household -->
<!-- LAW_REF: section_2_b -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_2_b
```
```catala
scope IRCSimplified:
  # LAW: 2(b) - Definition of head of household
  # The final value is already determined through the exception mechanism above
```


# Section 151 - Allowance of deductions for personal exemptions
#============================= SECTION 151 =============================

<!-- BLOCK_SPLIT: subscope call for IndividualSection151Exemption -->
<!-- LAW_REF: section_151 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_151
```
```catala
scope IRCSimplified:
  # First: Call TaxpayerExemptionsList to compute exemptions list for taxpayer (and spouse if joint return)
  definition taxpayer_exemptions_list.individual_tax_return equals
    individual_tax_return
  definition taxpayer_exemptions_list.tax_return_events equals
    tax_return_events
  definition taxpayer_exemptions_list.income_events equals
    income_events
  definition taxpayer_exemptions_list.dependents equals
    taxpayer_dependents_result.dependents_after_152b2
  definition taxpayer_exemptions_list_result equals
    taxpayer_exemptions_list.main_output
  
  # Second: Call IndividualSection151Exemption to compute exemption amounts for taxpayer (with applicable_amount)
  definition taxpayer_exemption.individual equals
    get_taxpayer of individual_tax_return
  definition taxpayer_exemption.individual_tax_return equals
    individual_tax_return
  definition taxpayer_exemption.tax_year equals
    individual_tax_return.tax_year
  definition taxpayer_exemption.tax_return_events equals
    tax_return_events
  definition taxpayer_exemption.adjusted_gross_income equals
    adjusted_gross_income
  definition taxpayer_exemption.applicable_amount equals
    applicable_amount
  definition taxpayer_exemption.individuals_entitled_to_exemptions_under_151 equals
    taxpayer_exemptions_list_result.individuals_entitled_to_exemptions_under_151
  definition taxpayer_exemption_result equals
    taxpayer_exemption.main_output
```

<!-- BLOCK_SPLIT: scope definition for IndividualSection151Exemption -->
<!-- LAW_REF: section_151 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_151
```
```catala
scope IndividualSection151ExemptionsList:
  # LAW: 151 - Final output for exemptions list computation
  definition main_output equals
    IndividualSection151ExemptionsListOutput {
      -- individual: individual
      -- spouse_personal_exemption_allowed: spouse_personal_exemption_allowed
      -- individuals_entitled_to_exemptions_under_151: individuals_entitled_to_exemptions_under_151
    }
```

<!-- BLOCK_SPLIT: scope definition for IndividualSection151Exemption -->
<!-- LAW_REF: section_151 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_151
```
```catala
scope IndividualSection151Exemption:
  # LAW: 151 - Final output for exemption computation
  definition main_output equals
    IndividualSection151ExemptionOutput {
      -- individual: individual
      -- exemption_amount_base: exemption_amount state base
      -- exemption_amount_after_disallowance: exemption_amount state after_disallowance
      -- exemption_amount_after_phaseout: exemption_amount state after_phaseout
      -- number_of_personal_exemptions: number_of_personal_exemptions
      -- personal_exemptions_deduction: personal_exemptions_deduction
      -- applicable_percentage: applicable_percentage
    }
```

<!-- BLOCK_SPLIT: section 151(d)(1) - In general -->
<!-- LAW_REF: section_151_d_1 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_151_d_1
```
```catala
scope IndividualSection151Exemption:
  # LAW: 151(d)(1) - In general
  # Except as otherwise provided in this subsection, the term "exemption amount" means $2,000.
  label section_151_d_1_general_rule
  definition exemption_amount state base equals $2,000
```

- (2) Exemption amount disallowed in case of certain dependents

  In the case of an individual with respect to whom a deduction under this section is allowable to another taxpayer for a taxable year beginning in the calendar year in which the individual's taxable year begins, the exemption amount applicable to such individual for such individual's taxable year shall be zero.

<!-- BLOCK_SPLIT: section 151(d)(2) - Exemption amount disallowed -->
<!-- LAW_REF: section_151_d_2 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_151_d_2
```
```catala
scope IndividualSection151Exemption: 
  # LAW: 151(d)(2) - Exemption amount disallowed in case of certain dependents
  # In the case of an individual with respect to whom a deduction under this section is allowable
  # to another taxpayer for a taxable year beginning in the calendar year in which the individual's
  # taxable year begins, the exemption amount applicable to such individual for such individual's
  # taxable year shall be zero.
  label section_151_d_2_disallowance
  definition exemption_amount state after_disallowance equals
    let taxpayer_is_dependent_of_another equals
      exists event among tax_return_events
        such that event.individual != individual
        and event.tax_year = tax_year
        and exists dependent among event.dependents such that dependent = individual
    in
    if taxpayer_is_dependent_of_another then
      $0
    else
      exemption_amount
```

- (3) Phaseout

  - (A) In general

    In the case of any taxpayer whose adjusted gross income for the taxable year exceeds the applicable amount in effect under section 68(b), the exemption amount shall be reduced by the applicable percentage.

  - (B) Applicable percentage

    For purposes of subparagraph (A), the term "applicable percentage" means 2 percentage points for each $2,500 (or fraction thereof) by which the taxpayer's adjusted gross income for the taxable year exceeds the applicable amount in effect under section 68(b). In the case of a married individual filing a separate return, the preceding sentence shall be applied by substituting "$1,250" for "$2,500". In no event shall the applicable percentage exceed 100 percent.

<!-- BLOCK_SPLIT: section 151(d)(3)(B) - Applicable percentage -->
<!-- LAW_REF: section_151_d_3_B -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_151_d_3_B
```
```catala
scope IndividualSection151Exemption:
  # LAW: 151(d)(3)(B) - Applicable percentage
  # 2 percentage points for each $2,500 (or fraction thereof) by which AGI exceeds applicable amount
  # For married filing separate: substitute "$1,250" for "$2,500"
  # In no event shall the applicable percentage exceed 100 percent
  label section_151_d_3_B_applicable_percentage
  definition applicable_percentage equals
    if adjusted_gross_income > applicable_amount then
      let excess_agi equals adjusted_gross_income - applicable_amount in
      let threshold equals
    match individual_tax_return.details with pattern
        -- FilingStatusVariant.MarriedFilingSeparate content variant : $1,250
        -- anything : $2,500
      in
      let excess_decimal equals decimal of excess_agi in
      let threshold_decimal equals decimal of threshold in
      let fraction_count_decimal equals excess_decimal / threshold_decimal in
      let fraction_count equals
        if fraction_count_decimal > decimal of (integer of fraction_count_decimal) then
          decimal of ((integer of fraction_count_decimal) + 1)
        else
          decimal of (integer of fraction_count_decimal)
      in
      Decimal.min of (fraction_count * 2%), 100%
    else
      0%
```

<!-- BLOCK_SPLIT: section 151(d)(3)(A) - Phaseout reduction -->
<!-- LAW_REF: section_151_d_3_A -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_151_d_3_A
```
```catala
scope IndividualSection151Exemption:
  # LAW: 151(d)(3)(A) - In general
  # In the case of any taxpayer whose adjusted gross income for the taxable year exceeds
  # the applicable amount in effect under section 68(b), the exemption amount shall be
  # reduced by the applicable percentage.
  label section_151_d_3_A_phaseout
  definition exemption_amount state after_phaseout equals
    if adjusted_gross_income > applicable_amount then
      let reduction equals money of ((decimal of exemption_amount) * applicable_percentage) in
      exemption_amount - reduction
    else
      exemption_amount
```

- (5) Special rules for taxable years 2018 through 2025

  In the case of a taxable year beginning after December 31, 2017, and before January 1, 2026, the term "exemption amount" means zero.

<!-- BLOCK_SPLIT: section 151(d)(5) - Special rules for 2018-2025 -->
<!-- LAW_REF: section_151_d_5 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_151_d_5
```
```catala
scope IndividualSection151Exemption:
  # LAW: 151(d)(5) - Special rules for taxable years 2018 through 2025
  # In the case of a taxable year beginning after December 31, 2017, and before January 1, 2026,
  # the term "exemption amount" means zero.
  label section_151_d_5_2018_2025_exception
  exception section_151_d_3_A_phaseout
  definition exemption_amount state after_phaseout under condition
    is_tax_year_2018_through_2025 of tax_year
  consequence equals $0
```

<!-- BLOCK_SPLIT: section 151(d) - Final exemption amount -->
<!-- LAW_REF: section_151_d -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_151_d
```
```catala
scope IndividualSection151Exemption:
  # LAW: 151(d) - Exemption amount (final)
  # The exemption amount after all modifications
  # Note: The final value is exemption_amount state after_phaseout, which is already the final state
```

- (b) Taxpayer and spouse

  An exemption of the exemption amount for the taxpayer; and an additional exemption of the exemption amount for the spouse of the taxpayer if a joint return is not made by the taxpayer and his spouse, and if the spouse, for the calendar year in which the taxable year of the taxpayer begins, has no gross income and is not the dependent of another taxpayer.

<!-- BLOCK_SPLIT: section 151(b) - Taxpayer and spouse -->
<!-- LAW_REF: section_151_b -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_151_b
```
```catala
scope IndividualSection151ExemptionsList:
  # LAW: 151(b) - Taxpayer and spouse
  # An exemption of the exemption amount for the taxpayer; and an additional exemption of the
  # exemption amount for the spouse of the taxpayer if a joint return is not made by the taxpayer
  # and his spouse, and if the spouse, for the calendar year in which the taxable year of the
  # taxpayer begins, has no gross income and is not the dependent of another taxpayer.
  label section_151_b_taxpayer_and_spouse
  definition spouse_personal_exemption_allowed equals
    if is_joint_or_surviving_spouse then
      false
    else
      match spouse with pattern
      -- Present content s :
        let spouse_has_no_income equals
          not (
            exists income_event among income_events
              such that income_event.individual = s
              and income_event.tax_year = tax_year
              and income_event.has_income
          )
        in
        let spouse_is_not_dependent_of_another equals
          not (
            exists event among tax_return_events
              such that event.individual != individual
              and event.tax_year = tax_year
              and exists dependent among event.dependents such that dependent = s
          )
        in
        spouse_has_no_income and spouse_is_not_dependent_of_another
      -- Absent : false
```

- (c) Additional exemption for dependents

  An exemption of the exemption amount for each individual who is a dependent (as defined in section 152) of the taxpayer for the taxable year.

<!-- BLOCK_SPLIT: section 151(c) - Additional exemption for dependents -->
<!-- LAW_REF: section_151_c -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_151_c
```
```catala
scope IndividualSection151ExemptionsList:
  # LAW: 151 - Individuals entitled to exemptions
  # List of all individuals entitled to exemptions under section 151:
  # - Individual (always)
  # - Spouse (if spouse_personal_exemption_allowed)
  # - Dependents (from dependents list)
  label section_151_individuals_entitled_to_exemptions
  definition individuals_entitled_to_exemptions_under_151 equals
    let individual_list equals [individual] in
    let spouse_list equals
      match spouse with pattern
      -- Present content s :
        if spouse_personal_exemption_allowed then [s] else []
      -- Absent : []
    in
    individual_list ++ spouse_list ++ dependents
```

<!-- BLOCK_SPLIT: scope definition for TaxpayerExemptionsList -->
<!-- LAW_REF: section_151 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_151
```
```catala
scope TaxpayerExemptionsList:
  # Call IndividualSection151ExemptionsList for taxpayer
  definition taxpayer_exemptions.individual equals
    get_taxpayer of individual_tax_return
  definition taxpayer_exemptions.spouse equals
    get_spouse of individual_tax_return
  definition taxpayer_exemptions.tax_year equals
    individual_tax_return.tax_year
  definition taxpayer_exemptions.tax_return_events equals
    tax_return_events
  definition taxpayer_exemptions.income_events equals
    income_events
  definition taxpayer_exemptions.dependents equals
    dependents
  definition taxpayer_exemptions.is_joint_or_surviving_spouse equals
    match individual_tax_return.details with pattern
    -- FilingStatusVariant.JointReturn content variant : true
    -- FilingStatusVariant.SurvivingSpouse content variant : true
    -- FilingStatusVariant.HeadOfHousehold content variant : false
    -- FilingStatusVariant.Single content variant : false
    -- FilingStatusVariant.MarriedFilingSeparate content variant : false

  # If joint return or surviving spouse, also call for spouse
  definition spouse_result equals
    match individual_tax_return.details with pattern
    -- FilingStatusVariant.JointReturn content variant :
      let spouse_local equals get_spouse of individual_tax_return in
      let spouse_result_inner equals
        match spouse_local with pattern
        -- Present content s :
          let taxpayer_local equals get_taxpayer of individual_tax_return in
          let spouse_result_scope equals
            output of IndividualSection151ExemptionsList with {
              -- individual: s
              -- spouse: Present content taxpayer_local
              -- tax_year: individual_tax_return.tax_year
              -- tax_return_events: tax_return_events
              -- income_events: income_events
              -- dependents: dependents
              -- is_joint_or_surviving_spouse: true
            }
          in
          Present content spouse_result_scope.main_output
        -- Absent :
          Absent
      in
      spouse_result_inner
    -- FilingStatusVariant.SurvivingSpouse content variant :
      Absent
    -- FilingStatusVariant.HeadOfHousehold content variant :
      Absent
    -- FilingStatusVariant.Single content variant :
      Absent
    -- FilingStatusVariant.MarriedFilingSeparate content variant :
      Absent

  # Combine individuals_entitled_to_exemptions_under_151 from taxpayer and spouse (if joint return)
  # Make sure the combined list is unique (no duplicates)
  # Get unique individuals from spouse result that are not already in taxpayer list
  definition individuals_entitled_to_exemptions_under_151 equals
    let taxpayer_list equals taxpayer_exemptions.main_output.IndividualSection151ExemptionsListOutput.individuals_entitled_to_exemptions_under_151 in
    let spouse_unique_list equals
      match spouse_result with pattern
      -- Present content s_result :
        # Get individuals from spouse result that are not already in taxpayer list
        list of individual among s_result.IndividualSection151ExemptionsListOutput.individuals_entitled_to_exemptions_under_151
          such that
            not exists taxpayer_individual among taxpayer_list such that
              taxpayer_individual = individual
      -- Absent : []
    in
    taxpayer_list ++ spouse_unique_list

  # spouse_personal_exemption_allowed is from taxpayer_exemptions (only relevant for non-joint returns)
  definition spouse_personal_exemption_allowed equals
    taxpayer_exemptions.main_output.spouse_personal_exemption_allowed

  # Final output
  definition main_output equals
    TaxpayerExemptionsListOutput {
      -- taxpayer_result: taxpayer_exemptions.main_output
      -- spouse_result: spouse_result
      -- individuals_entitled_to_exemptions_under_151: individuals_entitled_to_exemptions_under_151
      -- spouse_personal_exemption_allowed: spouse_personal_exemption_allowed
    }
```

```catala
scope IndividualSection151Exemption:
  # LAW: 151(c) - Additional exemption for dependents
  # An exemption of the exemption amount for each individual who is a dependent
  # (as defined in section 152) of the taxpayer for the taxable year.
  # Number of personal exemptions = count of individuals entitled to exemptions
  label section_151_c_additional_exemptions_for_dependents
  definition number_of_personal_exemptions equals
    number of individuals_entitled_to_exemptions_under_151
```

- (a) Allowance of deductions

  In the case of an individual, the exemptions provided by this section shall be allowed as deductions in computing taxable income.

<!-- BLOCK_SPLIT: section 151(a) - Allowance of deductions -->
<!-- LAW_REF: section_151_a -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_151_a
```
```catala
scope IndividualSection151Exemption:
  # LAW: 151(a) - Allowance of deductions
  # In the case of an individual, the exemptions provided by this section shall be allowed
  # as deductions in computing taxable income.
  label section_151_a_allowance_of_deductions
  definition personal_exemptions_deduction equals
    let n equals decimal of number_of_personal_exemptions in
    money of (n * (decimal of (exemption_amount state after_phaseout)))
```


# Section 152 - Dependent defined
#============================= SECTION 152 IRCSIMPLIFIED DEFINITIONS =============================

152. Dependent defined

- (a) In general

  For purposes of this subtitle, the term "dependent" means-

  - (1) a qualifying child, or

  - (2) a qualifying relative.

<!-- BLOCK_SPLIT: scope definition for IndividualSection152Dependents -->
<!-- LAW_REF: section_152 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_152
```
```catala
scope IndividualSection152Dependents:
  # LAW: 152(a) - In general
  # For purposes of this subtitle, the term "dependent" means-
  # (1) a qualifying child, or
  # (2) a qualifying relative
  # Compute qualifying children by calling IndividualSection152QualifyingChild for each potential individual
  definition qualifying_children equals
    let potential_individuals equals
      list of individual among individuals such that
        not (individual = taxpayer)
    in
    map each individual among potential_individuals to
      (
        output of IndividualSection152QualifyingChild with {
          -- individual: individual
          -- taxpayer: taxpayer
          -- tax_year: tax_year
          -- family_relationship_events: family_relationship_events
          -- birth_events: birth_events
          -- residence_period_events: residence_period_events
          -- tax_return_events: tax_return_events
        }
      ).main_output

  # Compute qualifying relatives by calling IndividualSection152QualifyingRelative for each potential individual
  definition qualifying_relatives equals
    let potential_individuals equals
      list of individual among individuals such that
        not (individual = taxpayer)
    in
    map each individual among potential_individuals to
      (
        output of IndividualSection152QualifyingRelative with {
          -- individual: individual
          -- taxpayer: taxpayer
          -- tax_year: tax_year
          -- family_relationship_events: family_relationship_events
          -- residence_period_events: residence_period_events
          -- qualifying_child_results: qualifying_children
          -- tax_return_events: tax_return_events
          -- income_events: income_events
          -- marriage_events: marriage_events
        }
      ).main_output

  # LAW: 152(a) - Compute dependents: qualifying children or qualifying relatives
  definition dependents
    state initial
  equals
    let qualifying_children_individuals equals
      map each result among qualifying_children such that result.is_qualifying_child to result.individual
    in
    let qualifying_relatives_individuals equals
      map each result among qualifying_relatives such that result.is_qualifying_relative to result.individual
    in
    qualifying_children_individuals ++ qualifying_relatives_individuals
```

- (b) Exceptions

  For purposes of this section-

  - (1) Dependents ineligible

    If an individual is a dependent of a taxpayer for any taxable year of such taxpayer beginning in a calendar year, such individual shall be treated as having no dependents for any taxable year of such individual beginning in such calendar year.

<!-- BLOCK_SPLIT: dependents ineligible exception computation -->
<!-- LAW_REF: section_152_b_1 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_152_b_1
```
```catala
scope IndividualSection152Dependents:
  # LAW: 152(b)(1) - Dependents ineligible
  # If an individual is a dependent of a taxpayer for any taxable year of such taxpayer beginning in a calendar year,
  # such individual shall be treated as having no dependents for any taxable year of such individual beginning in such calendar year.
  label section_152_b_1_exception
  definition dependents
    state after_152b1
  equals
    # Check if this taxpayer is a dependent of another taxpayer
    # This means: check if this taxpayer appears in another taxpayer's dependents list
    let initial_dependents equals
      let qualifying_children_individuals equals
        map each result among qualifying_children such that result.is_qualifying_child to result.individual
      in
      let qualifying_relatives_individuals equals
        map each result among qualifying_relatives such that result.is_qualifying_relative to result.individual
      in
      qualifying_children_individuals ++ qualifying_relatives_individuals
    in
    let is_dependent_of_another_taxpayer equals
      exists event among tax_return_events
        such that event.individual != taxpayer
        and event.tax_year = tax_year
        and exists dependent among event.dependents such that dependent = taxpayer
    in
    if is_dependent_of_another_taxpayer then
      []
    else
      initial_dependents
```

- (2) Married dependents

    An individual shall not be treated as a dependent of a taxpayer under subsection (a) if such individual has made a joint return with the individual's spouse for the taxable year beginning in the calendar year in which the taxable year of the taxpayer begins.

<!-- BLOCK_SPLIT: married dependents exception computation -->
<!-- LAW_REF: section_152_b_2 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_152_b_2
```
```catala
scope IndividualSection152Dependents:
  # LAW: 152(b)(2) - Married dependents
  # An individual shall not be treated as a dependent of a taxpayer under subsection (a) if such individual
  # has made a joint return with the individual's spouse for the taxable year beginning in the calendar year
  # in which the taxable year of the taxpayer begins.
  # Note: This applies to ALL dependents (both qualifying children and qualifying relatives)
  # Unlike 152(c)(1)(E), this exception does NOT have the "other than only for a claim of refund" exception
  label section_152_b_2_exception
  definition dependents
    state after_152b2
  equals
    let initial_dependents equals
      let qualifying_children_individuals equals
        map each result among qualifying_children such that result.is_qualifying_child to result.individual
      in
      let qualifying_relatives_individuals equals
        map each result among qualifying_relatives such that result.is_qualifying_relative to result.individual
      in
      qualifying_children_individuals ++ qualifying_relatives_individuals
    in
    let dependents_after_b1 equals
      let is_dependent_of_another_taxpayer equals
        exists event among tax_return_events
          such that event.individual != taxpayer
          and event.tax_year = tax_year
          and exists dependent among event.dependents such that dependent = taxpayer
      in
      if is_dependent_of_another_taxpayer then
        []
      else
        initial_dependents
    in
    list of individual among dependents_after_b1
      such that not (
        exists event among tax_return_events
          such that event.individual = individual
          and event.tax_year = tax_year
          and event.filed_joint_return
      )

  # Final output - include all states for backward compatibility
  definition main_output equals
    IndividualSection152DependentsOutput {
      -- taxpayer: taxpayer
      -- dependents_initial: dependents
        state initial
      -- dependents_after_152b1: dependents
        state after_152b1
      -- dependents_after_152b2: dependents
        state after_152b2
      -- qualifying_children: qualifying_children
      -- qualifying_relatives: qualifying_relatives
    }
```

<!-- BLOCK_SPLIT: scope call for IndividualSection152Dependents -->
<!-- LAW_REF: section_152 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_152
```
```catala
scope IRCSimplified:
  # Call IndividualSection152Dependents to compute dependents for taxpayer
  definition taxpayer_dependents.taxpayer equals
    get_taxpayer of individual_tax_return
  definition taxpayer_dependents.tax_year equals
    individual_tax_return.tax_year
  definition taxpayer_dependents.individuals equals
    individuals
  definition taxpayer_dependents.family_relationship_events equals
    family_relationship_events
  definition taxpayer_dependents.birth_events equals
    birth_events
  definition taxpayer_dependents.residence_period_events equals
    residence_period_events
  definition taxpayer_dependents.tax_return_events equals
    tax_return_events
  definition taxpayer_dependents.income_events equals
    income_events
  definition taxpayer_dependents.marriage_events equals
    marriage_events
  definition taxpayer_dependents_result equals
    taxpayer_dependents.main_output
  
```

# Section 152 - Dependent defined
#============================= SECTION 152 QUALIFYING CHILD DEFINITIONS =============================

152. Dependent defined

- (c) Qualifying child

  For purposes of this section-

  - (2) Relationship

    For purposes of paragraph (1)(A), an individual bears a relationship to the taxpayer described in this paragraph if such individual is-

    - (A) a child of the taxpayer or a descendant of such a child, or

    - (B) a brother, sister, stepbrother, or stepsister of the taxpayer or a descendant of any such relative.

<!-- BLOCK_SPLIT: relationship requirement computation -->
<!-- LAW_REF: section_152_c_2 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_152_c_2
```
```catala
scope IndividualSection152QualifyingChild:
  # LAW: 152(c)(2) - Relationship requirement
  # An individual bears a relationship to the taxpayer if such individual is:
  # (A) a child of the taxpayer or a descendant of such a child, or
  # (B) a brother, sister, stepbrother, or stepsister of the taxpayer or a descendant of any such relative
  label section_152_c_2_relationship
  definition relationship_requirement_met equals
    exists rel_event among family_relationship_events
      such that rel_event.person = taxpayer
      and rel_event.relative = individual
      and rel_event.start_date <= Date.of_year_month_day of tax_year, 12, 31
      and (
        # Section 152(c)(2)(A): child or descendant of child
        rel_event.relationship_type = FamilyRelationshipType.Child
        or rel_event.relationship_type = FamilyRelationshipType.DescendantOfChild
        # Section 152(c)(2)(B): brother, sister, stepbrother, stepsister, or descendant of sibling
        or rel_event.relationship_type = FamilyRelationshipType.Brother
        or rel_event.relationship_type = FamilyRelationshipType.Sister
        or rel_event.relationship_type = FamilyRelationshipType.Stepbrother
        or rel_event.relationship_type = FamilyRelationshipType.Stepsister
        or rel_event.relationship_type = FamilyRelationshipType.DescendantOfSibling
      )
```

- (1) In general

    The term "qualifying child" means, with respect to any taxpayer for any taxable year, an individual-

    - (B) who has the same principal place of abode as the taxpayer for more than one-half of such taxable year,

<!-- BLOCK_SPLIT: principal place of abode requirement computation -->
<!-- LAW_REF: section_152_c_1_B -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_152_c_1_B
```
```catala
scope IndividualSection152QualifyingChild:
  # LAW: 152(c)(1)(B) - Principal place of abode requirement
  # Individual must have the same principal place of abode as the taxpayer for more than one-half of such taxable year
  label section_152_c_1_B_principal_place_of_abode
  definition principal_place_of_abode_requirement_met equals
    let year_start equals Date.of_year_month_day of tax_year, 1, 1 in
    let year_end equals Date.of_year_month_day of tax_year, 12, 31 in
    let year_midpoint equals Date.of_year_month_day of tax_year, 6, 30 in
    # Check if there exists a household where both individual and taxpayer have principal place of abode
    # and the overlapping period covers more than half the year (checked by covering the midpoint)
    exists taxpayer_residence among residence_period_events
      such that taxpayer_residence.individual = taxpayer
      and taxpayer_residence.is_principal_place_of_abode
      and taxpayer_residence.start_date <= year_end
      and taxpayer_residence.end_date >= year_start
      and exists individual_residence among residence_period_events
        such that individual_residence.individual = individual
        and individual_residence.household = taxpayer_residence.household
        and individual_residence.is_principal_place_of_abode
        and individual_residence.start_date <= year_midpoint
        and individual_residence.end_date >= Date.of_year_month_day of tax_year, 7, 1
        # Ensure there's overlap during the tax year
        and individual_residence.start_date <= year_end
        and individual_residence.end_date >= year_start
```

- (C) who meets the age requirements of paragraph (3), and

  - (3) Age requirements

    For purposes of paragraph (1)(C), an individual meets the requirements of this paragraph if such individual is younger than the taxpayer claiming such individual as a qualifying child and is less than 25 years old at the end of the taxable year.

<!-- BLOCK_SPLIT: age requirements computation -->
<!-- LAW_REF: section_152_c_3 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_152_c_3
```
```catala
scope IndividualSection152QualifyingChild:
  # LAW: 152(c)(3) - Age requirements
  # Individual meets the requirements if:
  # - individual is younger than the taxpayer claiming such individual as a qualifying child
  # - individual is less than 25 years old at the end of the taxable year
  label section_152_c_3_age
  definition age_requirement_met equals
    let year_end equals Date.of_year_month_day of tax_year, 12, 31 in
    # Get birth dates - use the earliest birth date if multiple exist
    let individual_birth_date equals
      if exists birth_event among birth_events such that birth_event.individual = individual then
        minimum of (map each birth_event among (list of birth_event among birth_events such that birth_event.individual = individual) to birth_event.birth_date)
      else Date.of_year_month_day of 1900, 1, 1
    in
    let taxpayer_birth_date equals if exists birth_event among birth_events such that birth_event.individual = taxpayer then
      minimum of (map each birth_event among (list of birth_event among birth_events such that birth_event.individual = taxpayer) to birth_event.birth_date)
    else Date.of_year_month_day of 1900, 1, 1
    in
    # Individual is younger than taxpayer (individual born after taxpayer)
    individual_birth_date > taxpayer_birth_date
    # Individual is less than 25 years old at end of taxable year
    and Date.is_young_enough_rounding_down of individual_birth_date, 25 year, year_end
```

- (E) who has not filed a joint return (other than only for a claim of refund) with the individual's spouse for the taxable year beginning in the calendar year in which the taxable year of the taxpayer begins.

<!-- BLOCK_SPLIT: joint return exception computation -->
<!-- LAW_REF: section_152_c_1_E -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_152_c_1_E
```
```catala
scope IndividualSection152QualifyingChild:
  # LAW: 152(c)(1)(E) - Joint return exception
  # Individual must not have filed a joint return (other than only for a claim of refund) with the individual's spouse
  # for the taxable year beginning in the calendar year in which the taxable year of the taxpayer begins
  # Note: The individual's tax year that begins in the calendar year in which the taxpayer's tax year begins
  # For calendar year taxpayers, this means the individual's tax year equals the taxpayer's tax year
  label section_152_c_1_E_joint_return
  definition joint_return_exception_applies equals
    exists event among tax_return_events
      such that event.individual = individual
      and event.tax_year = tax_year
      and event.filed_joint_return
      and not event.is_only_for_refund_claim
```

- (1) In general

    The term "qualifying child" means, with respect to any taxpayer for any taxable year, an individual-

    - (A) who bears a relationship to the taxpayer described in paragraph (2),

    - (B) who has the same principal place of abode as the taxpayer for more than one-half of such taxable year,

    - (C) who meets the age requirements of paragraph (3), and

    - (E) who has not filed a joint return (other than only for a claim of refund) with the individual's spouse for the taxable year beginning in the calendar year in which the taxable year of the taxpayer begins.

<!-- BLOCK_SPLIT: qualifying child determination computation -->
<!-- LAW_REF: section_152_c_1 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_152_c_1
```
```catala
scope IndividualSection152QualifyingChild:
  # LAW: 152(c)(1) - Qualifying child determination
  # An individual is a qualifying child if all requirements are met:
  # (A) relationship requirement
  # (B) principal place of abode requirement
  # (C) age requirement
  # (E) joint return exception does not apply
  label section_152_c_1_qualifying_child
  definition is_qualifying_child equals
    relationship_requirement_met
    and principal_place_of_abode_requirement_met
    and age_requirement_met
    and not joint_return_exception_applies
```

<!-- BLOCK_SPLIT: final output for section 152(c) -->
<!-- LAW_REF: section_152_c -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_152_c
```
```catala
scope IndividualSection152QualifyingChild:
  # LAW: 152(c) - Final output for qualifying child
  definition main_output equals
    IndividualSection152QualifyingChildOutput {
      -- individual: individual
      -- taxpayer: taxpayer
      -- is_qualifying_child: is_qualifying_child
      -- relationship_requirement_met: relationship_requirement_met
      -- principal_place_of_abode_requirement_met: principal_place_of_abode_requirement_met
      -- age_requirement_met: age_requirement_met
      -- joint_return_exception_applies: joint_return_exception_applies
    }
```

#============================= SECTION 152 QUALIFYING RELATIVE DEFINITIONS =============================


  - (H) An individual (other than an individual who at any time during the taxable year was the spouse, determined without regard to section 7703, of the taxpayer) who, for the taxable year of the taxpayer, has the same principal place of abode as the taxpayer and is a member of the taxpayer's household.

<!-- BLOCK_SPLIT: relationship requirement (H) computation -->
<!-- LAW_REF: section_152_d_2_H -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_152_d_2_H
```
```catala
scope IndividualSection152QualifyingRelative:
  # LAW: 152(d)(2)(H) - Relationship requirement (H)
  # An individual (other than an individual who at any time during the taxable year was the spouse,
  # determined without regard to section 7703, of the taxpayer) who, for the taxable year of the taxpayer,
  # has the same principal place of abode as the taxpayer and is a member of the taxpayer's household
  label section_152_d_2_H_relationship
  definition relationship_requirement_met_H equals
    let year_start equals Date.of_year_month_day of tax_year, 1, 1 in
    let year_end equals Date.of_year_month_day of tax_year, 12, 31 in
    # Check that individual is not the spouse of the taxpayer during the taxable year
    not (
      exists marriage_event among marriage_events
        such that (
          (marriage_event.spouse1 = taxpayer and marriage_event.spouse2 = individual)
          or (marriage_event.spouse1 = individual and marriage_event.spouse2 = taxpayer)
        )
        and marriage_event.marriage_date <= year_end
    )
    and exists taxpayer_residence among residence_period_events
      such that taxpayer_residence.individual = taxpayer
      and taxpayer_residence.is_principal_place_of_abode
      and taxpayer_residence.start_date <= year_end
      and taxpayer_residence.end_date >= year_start
      and exists individual_residence among residence_period_events
        such that individual_residence.individual = individual
        and individual_residence.household = taxpayer_residence.household
        and individual_residence.is_principal_place_of_abode
        and individual_residence.is_member_of_household
        and individual_residence.start_date <= year_end
        and individual_residence.end_date >= year_start
```
- (2) Relationship

  For purposes of paragraph (1)(A), an individual bears a relationship to the taxpayer described in this paragraph if the individual is any of the following with respect to the taxpayer:

  - (A) A child or a descendant of a child.

  - (B) A brother, sister, stepbrother, or stepsister.

  - (C) The father or mother, or an ancestor of either.

  - (D) A stepfather or stepmother.

  - (E) A son or daughter of a brother or sister of the taxpayer.

  - (F) A brother or sister of the father or mother of the taxpayer.

  - (G) A son-in-law, daughter-in-law, father-in-law, mother-in-law, brother-in-law, or sister-in-law.

<!-- BLOCK_SPLIT: relationship requirement computation -->
<!-- LAW_REF: section_152_d_2 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_152_d_2
```
```catala
scope IndividualSection152QualifyingRelative:
  # LAW: 152(d)(2) - Relationship requirement
  # An individual bears a relationship to the taxpayer if the individual is any of the following:
  # (A) through (G) various family relationships, or (H) same principal place of abode and member of household
  label section_152_d_2_relationship
  definition relationship_requirement_met equals
    (
      exists rel_event among family_relationship_events
        such that rel_event.person = taxpayer
        and rel_event.relative = individual
        and rel_event.start_date <= Date.of_year_month_day of tax_year, 12, 31
        and (
          # Section 152(d)(2)(A): child or descendant of child
          rel_event.relationship_type = FamilyRelationshipType.Child
          or rel_event.relationship_type = FamilyRelationshipType.DescendantOfChild
          # Section 152(d)(2)(B): brother, sister, stepbrother, stepsister
          or rel_event.relationship_type = FamilyRelationshipType.Brother
          or rel_event.relationship_type = FamilyRelationshipType.Sister
          or rel_event.relationship_type = FamilyRelationshipType.Stepbrother
          or rel_event.relationship_type = FamilyRelationshipType.Stepsister
          # Section 152(d)(2)(C): father, mother, or ancestor
          or rel_event.relationship_type = FamilyRelationshipType.Father
          or rel_event.relationship_type = FamilyRelationshipType.Mother
          or rel_event.relationship_type = FamilyRelationshipType.AncestorOfFatherOrMother
          # Section 152(d)(2)(D): stepfather, stepmother
          or rel_event.relationship_type = FamilyRelationshipType.Stepmother
          or rel_event.relationship_type = FamilyRelationshipType.Stepfather
          # Section 152(d)(2)(E): son or daughter of brother or sister (niece/nephew)
          or rel_event.relationship_type = FamilyRelationshipType.NieceOrNephew
          # Section 152(d)(2)(F): brother or sister of father or mother (uncle/aunt)
          or rel_event.relationship_type = FamilyRelationshipType.UncleOrAunt
          # Section 152(d)(2)(G): in-laws
          or rel_event.relationship_type = FamilyRelationshipType.SonInLaw
          or rel_event.relationship_type = FamilyRelationshipType.DaughterInLaw
          or rel_event.relationship_type = FamilyRelationshipType.FatherInLaw
          or rel_event.relationship_type = FamilyRelationshipType.MotherInLaw
          or rel_event.relationship_type = FamilyRelationshipType.BrotherInLaw
          or rel_event.relationship_type = FamilyRelationshipType.SisterInLaw
        )
    )
    # Section 152(d)(2)(H): individual with same principal place of abode and member of household
    or relationship_requirement_met_H
```

- (B) who has no income for the calendar year in which such taxable year begins, and

<!-- BLOCK_SPLIT: no income requirement computation -->
<!-- LAW_REF: section_152_d_1_B -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_152_d_1_B
```
```catala
scope IndividualSection152QualifyingRelative:
  # LAW: 152(d)(1)(B) - No income requirement
  # Individual must have no income for the calendar year in which such taxable year begins
  label section_152_d_1_B_no_income
  definition no_income_requirement_met equals
    not (
      exists income_event among income_events
        such that income_event.individual = individual
        and income_event.tax_year = tax_year
        and income_event.has_income
    )
```

- (D) who is not a qualifying child of such taxpayer or of any other taxpayer for any taxable year beginning in the calendar year in which such taxable year begins.

<!-- BLOCK_SPLIT: not a qualifying child requirement computation -->
<!-- LAW_REF: section_152_d_1_D -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_152_d_1_D
```
```catala
scope IndividualSection152QualifyingRelative:
  # LAW: 152(d)(1)(D) - Not a qualifying child requirement
  # Individual must not be a qualifying child of such taxpayer or of any other taxpayer
  # for any taxable year beginning in the calendar year in which such taxable year begins
  label section_152_d_1_D_not_qualifying_child
  definition not_qualifying_child_requirement_met equals
    # Check if individual is a qualifying child of such taxpayer
    let is_qualifying_child_of_current_taxpayer equals exists result among qualifying_child_results
        such that result.individual = individual
        and result.taxpayer = taxpayer
        and result.is_qualifying_child
    in
    # Check if individual is a qualifying child of any other taxpayer
    # by looking through tax_return_events to see if any other taxpayer
    # has this individual in their qualifying_children list
    let is_qualifying_child_of_other_taxpayer equals exists event among tax_return_events
      such that event.tax_year = tax_year
      and not (event.individual = taxpayer)
      and exists qualifying_child among event.qualifying_children
        such that qualifying_child = individual
    in
    # Individual must not be a qualifying child of such taxpayer or of any other taxpayer
    not (is_qualifying_child_of_current_taxpayer or is_qualifying_child_of_other_taxpayer)
```

- (1) In general

    The term "qualifying relative" means, with respect to any taxpayer for any taxable year, an individual-

    - (A) who bears a relationship to the taxpayer described in paragraph (2),

    - (B) who has no income for the calendar year in which such taxable year begins, and

    - (D) who is not a qualifying child of such taxpayer or of any other taxpayer for any taxable year beginning in the calendar year in which such taxable year begins.

<!-- BLOCK_SPLIT: qualifying relative determination computation -->
<!-- LAW_REF: section_152_d_1 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_152_d_1
```
```catala
scope IndividualSection152QualifyingRelative:
  # LAW: 152(d)(1) - Qualifying relative determination
  # An individual is a qualifying relative if all requirements are met:
  # (A) relationship requirement
  # (B) no income requirement
  # (D) not a qualifying child requirement
  label section_152_d_1_qualifying_relative
  definition is_qualifying_relative equals
    relationship_requirement_met
    and no_income_requirement_met
    and not_qualifying_child_requirement_met
```

<!-- BLOCK_SPLIT: final output for section 152(d) -->
<!-- LAW_REF: section_152_d -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_152_d
```
```catala
scope IndividualSection152QualifyingRelative:
  # LAW: 152(d) - Final output for qualifying relative
  definition main_output equals
    IndividualSection152QualifyingRelativeOutput {
      -- individual: individual
      -- taxpayer: taxpayer
      -- is_qualifying_relative: is_qualifying_relative
      -- relationship_requirement_met_H: relationship_requirement_met_H
      -- relationship_requirement_met: relationship_requirement_met
      -- no_income_requirement_met: no_income_requirement_met
      -- not_qualifying_child_requirement_met: not_qualifying_child_requirement_met
    }
```

# Section 7703 - Determination of marital status
#=============================Subscope DEFINITIONs =============================

<!-- catala-metadata -->
```yaml
type: catala-metadata
metadata_type: definition
object_type: scope
name: IRCSimplified
law_ref: section_7703
```
```catala
scope IRCSimplified:
  definition taxpayer_marital_status.individual equals
    match individual_tax_return.details with pattern
    -- FilingStatusVariant.JointReturn content variant : variant.taxpayer
    -- FilingStatusVariant.SurvivingSpouse content variant : variant.taxpayer
    -- FilingStatusVariant.HeadOfHousehold content variant : variant.taxpayer
    -- FilingStatusVariant.Single content variant : variant.taxpayer
    -- FilingStatusVariant.MarriedFilingSeparate content variant : variant.taxpayer
  definition taxpayer_marital_status.tax_year equals
    individual_tax_return.tax_year
  definition taxpayer_marital_status.marriage_events equals
    marriage_events
  definition taxpayer_marital_status.divorce_or_legal_separation_events equals
    divorce_or_legal_separation_events
  definition taxpayer_marital_status.death_events equals
    death_events
  definition taxpayer_marital_status.individual_tax_return equals
    individual_tax_return
  definition taxpayer_marital_status.individuals_entitled_to_exemptions_under_151 equals
    taxpayer_exemptions_list_result.individuals_entitled_to_exemptions_under_151
  definition taxpayer_marital_status.residence_period_events equals
    residence_period_events
  definition taxpayer_marital_status.household_maintenance_events equals
    household_maintenance_events
  definition taxpayer_marital_status.qualifying_children equals
    taxpayer_dependents_result.qualifying_children
  definition individual_marital_statuses equals
    [ taxpayer_marital_status.main_output ]
```

# Section 7703 - Determination of marital status
#============================= HELPER FUNCTIONS =============================

<!-- BLOCK_SPLIT: helper functions for section 7703 -->
<!-- LAW_REF: section_7703_helpers -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_7703_helpers
```
```catala
scope IndividualSection7703MaritalStatus:
  # Find spouse of an individual based on marriage events (not directly in law text)
  # Returns the spouse from the most recent marriage before or on year_end_arg
  # Note: This does not check for divorces - that should be done by the caller
  # if needed, as divorce checking requires additional context (divorce events)
  definition
    section_7703_find_spouse_from_marriage_events
    of individual_arg, marriage_events_arg, year_end_arg equals
    let valid_marriages equals
      map each marriage_event among marriage_events_arg
        such that (marriage_event.spouse1 = individual_arg or marriage_event.spouse2 = individual_arg)
        and marriage_event.marriage_date <= year_end_arg
      to
        (
          if marriage_event.spouse1 = individual_arg then marriage_event.spouse2
          else marriage_event.spouse1,
          marriage_event.marriage_date
        )
    in
    if number of valid_marriages > 0 then
      # Get the most recent marriage (maximum marriage_date)
      let most_recent_marriage equals maximum of (map each marriage_tuple among valid_marriages to marriage_tuple.2)
      in
      # Find the spouse from the most recent marriage
      List.first_element of
        (
          map each marriage_tuple among valid_marriages
            such that marriage_tuple.2 = most_recent_marriage
          to
            marriage_tuple.1
        )
    else Absent

  # Get spouse death date during tax year if spouse died (not directly in law text)
  # Returns death date if spouse died during the tax year (for determination_date calculation)
  # Note: This only checks deaths during the tax year, not previous years
  # For checking if spouse is alive at determination_date, use section_7703_get_spouse_death_date_before_date
  definition
    section_7703_get_spouse_death_date_during_year
    of spouse_arg, death_events_arg, tax_year_arg equals
    match spouse_arg with pattern
    -- Present content s :
      let year_start equals Date.of_year_month_day of tax_year_arg, 1, 1 in
      let year_end equals Date.of_year_month_day of tax_year_arg, 12, 31 in
      let spouse_death_events_during_year equals
        list of death_event among death_events_arg
        such that death_event.decedent = s
          and death_event.death_date >= year_start
          and death_event.death_date <= year_end
      in
    if number of spouse_death_events_during_year > 0 then
      Present content (minimum of (map each death_event among spouse_death_events_during_year to death_event.death_date))
    else Absent
    -- Absent : Absent

  # Check if spouse died strictly before a given date (not directly in law text)
  # Returns true if spouse died before (not at) the given date, false otherwise
  definition
    section_7703_spouse_died_before_date
    of spouse_arg, death_events_arg, before_date_arg equals
    match spouse_arg with pattern
    -- Present content s :
      let spouse_death_events_before_date equals
        list of death_event among death_events_arg
          such that death_event.decedent = s
          and death_event.death_date < before_date_arg
      in
      number of spouse_death_events_before_date > 0
    -- Absent : false

  # Get spouse from tax return if filing separately (not directly in law text)
  definition
    section_7703_get_spouse_from_tax_return
    of individual_arg, individual_tax_return_arg equals
    match individual_tax_return_arg.details with pattern
    -- FilingStatusVariant.MarriedFilingSeparate content variant :
      if variant.taxpayer = individual_arg then
        Present content variant.spouse
      else Absent
    -- FilingStatusVariant.JointReturn content variant :
      if variant.taxpayer = individual_arg then
        Present content variant.spouse
      else Absent
    -- FilingStatusVariant.SurvivingSpouse content variant :
      if variant.taxpayer = individual_arg then
        Present content variant.deceased_spouse
      else Absent
    -- FilingStatusVariant.HeadOfHousehold content variant : Absent
    -- FilingStatusVariant.Single content variant : Absent

  # Check if individual files a separate return (not directly in law text)
  definition
    section_7703_files_separate_return
    of individual_arg, individual_tax_return_arg equals
    match individual_tax_return_arg.details with pattern
    -- FilingStatusVariant.MarriedFilingSeparate content variant :
      variant.taxpayer = individual_arg
    -- FilingStatusVariant.JointReturn content variant : false
    -- FilingStatusVariant.SurvivingSpouse content variant : false
    -- FilingStatusVariant.HeadOfHousehold content variant : false
    -- FilingStatusVariant.Single content variant : false

  # Check if spouse is member of household during last 6 months (not directly in law text)
  definition
    section_7703_is_spouse_member_of_household_last_6_months
    of spouse_arg, household_arg, residence_period_events_arg, last_6_months_start_arg, last_6_months_end_arg equals
    let spouse_membership_events equals
      list of spouse_residence_event among residence_period_events_arg
        such that spouse_residence_event.individual = spouse_arg
        and spouse_residence_event.household = household_arg
        and spouse_residence_event.is_member_of_household
    in
    if number of spouse_membership_events > 0 then
      exists membership_event among spouse_membership_events
        such that membership_event.start_date <= last_6_months_end_arg
        and membership_event.end_date >= last_6_months_start_arg
    else false
```

#============================= Scope DEFINITIONS =============================

7703. Determination of marital status

- (a) General rule

  - (1) the determination of whether an individual is married shall be made as of the close of his taxable year; except that if his spouse dies during his taxable year such determination shall be made as of the time of such death; and

<!-- BLOCK_SPLIT: determination date and married status computation -->
<!-- LAW_REF: section_7703_a_1 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_7703_a_1
```
```catala
scope IndividualSection7703MaritalStatus:
  # LAW: 7703(a)(1) - Determination date
  # The determination shall be made as of the close of his taxable year;
  # except that if his spouse dies during his taxable year such determination shall be made as of the time of such death
  label section_7703_a_1_determination_date
  definition determination_date equals
    let year_end equals Date.of_year_month_day of tax_year, 12, 31 in
    let spouse equals section_7703_find_spouse_from_marriage_events of individual, marriage_events, year_end in
    let spouse_death_date_during_year equals section_7703_get_spouse_death_date_during_year of spouse, death_events, tax_year in
    match spouse_death_date_during_year with pattern
    -- Present content death_date : death_date
    -- Absent : year_end

  # LAW: 7703(a)(1) - Is married at determination date
  # The determination of whether an individual is married
  # Note: This checks for the existence of a marriage, but does not check for legal separation/divorce
  # Legal separation/divorce is handled separately in (a)(2)
  # Important: If spouse dies during the tax year, determination_date = death_date, and the individual
  # is considered married at that moment (allowing joint return filing for that year).
  # This protects the surviving spouse by allowing them to file as "Married Filing Jointly" for the year of death.
  label section_7703_a_1_married
  definition is_married_at_determination_date equals
    let year_end equals Date.of_year_month_day of tax_year, 12, 31 in
    let spouse equals section_7703_find_spouse_from_marriage_events of individual, marriage_events, year_end in
    # Since we already found a spouse from marriage events, there's a valid marriage
    # We just need to check if spouse is still alive at determination_date (or died exactly at determination_date)
    # - If spouse died strictly before determination_date: not married (spouse already dead)
    # - If spouse died exactly at determination_date (during tax year): married (were married at moment of death)
    # - If spouse is alive: married
    match spouse with pattern
    -- Present content s :
      # Check if spouse died strictly before determination_date
      # If yes, not married; if no (alive or died exactly at determination_date), married
      not (section_7703_spouse_died_before_date of spouse, death_events, determination_date)
    -- Absent : false
# No spouse found, not married
```

- (2) an individual legally separated from his spouse under a decree of divorce or of separate maintenance shall not be considered as married.

<!-- BLOCK_SPLIT: legally separated computation -->
<!-- LAW_REF: section_7703_a_2 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_7703_a_2
```
```catala
scope IndividualSection7703MaritalStatus:
  # LAW: 7703(a)(2) - Legally separated
  # An individual legally separated from his spouse under a decree of divorce or of separate maintenance
  # shall not be considered as married
  label section_7703_a_2_legally_separated
  definition is_legally_separated equals
    # Reuse spouse from determination_date computation (already computed in same block)
    let year_end equals Date.of_year_month_day of tax_year, 12, 31 in
    let spouse equals section_7703_find_spouse_from_marriage_events of individual, marriage_events, year_end in
    match spouse with pattern
    -- Present content s :
      exists divorce_event among divorce_or_legal_separation_events
        such that (divorce_event.person1 = individual or divorce_event.person2 = individual)
        and (divorce_event.person1 = s or divorce_event.person2 = s)
        and divorce_event.decree_date <= determination_date
        and (
          divorce_event.decree_type = DecreeType.Divorce
          or divorce_event.decree_type = DecreeType.SeparateMaintenance
        )
    -- Absent : false
```

<!-- BLOCK_SPLIT: subsection (a) general rule - base case for married status -->
<!-- LAW_REF: section_7703_a -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_7703_a
```
```catala
scope IndividualSection7703MaritalStatus:
  # LAW: 7703(a) - General rule
  # Base case: Default is not married (false)
  label section_7703_a_base_case
  definition is_married_for_tax_purposes equals false

  # Exception: An individual is married if:
  # - They are married at the determination date (per (a)(1))
  # - AND they are not legally separated (per (a)(2))
  label section_7703_a_married exception section_7703_a_base_case
  definition is_married_for_tax_purposes under condition
    is_married_at_determination_date
    and not is_legally_separated
  consequence equals true
```

- (b) Certain married individuals living apart

  For purposes of those provisions of this title which refer to this subsection, if-

  - (1) an individual who is married (within the meaning of subsection (a)) and who files a separate return maintains as his home a household which constitutes for more than one-half of the taxable year the principal place of abode of a child with respect to whom such individual is entitled to a deduction for the taxable year under section 151,

<!-- BLOCK_SPLIT: households with qualifying child computation -->
<!-- LAW_REF: section_7703_b_1 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_7703_b_1
```
```catala
scope IndividualSection7703MaritalStatus:
  # LAW: 7703(b)(1) - Household with qualifying child
  # An individual maintains as his home a household which constitutes for more than one-half of the taxable year
  # the principal place of abode of a child with respect to whom such individual is entitled to a deduction
  # for the taxable year under section 151
  label section_7703_b_1_households_with_qualifying_child
  definition households_with_qualifying_child equals
    let year_end equals Date.of_year_month_day of tax_year, 12, 31 in
    let year_start equals Date.of_year_month_day of tax_year, 1, 1 in
    map each child_residence_event among residence_period_events
      such that child_residence_event.is_principal_place_of_abode
      # Check if child has principal place of abode for more than half the year
      and child_residence_event.start_date <= Date.of_year_month_day of tax_year, 6, 30
      and child_residence_event.end_date >= Date.of_year_month_day of tax_year, 7, 1
      and child_residence_event.start_date <= year_end
      and child_residence_event.end_date >= year_start
      # Check that this is a qualifying child of the individual (section 152)
      and exists qualifying_child_result among qualifying_children
        such that qualifying_child_result.is_qualifying_child
        and qualifying_child_result.taxpayer = individual
        and qualifying_child_result.individual = child_residence_event.individual
      # Check that this child is entitled to a deduction under section 151
      and exists entitled_individual among individuals_entitled_to_exemptions_under_151
        such that entitled_individual = child_residence_event.individual
        # Also check that individual lives in the same household during overlapping periods
        and exists individual_residence_event among residence_period_events
          such that individual_residence_event.individual = individual
          and individual_residence_event.household = child_residence_event.household
          # Check that individual's residence overlaps with child's residence period
          and individual_residence_event.start_date <= child_residence_event.end_date
          and individual_residence_event.end_date >= child_residence_event.start_date
          # And individual's residence overlaps with the tax year
          and individual_residence_event.start_date <= year_end
          and individual_residence_event.end_date >= year_start
    to
      child_residence_event.household
```

- (2) such individual furnishes over one-half of the cost of maintaining such household during the taxable year, and

<!-- BLOCK_SPLIT: households maintained by individual computation -->
<!-- LAW_REF: section_7703_b_2 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_7703_b_2
```
```catala
scope IndividualSection7703MaritalStatus:
  # LAW: 7703(b)(2) - Individual furnishes over one-half of the cost
  # Such individual furnishes over one-half of the cost of maintaining such household during the taxable year
  label section_7703_b_2_households_maintained
  definition households_maintained_by_individual equals
    let year_end equals Date.of_year_month_day of tax_year, 12, 31 in
    let year_start equals Date.of_year_month_day of tax_year, 1, 1 in
    list of household among households_with_qualifying_child
      such that exists maintenance_event among household_maintenance_events
        such that maintenance_event.individual = individual
        and maintenance_event.household = household
        and maintenance_event.cost_furnished_percentage > 0.5
        # Maintenance period must overlap with tax year
        and maintenance_event.start_date <= year_end
        and maintenance_event.end_date >= year_start
        # Also verify individual lives in household during maintenance period
        and exists individual_residence_event among residence_period_events
          such that individual_residence_event.individual = individual
          and individual_residence_event.household = household
          # Individual's residence should overlap with maintenance period
          and individual_residence_event.start_date <= maintenance_event.end_date
          and individual_residence_event.end_date >= maintenance_event.start_date
```

- (3) during the last 6 months of the taxable year, such individual's spouse is not a member of such household,

<!-- BLOCK_SPLIT: spouse not member of household last 6 months computation -->
<!-- LAW_REF: section_7703_b_3 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_7703_b_3
```
```catala
scope IndividualSection7703MaritalStatus:
  # LAW: 7703(b)(3) - During the last 6 months, such individual's spouse is not a member of such household
  label section_7703_b_3_spouse_not_member
  definition spouse_not_member_of_household_last_6_months equals
    let year_end equals Date.of_year_month_day of tax_year, 12, 31 in
    let last_6_months_start equals Date.of_year_month_day of tax_year, 7, 1 in
    let last_6_months_end equals year_end in
    let spouse_from_tax_return equals section_7703_get_spouse_from_tax_return of individual, individual_tax_return in
    match spouse_from_tax_return with pattern
    -- Present content spouse :
      # Check if there exists a household where spouse is NOT a member during last 6 months
      exists household among households_maintained_by_individual
        such that
        # Condition (3) requires spouse NOT be a member during the last 6 months
        not (section_7703_is_spouse_member_of_household_last_6_months of spouse, household, residence_period_events, last_6_months_start, last_6_months_end)
    -- Absent :
      # If no spouse exists, condition (3) is automatically satisfied
      # But we still need conditions (1) and (2) to be satisfied
      number of households_maintained_by_individual > 0
```

such individual shall not be considered as married.

<!-- BLOCK_SPLIT: subsection (b) exception applies computation -->
<!-- LAW_REF: section_7703_b -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_7703_b
```
```catala
scope IndividualSection7703MaritalStatus:
  # LAW: 7703(b) - Certain married individuals living apart
  # For purposes of those provisions of this title which refer to this subsection, if-
  # (1) an individual who is married (within the meaning of subsection (a)) and who files a separate return
  #     maintains as his home a household which constitutes for more than one-half of the taxable year
  #     the principal place of abode of a child with respect to whom such individual is entitled to a deduction
  #     for the taxable year under section 151,
  # (2) such individual furnishes over one-half of the cost of maintaining such household during the taxable year, and
  # (3) during the last 6 months of the taxable year, such individual's spouse is not a member of such household,
  # such individual shall not be considered as married.
  # Base case: Exception does not apply by default
  label section_7703_b_base_case
  definition subsection_b_exception_applies equals false

  # Exception: Exception applies if all conditions are met
  label section_7703_b_exception exception section_7703_b_base_case
  definition subsection_b_exception_applies under condition
    # Must be married (per subsection (a)) - but not legally separated (since that's already handled in (a)(2))
    is_married_at_determination_date
    and not is_legally_separated
    # Must file a separate return
    and section_7703_files_separate_return of individual, individual_tax_return
    # Check if there exists a household that satisfies ALL THREE conditions together
    # Condition (1): Maintains household with qualifying child for more than half year
    # Condition (2): Furnishes over one-half of the cost of maintaining such household
    # Condition (3): Spouse not a member of such household during last 6 months
    and spouse_not_member_of_household_last_6_months
  consequence equals true

  # LAW: 7703(b) - Exception: Not married if subsection (b) exception applies
  # such individual shall not be considered as married
  label section_7703_b_not_married exception section_7703_a_married
  definition is_married_for_tax_purposes under condition
    subsection_b_exception_applies
  consequence equals false
```

<!-- BLOCK_SPLIT: final determination for section 7703 -->
<!-- LAW_REF: section_7703 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_7703
```
```catala
scope IndividualSection7703MaritalStatus:
  # LAW: 7703 - Final determination: Is married for tax purposes
  # This combines subsection (a) base case and subsection (b) exception
  # The definition is already established through the exception mechanism:
  # - Base case from (a): is_married_at_determination_date and not is_legally_separated
  # - Exception from (b): subsection_b_exception_applies overrides to false

  definition main_output equals
    IndividualSection7703MaritalStatusOutput {
      -- individual: individual
      -- tax_year: tax_year
      -- determination_date: determination_date
      -- is_married_at_determination_date: is_married_at_determination_date
      -- is_legally_separated: is_legally_separated
      -- households_with_qualifying_child: households_with_qualifying_child
      -- households_maintained_by_individual: households_maintained_by_individual
      -- spouse_not_member_of_household_last_6_months: spouse_not_member_of_household_last_6_months
      -- subsection_b_exception_applies: subsection_b_exception_applies
      -- is_married_for_tax_purposes: is_married_for_tax_purposes
    }
```

# Section 3306 - Organization employer statuses

```catala
scope IRCSimplified:
  # Section 3306 - Organization employer statuses
  # Compute employer status for each organization
  definition organization_employer_statuses equals
    # Filter organizations to only those that appear in wage or employment events
    let organizations_with_events equals
      list of org among organizations such that
        exists wage_event among wage_payment_events such that wage_event.employer.id = org.id
        or exists emp_event among employment_relationship_events such that emp_event.employer.id = org.id
    in
    map each organization among organizations_with_events to
      (
        output of OrganizationSection3306EmployerStatus with {
          -- organization: organization
          -- calendar_year: employer_unemployment_excise_tax_return.tax_year
          -- wage_payment_events: wage_payment_events
          -- employment_relationship_events: employment_relationship_events
        }
      ).main_output

  # Section 3306 - Wage payment wages results
  # Compute taxable wages for each wage payment event
  definition wage_payment_wages_results equals
    map each wage_event among wage_payment_events to
      (
        output of WagePaymentEventSection3306Wages with {
          -- wage_payment_event: wage_event
          -- employment_termination_events: employment_termination_events
          -- death_events: death_events
        }
      ).main_output

  # Section 3306 - Employment relationship employment results
  # Compute employment status for each employment relationship event
  definition employment_relationship_employment_results equals
    map each emp_event among employment_relationship_events to
      (
        output of EmploymentRelationshipEventSection3306Employment with {
          -- employment_relationship_event: emp_event
          -- calendar_year: employer_unemployment_excise_tax_return.tax_year
          -- wage_payment_events: wage_payment_events
          -- employment_relationship_events: employment_relationship_events
          -- student_enrollment_events: student_enrollment_events
          -- hospital_patient_events: hospital_patient_events
          -- immigration_admission_events: immigration_admission_events
          -- parenthood_events: parenthood_events
          -- birth_events: birth_events
          -- marriage_events: marriage_events
        }
      ).main_output
```

# Section 3306 - Implementation
#============================= SECTION 3306 =============================

<!-- BLOCK_SPLIT: helper functions for section 3306 -->
<!-- LAW_REF: section_3306_helpers -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_helpers
```
```catala
scope OrganizationSection3306EmployerStatus:
  # Helper function: Check if an employment event overlaps with a specific date
  # An employment event overlaps with a date if: start_date <= date <= end_date
  definition section_3306_employment_overlaps_date
    of emp_event_arg, check_date_arg equals
    emp_event_arg.start_date <= check_date_arg
    and emp_event_arg.end_date >= check_date_arg

  # Helper function: Count unique employee IDs from a list of employment events
  # Returns the number of distinct individuals (by employee.id)
  # This properly handles duplicates by checking if an employee.id appears for the first time
  definition section_3306_count_unique_employees
    of employment_events_arg equals
    # For each event, check if this is the first event with this employee.id
    # (i.e., no previous event in the list has the same employee.id)
    # We use event.id to ensure we're not comparing an event to itself
    let unique_employee_events equals
      list of emp_event among employment_events_arg such that
        not exists prev_emp_event among employment_events_arg such that
          prev_emp_event.employee.id = emp_event.employee.id
          and prev_emp_event.id < emp_event.id
    in
    number of unique_employee_events

  # Helper function: Get day of year (1-365/366) from a date
  # Properly accounts for month lengths and leap years
  definition section_3306_get_day_of_year of date_arg equals
    let year_local equals Date.get_year of date_arg in
    let month_local equals Date.get_month of date_arg in
    let day_local equals Date.get_day of date_arg in
    # Days in months: Jan=31, Feb=28/29, Mar=31, Apr=30, May=31, Jun=30, Jul=31, Aug=31, Sep=30, Oct=31, Nov=30, Dec=31
    # Check if leap year: divisible by 4, except centuries unless divisible by 400
    # Calculate modulo using: a % b = a - (a / b) * b
    let year_div_4 equals year_local / 4 in
    let year_mod_4 equals year_local - (integer of year_div_4) * 4 in
    let year_div_100 equals year_local / 100 in
    let year_mod_100 equals year_local - (integer of year_div_100) * 100 in
    let year_div_400 equals year_local / 400 in
    let year_mod_400 equals year_local - (integer of year_div_400) * 400 in
    let is_leap_year_local equals
      (year_mod_4 = 0 and year_mod_100 != 0)
      or (year_mod_400 = 0)
    in
    let days_before_month equals
      if month_local = 1 then 0
      else if month_local = 2 then 31
      else if month_local = 3 then
        if is_leap_year_local then 60 else 59
      else if month_local = 4 then
        if is_leap_year_local then 91 else 90
      else if month_local = 5 then
        if is_leap_year_local then 121 else 120
      else if month_local = 6 then
        if is_leap_year_local then 152 else 151
      else if month_local = 7 then
        if is_leap_year_local then 182 else 181
      else if month_local = 8 then
        if is_leap_year_local then 213 else 212
      else if month_local = 9 then
        if is_leap_year_local then 244 else 243
      else if month_local = 10 then
        if is_leap_year_local then 274 else 273
      else if month_local = 11 then
        if is_leap_year_local then 305 else 304
      else
        if is_leap_year_local then 335 else 334
    in
    days_before_month + day_local

  # Helper function: Get calendar week number (simplified US system)
  # Uses day of year to calculate week: week = floor((day_of_year - 1) / 7) + 1
  # This gives us week 1-53, where week 1 contains January 1
  # Returns (year, week_number) where week_number is 1-53
  # Note: This is a simplified calculation. A full implementation would account for
  # which day of the week January 1st falls on, but for the purpose of ensuring
  # "10 days in different calendar weeks", this approximation is sufficient
  definition section_3306_get_calendar_week_us of date_arg equals
    let year_local equals Date.get_year of date_arg in
    let day_of_year equals section_3306_get_day_of_year of date_arg in
    # Calculate week number: floor((day_of_year - 1) / 7) + 1
    # Note: This is a simplified calculation. A full implementation would account for
    # which day of the week January 1st falls on, but for the purpose of ensuring
    # "10 days in different calendar weeks", this approximation is sufficient
    let days_minus_one equals day_of_year - 1 in
    let week_decimal equals (decimal of days_minus_one) / 7.0 in
    let week_number equals (integer of week_decimal) + 1 in
    (year_local, week_number)

  # Helper function: Get all unique dates from employment events that fall within target year
  # Returns list of ALL dates (not just start/end) where employment occurs
  # This collects candidate dates to check
  definition section_3306_get_candidate_dates_in_year
    of employment_events_arg, target_year_arg equals
    # Collect all dates from all events
    # We'll iterate through each day of the year and check if any event covers it
    let year_start equals Date.of_year_month_day of target_year_arg, 1, 1 in
    let year_end equals Date.of_year_month_day of target_year_arg, 12, 31 in
    # Check each day of the year (up to 366 for leap years)
    let all_year_days equals
      map each day_num among List.sequence of 1, 366 to
        year_start + ((day_num - 1) * 1 day)
    in
    # Filter to only days that are within the year and covered by at least one employment event
    list of check_date among all_year_days such that
      Date.get_year of check_date = target_year_arg
      and exists emp_event among employment_events_arg such that
        section_3306_employment_overlaps_date of emp_event, check_date

  # Helper function: Get all days in a year that have employment meeting minimum threshold
  # For each candidate date, checks if at least min_individuals_arg were employed on that day
  # Returns list of dates where the threshold is met
  definition section_3306_get_days_with_employment
    of employment_events_arg, target_year_arg, min_individuals_arg equals
    let candidate_dates equals
      section_3306_get_candidate_dates_in_year of employment_events_arg, target_year_arg
    in
    # For each candidate date, check if at least min_individuals_arg were employed on that day
    # Count unique individuals (by employee.id) to ensure we're counting different people
    list of candidate_date among candidate_dates such that
      let employment_events_on_day equals
        list of emp_event among employment_events_arg such that
          section_3306_employment_overlaps_date of emp_event, candidate_date
      in
      # Count unique employees (individuals) on this day
      # Use helper function to properly count distinct individuals
      let unique_employee_count equals
        section_3306_count_unique_employees of employment_events_on_day
      in
      unique_employee_count >= min_individuals_arg

  # Helper function: Get week identifier from a date (year, week_number)
  definition section_3306_get_week_identifier of date_arg equals
    section_3306_get_calendar_week_us of date_arg

  # Helper function: Count unique calendar weeks from a list of dates
  # Returns the number of distinct (year, week) pairs
  definition section_3306_count_unique_calendar_weeks of dates_arg equals
    # For each date, check if its week identifier appears for the first time
    # (i.e., there's no earlier date with the same week identifier)
    let unique_dates equals
      list of date_item among dates_arg such that
        let current_week_id equals section_3306_get_week_identifier of date_item in
        not exists prev_date among dates_arg such that
          prev_date < date_item
          and section_3306_get_week_identifier of prev_date = current_week_id
    in
    # Count the unique week identifiers
    number of unique_dates

  # Helper function: Check if there are 10 days in different calendar weeks
  # with at least min_individuals employed on each day
  # This checks both the current year and preceding year
  definition section_3306_has_ten_days_in_different_weeks
    of employment_events_arg, target_year_arg, min_individuals_arg equals
    let days_current_year equals
      section_3306_get_days_with_employment of employment_events_arg, target_year_arg, min_individuals_arg
    in
    let preceding_year equals target_year_arg - 1 in
    let days_preceding_year equals
      section_3306_get_days_with_employment of employment_events_arg, preceding_year, min_individuals_arg
    in
    let all_days equals days_current_year ++ days_preceding_year in
    let unique_week_count equals section_3306_count_unique_calendar_weeks of all_days in
    unique_week_count >= 10
```

3306. Definitions

- (a) Employer

  - (1) In general

    The term "employer" means, with respect to any calendar year, any person who-

    - (A) during the calendar year or the preceding calendar year paid wages of $1,500 or more, or

      For purposes of this paragraph, there shall not be taken into account any wages paid to, or employment of, an employee performing domestic services referred to in paragraph (3).

<!-- BLOCK_SPLIT: general employer - wages threshold -->
<!-- LAW_REF: section_3306_a_1_A -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_a_1_A
```
```catala
scope OrganizationSection3306EmployerStatus:
  # LAW: 3306(a)(1)(A) - General employer: wages threshold
  # During the calendar year or the preceding calendar year paid wages of $1,500 or more
  # For purposes of this paragraph, there shall not be taken into account any wages paid to,
  # or employment of, an employee performing domestic services referred to in paragraph (3)
  label section_3306_a_1_A_wages_threshold
  definition is_general_employer equals
    let relevant_wage_events equals
      list of wage_event among wage_payment_events such that
        wage_event.employer.id = organization.id
        and (Date.get_year of wage_event.payment_date = calendar_year
          or Date.get_year of wage_event.payment_date = calendar_year - 1)
        # Exclude domestic service wages per paragraph (1) instruction
        and not (
          exists emp_event among employment_relationship_events such that
            emp_event.employer.id = organization.id
            and emp_event.employee.id = wage_event.employee.id
            and emp_event.employment_category = EmploymentCategory.DomesticService
        )
    in
    let total_wages equals sum money of (map each wage_event among relevant_wage_events to wage_event.amount) in
    total_wages >= $1,500
```

- (B) on each of some 10 days during the calendar year or during the preceding calendar year, each day being in a different calendar week, employed at least one individual in employment for some portion of the day.

<!-- BLOCK_SPLIT: general employer - 10 days threshold -->
<!-- LAW_REF: section_3306_a_1_B -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_a_1_B
```
```catala
scope OrganizationSection3306EmployerStatus:
  # LAW: 3306(a)(1)(B) - General employer: 10 days threshold
  # On each of some 10 days during the calendar year or during the preceding calendar year,
  # each day being in a different calendar week, employed at least one individual in employment
  # for some portion of the day
  # For purposes of this paragraph, there shall not be taken into account any employment of
  # an employee performing domestic services referred to in paragraph (3)
  label section_3306_a_1_B_ten_days_threshold
  exception section_3306_a_1_A_wages_threshold
  definition is_general_employer under condition
    let relevant_employment_events equals
      list of emp_event among employment_relationship_events such that
        emp_event.employer.id = organization.id
        and (Date.get_year of emp_event.start_date = calendar_year
          or Date.get_year of emp_event.start_date = calendar_year - 1
          or Date.get_year of emp_event.end_date = calendar_year
          or Date.get_year of emp_event.end_date = calendar_year - 1)
        # Exclude domestic service employment per paragraph (1) instruction
        and emp_event.employment_category != EmploymentCategory.DomesticService
    in
    # Full implementation: check for 10 days in different calendar weeks
    # with at least 1 individual employed on each day
    section_3306_has_ten_days_in_different_weeks of relevant_employment_events, calendar_year, 1
  consequence equals true
```

  - (2) Agricultural labor

    In the case of agricultural labor, the term "employer" means, with respect to any calendar year, any person who-

    - (A) during the calendar year or the preceding calendar year paid wages of $20,000 or more for agricultural labor, or



<!-- BLOCK_SPLIT: agricultural employer - wages threshold -->
<!-- LAW_REF: section_3306_a_2_A -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_a_2_A
```
```catala
scope OrganizationSection3306EmployerStatus:
  # LAW: 3306(a)(2)(A) - Agricultural employer: wages threshold
  # During the calendar year or the preceding calendar year paid wages of $20,000 or more for agricultural labor
  label section_3306_a_2_A_agricultural_wages_threshold
  definition is_agricultural_employer equals
    let relevant_wage_events equals
      list of wage_event among wage_payment_events such that
        wage_event.employer.id = organization.id
        and (Date.get_year of wage_event.payment_date = calendar_year
          or Date.get_year of wage_event.payment_date = calendar_year - 1)
        and exists emp_event among employment_relationship_events such that
          emp_event.employer.id = organization.id
          and emp_event.employee.id = wage_event.employee.id
          and emp_event.employment_category = EmploymentCategory.AgriculturalLabor
    in
    let total_agricultural_wages equals sum money of (map each wage_event among relevant_wage_events to wage_event.amount) in
    total_agricultural_wages >= $20,000
```

    - (B) on each of some 10 days during the calendar year or during the preceding calendar year, each day being in a different calendar week, employed at least 5 individuals in employment in agricultural labor for some portion of the day.

<!-- BLOCK_SPLIT: agricultural employer - 10 days with 5 individuals threshold -->
<!-- LAW_REF: section_3306_a_2_B -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_a_2_B
```
```catala
scope OrganizationSection3306EmployerStatus:
  # LAW: 3306(a)(2)(B) - Agricultural employer: 10 days with 5 individuals threshold
  # On each of some 10 days during the calendar year or during the preceding calendar year,
  # each day being in a different calendar week, employed at least 5 individuals in employment
  # in agricultural labor for some portion of the day
  label section_3306_a_2_B_agricultural_ten_days_threshold
  exception section_3306_a_2_A_agricultural_wages_threshold
  definition is_agricultural_employer under condition
    let relevant_employment_events equals
      list of emp_event among employment_relationship_events such that
        emp_event.employer.id = organization.id
        and emp_event.employment_category = EmploymentCategory.AgriculturalLabor
        and (Date.get_year of emp_event.start_date = calendar_year
          or Date.get_year of emp_event.start_date = calendar_year - 1
          or Date.get_year of emp_event.end_date = calendar_year
          or Date.get_year of emp_event.end_date = calendar_year - 1)
    in
    # Full implementation: check for 10 days in different calendar weeks
    # with at least 5 individuals employed in agricultural labor on each day
    section_3306_has_ten_days_in_different_weeks of relevant_employment_events, calendar_year, 5
  consequence equals true
```

  - (3) Domestic service

    In the case of domestic service in a private home, local college club, or local chapter of a college fraternity or sorority, the term "employer" means, with respect to any calendar year, any person who during the calendar year or the preceding calendar year paid wages in cash of $1,000 or more for such service.

<!-- BLOCK_SPLIT: domestic service employer -->
<!-- LAW_REF: section_3306_a_3 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_a_3
```
```catala
scope OrganizationSection3306EmployerStatus:
  # LAW: 3306(a)(3) - Domestic service employer
  # In the case of domestic service in a private home, local college club, or local chapter of a college
  # fraternity or sorority, the term "employer" means, with respect to any calendar year, any person who
  # during the calendar year or the preceding calendar year paid wages in cash of $1,000 or more for such service
  label section_3306_a_3_domestic_service_employer
  definition is_domestic_service_employer equals
    let relevant_wage_events equals
      list of wage_event among wage_payment_events such that
        wage_event.employer.id = organization.id
        and wage_event.payment_medium = PaymentMedium.Cash
        and (Date.get_year of wage_event.payment_date = calendar_year
          or Date.get_year of wage_event.payment_date = calendar_year - 1)
        and exists emp_event among employment_relationship_events such that
          emp_event.employer.id = organization.id
          and emp_event.employee.id = wage_event.employee.id
          and emp_event.employment_category = EmploymentCategory.DomesticService
    in
    let total_domestic_service_wages equals sum money of (map each wage_event among relevant_wage_events to wage_event.amount) in
    total_domestic_service_wages >= $1,000
```

  - (4) Special rule

    A person treated as an employer under paragraph (3) shall not be treated as an employer with respect to wages paid for any service other than domestic service referred to in paragraph (3) unless such person is treated as an employer under paragraph (1) or (2) with respect to such other service.

<!-- BLOCK_SPLIT: special rule for domestic service employer -->
<!-- LAW_REF: section_3306_a_4 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_a_4
```
```catala
scope OrganizationSection3306EmployerStatus:
  # LAW: 3306(a)(4) - Special rule
  # A person treated as an employer under paragraph (3) shall not be treated as an employer with respect
  # to wages paid for any service other than domestic service referred to in paragraph (3) unless such
  # person is treated as an employer under paragraph (1) or (2) with respect to such other service
  # This means: if is_domestic_service_employer is true, then is_employer should only be true if
  # is_general_employer or is_agricultural_employer is also true (for non-domestic service)
  # Note: This is handled in the final is_employer definition below
```

<!-- BLOCK_SPLIT: final employer determination -->
<!-- LAW_REF: section_3306_a -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_a
```
```catala
scope OrganizationSection3306EmployerStatus:
  # LAW: 3306(a) - Final employer determination
  # An organization is an employer if it meets any of the three categories:
  # (1) General employer (is_general_employer)
  # (2) Agricultural employer (is_agricultural_employer)
  # (3) Domestic service employer (is_domestic_service_employer)
  # Special rule (4): If only domestic service employer, it's still an employer
  # (but the special rule affects how it's treated for other services)
  label section_3306_a_final_employer
  definition is_employer equals
    is_general_employer
    or is_agricultural_employer
    or is_domestic_service_employer

  definition main_output equals
    OrganizationSection3306EmployerStatusOutput {
      -- organization: organization
      -- is_employer: is_employer
      -- is_general_employer: is_general_employer
      -- is_agricultural_employer: is_agricultural_employer
      -- is_domestic_service_employer: is_domestic_service_employer
    }
```

- (b) Wages

  For purposes of this chapter, the term "wages" means all remuneration for employment, including the cash value of all remuneration (including benefits) paid in any medium other than cash; except that such term shall not include-

  - (1) that part of the remuneration which, after remuneration (other than remuneration referred to in the succeeding paragraphs of this subsection) equal to $7,000 with respect to employment has been paid to an individual by an employer during any calendar year, is paid to such individual by such employer during such calendar year;

<!-- BLOCK_SPLIT: $7,000 cap calculation on list of wages -->
<!-- LAW_REF: section_3306_b_1 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_b_1
```
```catala
scope TotalWages3306Calculation:
  # LAW: 3306(b)(1) - Exclusion by $7,000 cap
  # That part of the remuneration which, after remuneration (other than remuneration referred to in
  # the succeeding paragraphs of this subsection) equal to $7,000 with respect to employment has been
  # paid to an individual by an employer during any calendar year, is paid to such individual by such
  # employer during such calendar year
  # 
  # This scope takes a list of wage results (from WagePaymentEventSection3306Wages) for the same
  # employer-employee relationship and applies the $7,000 cap sequentially.
  # The wage_results should be sorted by wage_payment_event.id to ensure proper sequential processing.
  label section_3306_b_1_total_wages_calculation
  definition total_taxable_wages equals
    # Sum all taxable amounts (before $7,000 cap) and cap at $7,000
    let total_before_cap equals
      sum money of (
        map each wage_result among wage_results to
          wage_result.taxable_amount_before_7000_cap
      )
    in
    if total_before_cap > $7,000 then
      $7,000
    else
      total_before_cap

  definition main_output equals
    TotalWages3306CalculationOutput {
      -- total_taxable_wages: total_taxable_wages
      -- wage_results_with_cap: wage_results
    }
```

  - (2) the amount of any payment (including any amount paid by an employer for insurance or annuities, or into a fund, to provide for any such payment) made to, or on behalf of, an employee or any of his dependents under a plan or system established by an employer which makes provision for his employees generally (or for his employees generally and their dependents) or for a class or classes of his employees (or for a class or classes of his employees and their dependents), on account of-

    - (A) sickness or accident disability, or

    - (C) death;

<!-- BLOCK_SPLIT: exclusion by sickness, accident disability, or death -->
<!-- LAW_REF: section_3306_b_2 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_b_2
```
```catala
scope WagePaymentEventSection3306Wages:
  # LAW: 3306(b)(2) - Exclusion by sickness, accident disability, or death
  # The amount of any payment (including any amount paid by an employer for insurance or annuities,
  # or into a fund, to provide for any such payment) made to, or on behalf of, an employee or any
  # of his dependents under a plan or system established by an employer which makes provision for
  # his employees generally (or for his employees generally and their dependents) or for a class or
  # classes of his employees (or for a class or classes of his employees and their dependents),
  # on account of (A) sickness or accident disability, or (C) death
  label section_3306_b_2_sickness_disability_death
  definition is_excluded_by_sickness_disability_death equals
    (wage_payment_event.payment_reason = PaymentReason.SicknessOrAccidentDisability
      or wage_payment_event.payment_reason = PaymentReason.Death)
    and wage_payment_event.is_under_plan_or_system
    and (wage_payment_event.is_for_employee_generally
      or wage_payment_event.is_for_class_of_employees)
```

  - (7) remuneration paid in any medium other than cash to an employee for service not in the course of the employer's trade or business;

<!-- BLOCK_SPLIT: exclusion by nonbusiness service -->
<!-- LAW_REF: section_3306_b_7 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_b_7
```
```catala
scope WagePaymentEventSection3306Wages:
  # LAW: 3306(b)(7) - Exclusion by nonbusiness service
  # Remuneration paid in any medium other than cash to an employee for service not in the course
  # of the employer's trade or business
  label section_3306_b_7_nonbusiness_service
  definition is_excluded_by_nonbusiness_service equals
    wage_payment_event.payment_medium = PaymentMedium.NonCash
    and wage_payment_event.is_not_in_course_of_trade_or_business
```

  - (10) any payment or series of payments by an employer to an employee or any of his dependents which is paid-

    - (A) upon or after the termination of an employee's employment relationship because of (i) death, or (ii) retirement for disability, and

    - (B) under a plan established by the employer which makes provision for his employees generally or a class or classes of his employees (or for such employees or class or classes of employees and their dependents),

      other than any such payment or series of payments which would have been paid if the employee's employment relationship had not been so terminated;

<!-- BLOCK_SPLIT: exclusion by termination payment -->
<!-- LAW_REF: section_3306_b_10 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_b_10
```
```catala
scope WagePaymentEventSection3306Wages:
  # LAW: 3306(b)(10) - Exclusion by termination payment
  # Any payment or series of payments by an employer to an employee or any of his dependents which is paid-
  # (A) upon or after the termination of an employee's employment relationship because of (i) death, or
  #     (ii) retirement for disability, and
  # (B) under a plan established by the employer which makes provision for his employees generally or
  #     a class or classes of his employees (or for such employees or class or classes of employees
  #     and their dependents),
  # other than any such payment or series of payments which would have been paid if the employee's
  # employment relationship had not been so terminated
  label section_3306_b_10_termination_payment
  definition is_excluded_by_termination_payment equals
    # First check: Payment must be a termination payment
    let is_termination_payment equals
      wage_payment_event.payment_reason = PaymentReason.TerminationAfterDeathOrDisabilityRetirement
    in
    # Condition (A): Payment is made upon or after termination due to death or disability retirement
    let termination_condition_A_met equals
      exists term_event among employment_termination_events such that
        term_event.employer.id = wage_payment_event.employer.id
        and term_event.employee.id = wage_payment_event.employee.id
        and (term_event.reason = TerminationReason.Death
          or term_event.reason = TerminationReason.DisabilityRetirement)
        and term_event.termination_date <= wage_payment_event.payment_date
    in
    # Condition (B): Payment is under a plan for employees generally or a class of employees
    # (or for such employees and their dependents)
    let plan_condition_B_met equals
      wage_payment_event.is_under_plan_or_system
      and (wage_payment_event.is_for_employee_generally
        or wage_payment_event.is_for_class_of_employees)
    in
    # Final determination: Payment is excluded if it's a termination payment AND (A) AND (B) are both met, 
    # AND payment would NOT have been paid without termination
    # Note: The law states "(A) ... and (B) ..." meaning both conditions must be satisfied
    (is_termination_payment
    and termination_condition_A_met
    and not wage_payment_event.would_have_been_paid_without_termination)
    and plan_condition_B_met
```

  - (11) remuneration for agricultural labor paid in any medium other than cash;

<!-- BLOCK_SPLIT: exclusion by agricultural noncash -->
<!-- LAW_REF: section_3306_b_11 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_b_11
```
```catala
scope WagePaymentEventSection3306Wages:
  # LAW: 3306(b)(11) - Exclusion by agricultural noncash
  # Remuneration for agricultural labor paid in any medium other than cash
  label section_3306_b_11_agricultural_noncash
  definition is_excluded_by_agricultural_noncash equals
    wage_payment_event.payment_medium = PaymentMedium.NonCash
    and wage_payment_event.payment_reason = PaymentReason.AgriculturalLaborNonCash
```

  - (15) any payment made by an employer to a survivor or the estate of a former employee after the calendar year in which such employee died;

<!-- BLOCK_SPLIT: exclusion by survivor payment -->
<!-- LAW_REF: section_3306_b_15 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_b_15
```
```catala
scope WagePaymentEventSection3306Wages:
  # LAW: 3306(b)(15) - Exclusion by survivor payment
  # Any payment made by an employer to a survivor or the estate of a former employee after the
  # calendar year in which such employee died
  label section_3306_b_15_survivor_payment
  definition is_excluded_by_survivor_payment equals
    # First check: Payment must be made to a survivor or the estate (not directly to the employee)
    let is_paid_to_survivor_or_estate equals
      wage_payment_event.is_paid_to_survivor_or_estate
    in
    # Second check: Employee must have died in a previous calendar year
    let payment_year equals Date.get_year of wage_payment_event.payment_date in
    let employee_local equals wage_payment_event.employee in
    let employee_died_in_previous_year equals
      exists death_event among death_events such that
        death_event.decedent.id = employee_local.id
        and Date.get_year of death_event.death_date < payment_year
    in
    # Final determination: Payment is excluded if it's paid to survivor/estate AND
    # the employee died in a previous calendar year
    is_paid_to_survivor_or_estate
    and employee_died_in_previous_year
```

<!-- BLOCK_SPLIT: final wages determination -->
<!-- LAW_REF: section_3306_b -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_b
```
```catala
scope WagePaymentEventSection3306Wages:
  # LAW: 3306(b) - Wages determination (excluding $7,000 cap)
  # The term "wages" means all remuneration for employment, including the cash value of all
  # remuneration (including benefits) paid in any medium other than cash; except that such term
  # shall not include the exclusions listed in paragraphs (2), (7), (10), (11), and (15)
  # Note: The $7,000 cap (paragraph 1) is handled separately by TotalWages3306Calculation scope
  label section_3306_b_final_wages
  definition taxable_amount_before_7000_cap equals
    # Calculate taxable amount after applying all exclusions EXCEPT the $7,000 cap
    # If excluded by other paragraphs, taxable amount is $0
    # Otherwise, use the full wage amount (the $7,000 cap will be applied later)
    if (is_excluded_by_sickness_disability_death
      or is_excluded_by_nonbusiness_service
      or is_excluded_by_termination_payment
      or is_excluded_by_agricultural_noncash
      or is_excluded_by_survivor_payment) then
      $0
    else
      wage_payment_event.amount

  definition main_output equals
    WagePaymentEventSection3306WagesOutput {
      -- wage_payment_event: wage_payment_event
      -- is_excluded_by_sickness_disability_death: is_excluded_by_sickness_disability_death
      -- is_excluded_by_nonbusiness_service: is_excluded_by_nonbusiness_service
      -- is_excluded_by_termination_payment: is_excluded_by_termination_payment
      -- is_excluded_by_agricultural_noncash: is_excluded_by_agricultural_noncash
      -- is_excluded_by_survivor_payment: is_excluded_by_survivor_payment
      -- taxable_amount_before_7000_cap: taxable_amount_before_7000_cap
    }
```

- (c) Employment

  For purposes of this chapter, the term "employment" means any service, of whatever nature,

  A) performed by an employee for the person employing him, irrespective of the citizenship or residence of either, within the United States, and

  B) performed outside the United States (except in a contiguous country with which the United States has an agreement relating to unemployment compensation) by a citizen of the United States as an employee of an American employer, except-

  - (1) agricultural labor unless-

    - (A) such labor is performed for a person who-

      - (i) during the calendar year or the preceding calendar year paid remuneration in cash of $20,000 or more to individuals employed in agricultural labor (including labor performed by an alien referred to in subparagraph (B)), or

      - (ii) on each of some 10 days during the calendar year or the preceding calendar year, each day being in a different calendar week, employed in agricultural labor (including labor performed by an alien referred to in subparagraph (B)) for some portion of the day (whether or not at the same moment of time) 5 or more individuals; and

    - (B) such labor is not agricultural labor performed by an individual who is an alien admitted to the United States to perform agricultural labor pursuant to sections 214(c) and 101(a)(15)(H) of the Immigration and Nationality Act.

<!-- BLOCK_SPLIT: exclusion of agricultural labor -->
<!-- LAW_REF: section_3306_c_1 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_c_1
```
```catala
scope EmploymentRelationshipEventSection3306Employment:
  # LAW: 3306(c)(1) - Exclusion of agricultural labor
  # Agricultural labor is excluded from employment unless:
  # (A) such labor is performed for a person who (i) paid $20,000+ in cash for agricultural labor, or
  #     (ii) on 10 days in different calendar weeks employed 5+ individuals in agricultural labor; and
  # (B) such labor is not performed by an alien admitted to perform agricultural labor under H-2A visa
  label section_3306_c_1_agricultural_labor
  definition is_excluded_agricultural_labor equals
    if employment_relationship_event.employment_category = EmploymentCategory.AgriculturalLabor then
      let employer_local equals employment_relationship_event.employer in
      # LAW: 3306(c)(1)(A) - Check if employer meets agricultural employer criteria from 3306(a)(2)
      # (A) such labor is performed for a person who:
      #   (i) during the calendar year or the preceding calendar year paid remuneration in cash of $20,000 or more
      #       to individuals employed in agricultural labor, or
      #   (ii) on each of some 10 days during the calendar year or the preceding calendar year, each day being
      #        in a different calendar week, employed in agricultural labor for some portion of the day
      #        (whether or not at the same moment of time) 5 or more individuals
      # This directly references the agricultural employer definition in 3306(a)(2)
      let employer_status equals
        (output of OrganizationSection3306EmployerStatus with {
          -- organization: employer_local
          -- calendar_year: calendar_year
          -- wage_payment_events: wage_payment_events
          -- employment_relationship_events: employment_relationship_events
        }).main_output
      in
      let employer_is_agricultural_employer equals employer_status.is_agricultural_employer in
      # LAW: 3306(c)(1)(B) - Check if labor is performed by H-2A alien
      # (B) such labor is not agricultural labor performed by an individual who is an alien admitted to the
      #     United States to perform agricultural labor pursuant to sections 214(c) and 101(a)(15)(H) of
      #     the Immigration and Nationality Act
      let is_h2a_alien equals
        exists iae among immigration_admission_events such that
          iae.individual.id = employment_relationship_event.employee.id
          and iae.visa_category = VisaCategory.H2A
      in
      # Agricultural labor is excluded UNLESS:
      # - (A) employer is an agricultural employer (per 3306(a)(2)), AND
      # - (B) labor is NOT performed by H-2A alien
      # So it's excluded if: NOT (employer_is_agricultural_employer AND NOT is_h2a_alien)
      # Which simplifies to: NOT employer_is_agricultural_employer OR is_h2a_alien
      not employer_is_agricultural_employer or is_h2a_alien
    else
      false
```

  - (2) domestic service in a private home, local college club, or local chapter of a college fraternity or sorority unless performed for a person who paid cash remuneration of $1,000 or more to individuals employed in such domestic service in the calendar year or the preceding calendar year;

<!-- BLOCK_SPLIT: exclusion of domestic service -->
<!-- LAW_REF: section_3306_c_2 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_c_2
```
```catala
scope EmploymentRelationshipEventSection3306Employment:
  # LAW: 3306(c)(2) - Exclusion of domestic service
  # Domestic service in a private home, local college club, or local chapter of a college fraternity
  # or sorority is excluded unless performed for a person who paid cash remuneration of $1,000 or more
  # to individuals employed in such domestic service in the calendar year or the preceding calendar year
  label section_3306_c_2_domestic_service
  definition is_excluded_domestic_service equals
    if employment_relationship_event.employment_category = EmploymentCategory.DomesticService then
      let employer_local equals employment_relationship_event.employer in
      # LAW: 3306(c)(2) - Domestic service is excluded unless performed for a person who
      # paid cash remuneration of $1,000 or more to individuals employed in such domestic service
      # in the calendar year or the preceding calendar year
      # This directly references the domestic service employer definition in 3306(a)(3)
      let employer_status equals
        (output of OrganizationSection3306EmployerStatus with {
          -- organization: employer_local
          -- calendar_year: calendar_year
          -- wage_payment_events: wage_payment_events
          -- employment_relationship_events: employment_relationship_events
        }).main_output
      in
      let employer_is_domestic_service_employer equals employer_status.is_domestic_service_employer in
      # Domestic service is excluded UNLESS employer is a domestic service employer
      not employer_is_domestic_service_employer
    else
      false
```

  - (5)

    - (A) service performed by an individual in the employ of his son, daughter, or spouse;

    - (B) service performed by a child under the age of 21 in the employ of his father or mother;

<!-- BLOCK_SPLIT: exclusion of family employment -->
<!-- LAW_REF: section_3306_c_5 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_c_5
```
```catala
scope EmploymentRelationshipEventSection3306Employment:
  # LAW: 3306(c)(5) - Exclusion of family employment
  # (A) service performed by an individual in the employ of his son, daughter, or spouse;
  # (B) service performed by a child under the age of 21 in the employ of his father or mother
  label section_3306_c_5_family_employment
  definition is_excluded_family_employment equals
    let employee_local equals employment_relationship_event.employee in
    let employer_local equals employment_relationship_event.employer in
    # Check (A): Employee is son, daughter, or spouse of employer
    # LAW: 3306(c)(5)(A) - service performed by an individual in the employ of his son, daughter, or spouse
    # This means: employee is parent (of son/daughter) OR employee is spouse (of employer)
    # So we check:
    # 1. Employee is parent, employer is child (son or daughter)
    # 2. Employee is spouse, employer is spouse
    let employee_is_parent_of_employer equals
      exists pe among parenthood_events such that
        pe.parent.id = employee_local.id
        and pe.child.id = employer_local.id
        and (pe.parent_type = ParentType.Biological or pe.parent_type = ParentType.Adoptive)
    in
    # Check if employee and employer are spouses
    let employee_is_spouse_of_employer equals
      exists me among marriage_events such that
        ((me.spouse1.id = employee_local.id and me.spouse2.id = employer_local.id)
          or (me.spouse2.id = employee_local.id and me.spouse1.id = employer_local.id))
        and me.marriage_date <= employment_relationship_event.end_date
    in
    let is_son_daughter_or_spouse equals employee_is_parent_of_employer or employee_is_spouse_of_employer
    in
    # Check (B): Employee is child under 21, employer is father or mother
    let is_child_under_21 equals
      exists pe among parenthood_events such that
        pe.parent.id = employer_local.id
        and pe.child.id = employee_local.id
        and (pe.parent_type = ParentType.Biological or pe.parent_type = ParentType.Adoptive)
        and exists be among birth_events such that
          be.individual.id = employee_local.id
          and Date.is_young_enough_rounding_down of be.birth_date, 21 year, (Date.of_year_month_day of calendar_year, 12, 31)
    in
    is_son_daughter_or_spouse or is_child_under_21
```

  - (6) service performed in the employ of the United States Government

<!-- BLOCK_SPLIT: exclusion of federal government service -->
<!-- LAW_REF: section_3306_c_6 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_c_6
```
```catala
scope EmploymentRelationshipEventSection3306Employment:
  # LAW: 3306(c)(6) - Exclusion of federal government service
  # Service performed in the employ of the United States Government
  label section_3306_c_6_federal_government
  definition is_excluded_federal_government equals
    employment_relationship_event.employment_category = EmploymentCategory.FederalGovernment
    or employment_relationship_event.employer.organization_type = OrganizationType.GovernmentFederal
```

  - (7) service performed in the employ of a State, or any political subdivision thereof.

<!-- BLOCK_SPLIT: exclusion of state government service -->
<!-- LAW_REF: section_3306_c_7 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_c_7
```
```catala
scope EmploymentRelationshipEventSection3306Employment:
  # LAW: 3306(c)(7) - Exclusion of state government service
  # Service performed in the employ of a State, or any political subdivision thereof
  label section_3306_c_7_state_government
  definition is_excluded_state_government equals
    employment_relationship_event.employment_category = EmploymentCategory.StateGovernment
    or employment_relationship_event.employer.organization_type = OrganizationType.GovernmentState
```

  - (10)

    - (A) service performed in the employ of a school, college, or university, if such service is performed

      - (i) by a student who is enrolled and is regularly attending classes at such school, college, or university, or

      - (ii) by the spouse of such a student, or

    - (B) service performed in the employ of a hospital, if such service is performed by a patient of such hospital;

<!-- BLOCK_SPLIT: exclusion of student service and hospital patient service -->
<!-- LAW_REF: section_3306_c_10 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_c_10
```
```catala
scope EmploymentRelationshipEventSection3306Employment:
  # LAW: 3306(c)(10) - Exclusion of student service and hospital patient service
  # (A) service performed in the employ of a school, college, or university, if such service is performed
  #     (i) by a student who is enrolled and is regularly attending classes at such school, college, or university, or
  #     (ii) by the spouse of such a student, or
  # (B) service performed in the employ of a hospital, if such service is performed by a patient of such hospital
  label section_3306_c_10_student_hospital
  definition is_excluded_student_service equals
    employment_relationship_event.employment_category = EmploymentCategory.SchoolCollegeUniversity
    and (
      # Check (A)(i): Employee is a student enrolled and regularly attending classes
      (exists se among student_enrollment_events such that
        se.student.id = employment_relationship_event.employee.id
        and se.institution.id = employment_relationship_event.employer.id
        and se.is_regularly_attending
        and se.start_date <= Date.of_year_month_day of calendar_year, 12, 31
        and se.end_date >= Date.of_year_month_day of calendar_year, 1, 1)
      # Check (A)(ii): Employee is the spouse of a student enrolled and regularly attending classes
      or (exists se among student_enrollment_events such that
        se.institution.id = employment_relationship_event.employer.id
        and se.is_regularly_attending
        and se.start_date <= Date.of_year_month_day of calendar_year, 12, 31
        and se.end_date >= Date.of_year_month_day of calendar_year, 1, 1
        and exists me among marriage_events such that
          ((me.spouse1.id = se.student.id and me.spouse2.id = employment_relationship_event.employee.id)
            or (me.spouse2.id = se.student.id and me.spouse1.id = employment_relationship_event.employee.id))
          and me.marriage_date <= employment_relationship_event.end_date)
    )

  definition is_excluded_hospital_patient_service equals
    employment_relationship_event.employment_category = EmploymentCategory.Hospital
    and exists hpe among hospital_patient_events such that
      hpe.patient.id = employment_relationship_event.employee.id
      and hpe.hospital.id = employment_relationship_event.employer.id
      and hpe.start_date <= Date.of_year_month_day of calendar_year, 12, 31
      and hpe.end_date >= Date.of_year_month_day of calendar_year, 1, 1
```

  - (11) service performed in the employ of a foreign government (including service as a consular or other officer or employee or a nondiplomatic representative);

<!-- BLOCK_SPLIT: exclusion of foreign government service -->
<!-- LAW_REF: section_3306_c_11 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_c_11
```
```catala
scope EmploymentRelationshipEventSection3306Employment:
  # LAW: 3306(c)(11) - Exclusion of foreign government service
  # Service performed in the employ of a foreign government (including service as a consular or
  # other officer or employee or a nondiplomatic representative)
  label section_3306_c_11_foreign_government
  definition is_excluded_foreign_government equals
    employment_relationship_event.employment_category = EmploymentCategory.ForeignGovernment
    or employment_relationship_event.employer.organization_type = OrganizationType.ForeignGovernment
```

  - (13) service performed as a student nurse in the employ of a hospital or a nurses' training school by an individual who is enrolled and is regularly attending classes in a nurses' training school;

<!-- BLOCK_SPLIT: exclusion of student nurse service -->
<!-- LAW_REF: section_3306_c_13 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_c_13
```
```catala
scope EmploymentRelationshipEventSection3306Employment:
  # LAW: 3306(c)(13) - Exclusion of student nurse service
  # Service performed as a student nurse in the employ of a hospital or a nurses' training school
  # by an individual who is enrolled and is regularly attending classes in a nurses' training school
  label section_3306_c_13_student_nurse
  definition is_excluded_student_nurse equals
    (employment_relationship_event.employment_category = EmploymentCategory.Hospital
      or employment_relationship_event.employment_category = EmploymentCategory.SchoolCollegeUniversity)
    and exists se among student_enrollment_events such that
      se.student.id = employment_relationship_event.employee.id
      and se.is_regularly_attending
      and se.start_date <= Date.of_year_month_day of calendar_year, 12, 31
      and se.end_date >= Date.of_year_month_day of calendar_year, 1, 1
```

  - (16) service performed in the employ of an international organization;

<!-- BLOCK_SPLIT: exclusion of international organization service -->
<!-- LAW_REF: section_3306_c_16 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_c_16
```
```catala
scope EmploymentRelationshipEventSection3306Employment:
  # LAW: 3306(c)(16) - Exclusion of international organization service
  # Service performed in the employ of an international organization
  label section_3306_c_16_international_organization
  definition is_excluded_international_organization equals
    employment_relationship_event.employment_category = EmploymentCategory.InternationalOrganization
    or employment_relationship_event.employer.organization_type = OrganizationType.InternationalOrganization
```

  - (21) service performed by a person committed to a penal institution.

<!-- BLOCK_SPLIT: exclusion of penal institution service -->
<!-- LAW_REF: section_3306_c_21 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_c_21
```
```catala
scope EmploymentRelationshipEventSection3306Employment:
  # LAW: 3306(c)(21) - Exclusion of penal institution service
  # Service performed by a person committed to a penal institution
  label section_3306_c_21_penal_institution
  definition is_excluded_penal_institution equals
    employment_relationship_event.employment_category = EmploymentCategory.PenalInstitution
    or employment_relationship_event.employer.organization_type = OrganizationType.PenalInstitution
```

<!-- BLOCK_SPLIT: final employment determination -->
<!-- LAW_REF: section_3306_c -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3306_c
```
```catala
scope EmploymentRelationshipEventSection3306Employment:
  # LAW: 3306(c) - Final employment determination
  # The term "employment" means any service, of whatever nature,
  # A) performed by an employee for the person employing him, irrespective of the citizenship or
  #    residence of either, within the United States, and
  # B) performed outside the United States (except in a contiguous country with which the United States
  #    has an agreement relating to unemployment compensation) by a citizen of the United States as an
  #    employee of an American employer, except the exclusions listed in paragraphs (1), (2), (5), (6),
  #    (7), (10), (11), (13), (16), and (21)
  label section_3306_c_final_employment
  definition is_employment equals
    # Check if service is within US or outside US by US citizen for American employer
    let is_within_us equals
      employment_relationship_event.service_location = ServiceLocation.WithinUnitedStates
    in
    let is_outside_us_by_us_citizen equals
      employment_relationship_event.service_location = ServiceLocation.OutsideUnitedStates
      and employment_relationship_event.employee_is_us_citizen
      and employment_relationship_event.is_american_employer
    in
    # Service qualifies if within US OR outside US by US citizen for American employer
    (is_within_us or is_outside_us_by_us_citizen)
    # AND not excluded by any of the exclusion paragraphs
    and not is_excluded_agricultural_labor
    and not is_excluded_domestic_service
    and not is_excluded_family_employment
    and not is_excluded_federal_government
    and not is_excluded_state_government
    and not is_excluded_student_service
    and not is_excluded_hospital_patient_service
    and not is_excluded_foreign_government
    and not is_excluded_student_nurse
    and not is_excluded_international_organization
    and not is_excluded_penal_institution

  definition main_output equals
    EmploymentRelationshipEventSection3306EmploymentOutput {
      -- employment_relationship_event: employment_relationship_event
      -- is_employment: is_employment
      -- is_excluded_agricultural_labor: is_excluded_agricultural_labor
      -- is_excluded_domestic_service: is_excluded_domestic_service
      -- is_excluded_family_employment: is_excluded_family_employment
      -- is_excluded_federal_government: is_excluded_federal_government
      -- is_excluded_state_government: is_excluded_state_government
      -- is_excluded_student_service: is_excluded_student_service
      -- is_excluded_hospital_patient_service: is_excluded_hospital_patient_service
      -- is_excluded_foreign_government: is_excluded_foreign_government
      -- is_excluded_student_nurse: is_excluded_student_nurse
      -- is_excluded_international_organization: is_excluded_international_organization
      -- is_excluded_penal_institution: is_excluded_penal_institution
    }
```

```catala
scope IRCSimplified:
  # Section 3301 - Employer unemployment excise tax subscope mappings
  definition employer_unemployment_excise_tax.employer_unemployment_excise_tax_return equals
    employer_unemployment_excise_tax_return
  definition employer_unemployment_excise_tax.wage_payment_wages_results equals
    wage_payment_wages_results
  definition employer_unemployment_excise_tax.organization_employer_statuses equals
    organization_employer_statuses
  definition employer_unemployment_excise_tax.employment_relationship_employment_results equals
    employment_relationship_employment_results
  # Define the context output to equal the subscope's main_output
  definition employer_unemployment_excise_tax_result equals
    employer_unemployment_excise_tax.main_output

```

<!-- BLOCK_SPLIT: Section 3301 - Rate of tax -->
<!-- LAW_REF: section_3301 -->
<!-- catala-code -->
```yaml
type: catala-code
law_ref: section_3301
```
```catala
scope EmployerUnemploymentExciseTaxFilerSection3301Tax:
  # LAW: 3301 - Rate of tax
  # There is hereby imposed on every employer (as defined in section 3306(a)) for each calendar year
  # an excise tax, with respect to having individuals in his employ, equal to 6 percent of the total
  # wages (as defined in section 3306(b)) paid by such employer during the calendar year with respect
  # to employment (as defined in section 3306(c)).
  label section_3301_rate_of_tax
  definition tax_rate equals 6.0%
  
  label section_3301_total_taxable_wages
  definition total_taxable_wages equals
    # Extract the employer from the tax return
    let employer_local equals
      match employer_unemployment_excise_tax_return.details with pattern
        -- GeneralEmployer content variant: variant.employer
        -- AgriculturalEmployer content variant: variant.employer
        -- DomesticServiceEmployer content variant: variant.employer
    in
    # Get all wages for this employer from wage_payment_wages_results
    let wages_for_employer equals
      list of wage_result among wage_payment_wages_results such that
        wage_result.wage_payment_event.employer.id = employer_local.id
        and Date.get_year of wage_result.wage_payment_event.payment_date = employer_unemployment_excise_tax_return.tax_year
    in
    # Filter wages to only those that are for employment
    # A wage is for employment if there exists an employment relationship event that:
    # 1. Has the same employer and employee
    # 2. Payment date is on or after the employment start date
    # 3. Employment relationship overlaps with the tax year (start_date or end_date is in the tax year)
    # 4. Is employment (not excluded)
    # Note: We don't check if payment is before end_date because wages may be paid after employment ends
    # (e.g., final paycheck, severance, bonuses) but are still "with respect to employment"
    let wages_for_employment equals
      list of wage_result among wages_for_employer such that
        exists emp_result among employment_relationship_employment_results such that
          emp_result.employment_relationship_event.employer.id = wage_result.wage_payment_event.employer.id
          and emp_result.employment_relationship_event.employee.id = wage_result.wage_payment_event.employee.id
          and emp_result.employment_relationship_event.start_date <= wage_result.wage_payment_event.payment_date
          and (
            Date.get_year of emp_result.employment_relationship_event.start_date = employer_unemployment_excise_tax_return.tax_year
            or Date.get_year of emp_result.employment_relationship_event.end_date = employer_unemployment_excise_tax_return.tax_year
          )
          and emp_result.is_employment
    in
    # Group wages by employee and calculate total taxable wages
    # Since all wages are already filtered to the same employer and year, we just need to group by employee
    # For each unique employee, get their wages and call TotalWages3306Calculation
    # Get unique employees by finding the first wage result for each employee.id
    # For each wage result, check if it's the first occurrence of that employee.id
    let unique_employee_wage_results equals
      list of wage_result among wages_for_employment such that
        not exists prev_wage_result among wages_for_employment such that
          prev_wage_result.wage_payment_event.employee.id = wage_result.wage_payment_event.employee.id
          and prev_wage_result.wage_payment_event.id < wage_result.wage_payment_event.id
    in
    let unique_employee_ids equals
      map each wage_result among unique_employee_wage_results to wage_result.wage_payment_event.employee.id
    in
    # For each unique employee, get their wages and calculate total taxable wages
    sum money of (
      map each emp_id_local among unique_employee_ids to
        let employee_wages equals
          list of wage_result among wages_for_employment such that
            wage_result.wage_payment_event.employee.id = emp_id_local
        in
        # Call TotalWages3306Calculation for this employee's wages
        ((output of TotalWages3306Calculation with {
          -- wage_results: employee_wages
        }).main_output).total_taxable_wages
    )

  exception section_3301_total_taxable_wages
  definition total_taxable_wages under condition
    # Extract the employer from the tax return
    let employer_local equals
      match employer_unemployment_excise_tax_return.details with pattern
        -- GeneralEmployer content variant: variant.employer
        -- AgriculturalEmployer content variant: variant.employer
        -- DomesticServiceEmployer content variant: variant.employer
    in
    # Check if this organization is an employer
    not exists org_status among organization_employer_statuses such that
      org_status.organization.id = employer_local.id
      and org_status.is_employer
  consequence equals $0

  definition excise_tax equals
    # Tax = 6% of total taxable wages
    total_taxable_wages * tax_rate

  definition main_output equals
    EmployerUnemploymentExciseTaxFilerSection3301TaxOutput {
      -- employer_unemployment_excise_tax_return: employer_unemployment_excise_tax_return
      -- total_taxable_wages: total_taxable_wages
      -- excise_tax: excise_tax
      -- tax_rate: tax_rate
    }
```